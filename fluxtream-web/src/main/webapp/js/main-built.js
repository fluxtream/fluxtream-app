/*!
 * jQuery Form Plugin
 * version: 2.87 (20-OCT-2011)
 * @requires jQuery v1.3.2 or later
 *
 * Examples and documentation at: http://malsup.com/jquery/form/
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */

/*
* qTip2 - Pretty powerful tooltips
* http://craigsworks.com/projects/qtip2/
*
* Version: nightly
* Copyright 2009-2010 Craig Michael Thompson - http://craigsworks.com
*
* Dual licensed under MIT or GPLv2 licenses
*   http://en.wikipedia.org/wiki/MIT_License
*   http://en.wikipedia.org/wiki/GNU_General_Public_License
*
* Date: Sat Mar  3 09:04:15.0000000000 2012
*/

/*
 RequireJS text 1.0.7 Copyright (c) 2010-2011, The Dojo Foundation All Rights Reserved.
 Available via the MIT or new BSD license.
 see: http://github.com/jrburke/requirejs for details
*/

/* =========================================================
 * bootstrap-datepicker.js 
 * http://www.eyecon.ro/bootstrap-datepicker
 * =========================================================
 * Copyright 2012 Stefan Petre
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * ========================================================= */

define("core/FlxState",[],function(){function store(appName,urlState){typeof storage[appName]=="undefined"&&(storage[appName]={}),storage[appName].state=urlState}function restore(appName){return typeof storage[appName]=="undefined"?null:storage[appName].state}function storeTab(tabName,tabState){typeof tabStateStorage[tabName]=="undefined"&&(tabStateStorage[tabName]={}),tabStateStorage[tabName].state=tabState}function restoreTab(tabName){return typeof tabStateStorage[tabName]=="undefined"?null:tabStateStorage[tabName].state}var storage={},tabStateStorage={},state={};return state.saveState=store,state.getState=restore,state.saveTabState=storeTab,state.getTabState=restoreTab,state.router=new Backbone.Router,state.apps=["calendar"],state.defaultApp="calendar",state}),define("Addresses",[],function(){function buildDialog(){App.loadMustacheTemplate("addressesTemplate.html","addressesDialog",function(template){App.makeModal(template.render({addresses:addresses.map(function(address){return getAddressParams(address)})})),$("#addAddress").click(addAddressDialog);for(var i=0;i<addresses.length;i++)$("#delete-"+i).click({index:i},function(event){confirmDelete(event.data.index)}),$("#edit-"+i).click({index:i},function(event){updateAddressDialog(event.data.index)})})}function getAddressParams(address){var params={address:address.address,type:address.type,index:address.index,since:App.formatDate(address.since),until:App.formatDate(address.until),radius:address.radius+" m"};return params}function confirmDelete(index){App.closeModal(),$("#modal").on("hidden",function(){App.loadMustacheTemplate("addressesTemplate.html","deleteAddressConfirm",function(tamplate){App.makeModal(tamplate.render({address:addresses[index].address}));var confirmDelete=$("#confirmDeleteBtn");confirmDelete.click(function(){$.ajax("/api/addresses/"+index,{type:"DELETE",success:App.closeModal,error:App.closeModal})}),$("#modal").on("hidden",show)})})}function addressDialogInitializer(html){App.makeModal(html);var addressInput=$("#addressInput"),addressSearch=$("#addressSearch"),addressSelect=$("#addressSelect"),sinceInput=$("#sinceInput"),untilInput=$("#untilInput"),presentCheckbox=$("#presentCheckBox"),addressTypeSelect=$("#addressTypeSelect"),saveAddressBtn=$("#saveAddressBtn"),radiusInput=$("#radiusInput");sinceInput.datepicker().on("changeDate",function(){sinceInput.datepicker("hide"),sinceInput.blur(),sinceInput.parent().parent().removeClass("error")}),untilInput.datepicker().on("changeDate",function(){untilInput.datepicker("hide"),untilInput.blur(),untilInput.parent().parent().removeClass("error")}),radiusInput.change(function(){radiusInput.parent().parent().removeClass("error")}),presentCheckbox.change(function(){presentCheckbox.is(":checked")?(untilInput.val(""),untilInput.attr("disabled","disabled")):untilInput.removeAttr("disabled"),untilInput.parent().parent().removeClass("error")}),addressInput.keyup(function(event){if(event.keyCode==13)addressSearch.click();else{var options=addressSelect.children();for(var i=1;i<options.length;i++)$(options[i]).remove();currentAddressPool=[]}}),addressSearch.click(function(){var addr=addressInput.val();addressSelect.attr("disabled","disabled"),addressSearch.attr("disabled","disabled"),addressInput.attr("disabled","disabled"),App.geocoder.geocode({address:addr},function(results,status){var options=addressSelect.children();for(var i=1;i<options.length;i++)$(options[i]).remove();if(status==google.maps.GeocoderStatus.OK){for(var i=0;i<results.length;i++)addressSelect.append("<option>"+results[i].formatted_address+"</option>");currentAddressPool=results;for(var i=0;i<currentAddressPool.length;i++)currentAddressPool[i].formatted_address==addressInput.val()&&(addressSelect[0].selectedIndex=i+1)}else currentAddressPool=[];addressSelect.removeAttr("disabled"),addressSearch.removeAttr("disabled"),addressInput.removeAttr("disabled")})}),addressSelect.change(function(){addressSelect[0].selectedIndex!=0&&addressSelect.parent().parent().removeClass("error")}),$("#modal").on("hidden",show)}function updateAddressDialog(index){var originalSince=App.formatDateAsDatePicker(addresses[index].since),originalUntil=App.formatDateAsDatePicker(addresses[index].until);App.closeModal(),$("#modal").on("hidden",function(){App.loadMustacheTemplate("addressesTemplate.html","addAddress",function(template){addressDialogInitializer(template.render({title:"Edit Address",sinceDate:originalSince,untilDate:originalUntil=="Present"?"":originalUntil,distanceUnit:"m"}),originalSince,originalUntil);var addressInput=$("#addressInput"),addressSearch=$("#addressSearch"),addressSelect=$("#addressSelect"),sinceInput=$("#sinceInput"),untilInput=$("#untilInput"),presentCheckbox=$("#presentCheckBox"),addressTypeSelect=$("#addressTypeSelect"),saveAddressBtn=$("#saveAddressBtn"),radiusInput=$("#radiusInput");radiusInput.val(addresses[index].radius),addressInput.val(addresses[index].address),addressSearch.click(),originalUntil=="Present"&&presentCheckbox.click();var typeIndex=0;for(var i=1;i<typeNames.length;i++)typeNames[i]==addresses[index].type&&(typeIndex=i);addressTypeSelect[0].selectedIndex=typeIndex,saveAddressBtn.click(function(){var selection=addressSelect[0].selectedIndex-1,errors=!1;selection==-1&&(addressSelect.parent().parent().addClass("error"),errors=!0),sinceInput.val()==""&&(sinceInput.parent().parent().addClass("error"),errors=!0),untilInput.val()==""&&!presentCheckbox.is(":checked")&&(untilInput.parent().parent().addClass("error"),errors=!0),radiusInput.val()==""&&(radiusInput.parent().parent().addClass("error"),errors=!0);if(errors)return;addressInput.attr("disabled","disabled"),addressSearch.attr("disabled","disabled"),addressSelect.attr("disabled","disabled"),sinceInput.attr("disabled","disabled"),untilInput.attr("disabled","disabled"),presentCheckbox.attr("disabled","disabled"),addressTypeSelect.attr("disabled","disabled"),saveAddressBtn.attr("disabled","disabled"),radiusInput.attr("disabled","disabled");var address=currentAddressPool[selection],params={},hasParams=!1;address.formatted_address!=addresses[index].address&&(params.address=address.formatted_address,params.latitude=address.geometry.location.lat(),params.longitude=address.geometry.location.lng(),hasParams=!0),originalSince!=sinceInput.val()&&(params.since=sinceInput.val(),hasParams=!0),presentCheckbox.is(":Checked")?originalUntil!="Present"&&(params.until="Present",hasParams=!0):originalUntil!=untilInput.val()&&(params.until=untilInput.val(),hasParams=!0),addresses[index].type!=typeNames[addressTypeSelect[0].selectedIndex]&&(params.type=typeNames[addressTypeSelect[0].selectedIndex],hasParams=!0),addresses[index].radius!=radiusInput.val()&&(params.radius=radiusInput.val(),hasParams=!0),hasParams?$.ajax("/api/addresses/"+index,{type:"POST",data:params,success:function(data,textStatus,jqXHR){data.result=="OK"?App.closeModal():this.error()},error:function(){$(".modal-body").append('<div class="alert alert-error"><button class="close" data-dismiss="alert">×</button><strong>Error!</strong> Failed to add address!</div>'),addressInput.removeAttr("disabled"),addressSearch.removeAttr("disabled"),addressSelect.removeAttr("disabled"),sinceInput.removeAttr("disabled"),presentCheckbox.is(":Checked")||untilInput.removeAttr("disabled"),presentCheckbox.removeAttr("disabled"),addressTypeSelect.removeAttr("disabled"),saveAddressBtn.removeAttr("disabled"),radiusInput.removeAttr("disabled")}}):App.closeModal()})})})}function addAddressDialog(){App.closeModal(),$("#modal").on("hidden",function(){App.loadMustacheTemplate("addressesTemplate.html","addAddress",function(template){addressDialogInitializer(template.render({title:"Add Address",sinceDate:App.formatDateAsDatePicker(new Date),untilDate:App.formatDateAsDatePicker(new Date),distanceUnit:"m"}));var addressInput=$("#addressInput"),addressSearch=$("#addressSearch"),addressSelect=$("#addressSelect"),sinceInput=$("#sinceInput"),untilInput=$("#untilInput"),presentCheckbox=$("#presentCheckBox"),addressTypeSelect=$("#addressTypeSelect"),saveAddressBtn=$("#saveAddressBtn"),radiusInput=$("#radiusInput");sinceInput.val(""),untilInput.val(""),currentAddressPool=[],saveAddressBtn.click(function(){var selection=addressSelect[0].selectedIndex-1,errors=!1;selection==-1&&(addressSelect.parent().parent().addClass("error"),errors=!0),sinceInput.val()==""&&(sinceInput.parent().parent().addClass("error"),errors=!0),untilInput.val()==""&&!presentCheckbox.is(":checked")&&(untilInput.parent().parent().addClass("error"),errors=!0),radiusInput.val()==""&&(radiusInput.parent().parent().addClass("error"),errors=!0);if(errors)return;addressInput.attr("disabled","disabled"),addressSearch.attr("disabled","disabled"),addressSelect.attr("disabled","disabled"),sinceInput.attr("disabled","disabled"),untilInput.attr("disabled","disabled"),presentCheckbox.attr("disabled","disabled"),addressTypeSelect.attr("disabled","disabled"),saveAddressBtn.attr("disabled","disabled"),radiusInput.attr("disabled","disabled");var address=currentAddressPool[selection],params={address:address.formatted_address,latitude:address.geometry.location.lat(),longitude:address.geometry.location.lng(),since:sinceInput.val(),radius:radiusInput.val()};presentCheckbox.is(":checked")||(params.until=untilInput.val()),$.ajax("/api/addresses/"+typeNames[addressTypeSelect[0].selectedIndex],{type:"POST",data:params,success:function(data,textStatus,jqXHR){data.result=="OK"?App.closeModal():this.error()},error:function(){$(".modal-body").append('<div class="alert alert-error"><button class="close" data-dismiss="alert">×</button><strong>Error!</strong> Failed to add address!</div>'),addressInput.removeAttr("disabled"),addressSearch.removeAttr("disabled"),addressSelect.removeAttr("disabled"),sinceInput.removeAttr("disabled"),presentCheckbox.is(":Checked")||untilInput.removeAttr("disabled"),presentCheckbox.removeAttr("disabled"),addressTypeSelect.removeAttr("disabled"),saveAddressBtn.removeAttr("disabled"),radiusInput.removeAttr("disabled")}})})})})}function show(){$.ajax("/api/addresses",{success:function(data,textStatus,jqXHR){dataLoaded(data)}})}function dataLoaded(data){addresses=data;for(var i=0;i<addresses.length;i++)addresses[i].index=i,addresses[i].since+=432e5,addresses[i].until-=432e5;buildDialog()}var addresses,typeNames=["ADDRESS_OTHER","ADDRESS_HOME","ADDRESS_WORK"],currentAddressPool=[],Addresses={};return Addresses.show=show,Addresses}),define("ManageConnectors",[],function(){function show(){$.ajax("/api/connectors/installed",{success:function(data,textStatus,jqXHR){dataLoaded(data,!1)}})}function updateContents(){$.ajax("/api/connectors/installed",{success:function(data,textStatus,jqXHR){if(hidden)return;dataLoaded(data,!0)}})}function dataLoaded(data,update){connectors=data,App.loadMustacheTemplate("connectorMgmtTemplates.html","manageConnectors",function(template){var params=[];for(var i=0;i<data.length;i++){params[i]={};for(var member in data[i])switch(member){default:params[i][member]=data[i][member];break;case"latestData":case"lastSync":var formatted=App.formatDate(data[i][member],!0);formatted=="Present"&&(formatted=member=="lastSync"?"Never":"No Data"),params[i][member]=formatted}}var html=template.render({connectors:params});if(update){var scrollTop=$(".modal-body").scrollTop();$("#modal").html($(html).html()),$(".modal-body").scrollTop(scrollTop)}else App.makeModal(html);bindDialog()})}function bindDialog(){hidden=!1;for(var i=0;i<connectors.length;i++)bindConnector(connectors[i],i);var syncAllBtn=$("#sync-all");syncAllBtn.click(function(){setAllToSyncing(),event.preventDefault(),$.ajax("/api/connectors/sync",{type:"POST"})}),$.doTimeout("manageConnectorsUpdater",1e4,function(){return updateContents(),!0}),$("#modal").on("hide",function(){hidden=!0,$.doTimeout("manageConnectorsUpdater")})}function bindConnector(connector,i){var deleteBtn=$("#remove-"+connector.connectorName);deleteBtn.click({index:i},function(event){event.preventDefault(),confirmDelete(event.data.index)});var syncNowBtn=$("#syncNow-"+connector.connectorName);syncNowBtn.click(function(event){event.preventDefault(),setToSyncing(connector.connectorName),$.ajax("/api/connectors/"+connector.connectorName+"/sync",{type:"POST"})})}function setToSyncing(connectorName){var row=$("#connector-"+connectorName);if(row.hasClass("nowSynchro"))return;row.addClass("nowSynchro");var syncLED=$("#syncLED-"+connectorName);syncLED.removeClass("syncLED-yes"),syncLED.removeClass("syncLED-no"),syncLED.addClass("syncLED-waiting"),syncLED.html('<span class="syncLED-waiting"><img src="/css/devicesPictures/load.gif" alt="load"></span>');var lastSync=$("#lastSync-"+connectorName);lastSync.html("Now synchronizing");var syncNowBtn=$("#syncNow-"+connectorName),disabledBtn=$("<span>"+syncNowBtn.html()+"</span>");syncNowBtn.replaceWith(disabledBtn)}function setAllToSyncing(){for(var i=0;i<connectors.length;i++)setToSyncing(connectors[i].connectorName)}function confirmDelete(index){App.closeModal(),$("#modal").on("hidden",function(){App.loadMustacheTemplate("connectorMgmtTemplates.html","deleteConnectorConfirm",function(template){App.makeModal(template.render(connectors[index]));var confirmDelete=$("#confirmDeleteBtn");confirmDelete.click(function(){$.ajax("/api/connectors/"+connectors[index].connectorName,{type:"DELETE",success:App.closeModal,error:App.closeModal})}),$("#modal").on("hidden",show)})})}var connectors,hidden,ManageConnectors={};return ManageConnectors.show=show,ManageConnectors}),define("AddConnectors",[],function(){function show(){$.ajax("/api/connectors/uninstalled",{success:function(data,textStatus,jqXHR){var rows=[],row={connectors:[]};for(var i=0;i<data.length;i++)i%3==0&&(row={connectors:[]},rows.push(row)),row.connectors.push(data[i]);dataLoaded({rows:rows})}})}function dataLoaded(data){App.loadMustacheTemplate("connectorMgmtTemplates.html","addConnectors",function(template){var html=template.render(data);App.makeModal(html),bindDialog()})}function bindDialog(){}var AddConnectors={};return AddConnectors.show=show,AddConnectors}),function($){function log(){if(!$.fn.ajaxSubmit.debug)return;var msg="[jquery.form] "+Array.prototype.join.call(arguments,"");window.console&&window.console.log?window.console.log(msg):window.opera&&window.opera.postError&&window.opera.postError(msg)}$.fn.ajaxSubmit=function(options){function fileUpload(a){function getDoc(frame){var doc=frame.contentWindow?frame.contentWindow.document:frame.contentDocument?frame.contentDocument:frame.document;return doc}function doSubmit(){function checkState(){try{var state=getDoc(io).readyState;log("state = "+state),state.toLowerCase()=="uninitialized"&&setTimeout(checkState,50)}catch(e){log("Server abort: ",e," (",e.name,")"),cb(SERVER_ABORT),timeoutHandle&&clearTimeout(timeoutHandle),timeoutHandle=undefined}}var t=$form.attr("target"),a=$form.attr("action");form.setAttribute("target",id),method||form.setAttribute("method","POST"),a!=s.url&&form.setAttribute("action",s.url),!s.skipEncodingOverride&&(!method||/post/i.test(method))&&$form.attr({encoding:"multipart/form-data",enctype:"multipart/form-data"}),s.timeout&&(timeoutHandle=setTimeout(function(){timedOut=!0,cb(CLIENT_TIMEOUT_ABORT)},s.timeout));var extraInputs=[];try{if(s.extraData)for(var n in s.extraData)extraInputs.push($('<input type="hidden" name="'+n+'" />').attr("value",s.extraData[n]).appendTo(form)[0]);s.iframeTarget||($io.appendTo("body"),io.attachEvent?io.attachEvent("onload",cb):io.addEventListener("load",cb,!1)),setTimeout(checkState,15),form.submit()}finally{form.setAttribute("action",a),t?form.setAttribute("target",t):$form.removeAttr("target"),$(extraInputs).remove()}}function cb(e){if(xhr.aborted||callbackProcessed)return;try{doc=getDoc(io)}catch(ex){log("cannot access response document: ",ex),e=SERVER_ABORT}if(e===CLIENT_TIMEOUT_ABORT&&xhr){xhr.abort("timeout");return}if(e==SERVER_ABORT&&xhr){xhr.abort("server abort");return}if(!doc||doc.location.href==s.iframeSrc)if(!timedOut)return;io.detachEvent?io.detachEvent("onload",cb):io.removeEventListener("load",cb,!1);var status="success",errMsg;try{if(timedOut)throw"timeout";var isXml=s.dataType=="xml"||doc.XMLDocument||$.isXMLDoc(doc);log("isXml="+isXml);if(!isXml&&window.opera&&(doc.body==null||doc.body.innerHTML=="")&&--domCheckCount){log("requeing onLoad callback, DOM not available"),setTimeout(cb,250);return}var docRoot=doc.body?doc.body:doc.documentElement;xhr.responseText=docRoot?docRoot.innerHTML:null,xhr.responseXML=doc.XMLDocument?doc.XMLDocument:doc,isXml&&(s.dataType="xml"),xhr.getResponseHeader=function(header){var headers={"content-type":s.dataType};return headers[header]},docRoot&&(xhr.status=Number(docRoot.getAttribute("status"))||xhr.status,xhr.statusText=docRoot.getAttribute("statusText")||xhr.statusText);var dt=(s.dataType||"").toLowerCase(),scr=/(json|script|text)/.test(dt);if(scr||s.textarea){var ta=doc.getElementsByTagName("textarea")[0];if(ta)xhr.responseText=ta.value,xhr.status=Number(ta.getAttribute("status"))||xhr.status,xhr.statusText=ta.getAttribute("statusText")||xhr.statusText;else if(scr){var pre=doc.getElementsByTagName("pre")[0],b=doc.getElementsByTagName("body")[0];pre?xhr.responseText=pre.textContent?pre.textContent:pre.innerText:b&&(xhr.responseText=b.textContent?b.textContent:b.innerText)}}else dt=="xml"&&!xhr.responseXML&&xhr.responseText!=null&&(xhr.responseXML=toXml(xhr.responseText));try{data=httpData(xhr,dt,s)}catch(e){status="parsererror",xhr.error=errMsg=e||status}}catch(e){log("error caught: ",e),status="error",xhr.error=errMsg=e||status}xhr.aborted&&(log("upload aborted"),status=null),xhr.status&&(status=xhr.status>=200&&xhr.status<300||xhr.status===304?"success":"error"),status==="success"?(s.success&&s.success.call(s.context,data,"success",xhr),g&&$.event.trigger("ajaxSuccess",[xhr,s])):status&&(errMsg==undefined&&(errMsg=xhr.statusText),s.error&&s.error.call(s.context,xhr,status,errMsg),g&&$.event.trigger("ajaxError",[xhr,s,errMsg])),g&&$.event.trigger("ajaxComplete",[xhr,s]),g&&!--$.active&&$.event.trigger("ajaxStop"),s.complete&&s.complete.call(s.context,xhr,status),callbackProcessed=!0,s.timeout&&clearTimeout(timeoutHandle),setTimeout(function(){s.iframeTarget||$io.remove(),xhr.responseXML=null},100)}var form=$form[0],el,i,s,g,id,$io,io,xhr,sub,n,timedOut,timeoutHandle,useProp=!!$.fn.prop;if(a)if(useProp)for(i=0;i<a.length;i++)el=$(form[a[i].name]),el.prop("disabled",!1);else for(i=0;i<a.length;i++)el=$(form[a[i].name]),el.removeAttr("disabled");if($(":input[name=submit],:input[id=submit]",form).length){alert('Error: Form elements must not have name or id of "submit".');return}s=$.extend(!0,{},$.ajaxSettings,options),s.context=s.context||s,id="jqFormIO"+(new Date).getTime(),s.iframeTarget?($io=$(s.iframeTarget),n=$io.attr("name"),n==null?$io.attr("name",id):id=n):($io=$('<iframe name="'+id+'" src="'+s.iframeSrc+'" />'),$io.css({position:"absolute",top:"-1000px",left:"-1000px"})),io=$io[0],xhr={aborted:0,responseText:null,responseXML:null,status:0,statusText:"n/a",getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(status){var e=status==="timeout"?"timeout":"aborted";log("aborting upload... "+e),this.aborted=1,$io.attr("src",s.iframeSrc),xhr.error=e,s.error&&s.error.call(s.context,xhr,e,status),g&&$.event.trigger("ajaxError",[xhr,s,e]),s.complete&&s.complete.call(s.context,xhr,e)}},g=s.global,g&&!($.active++)&&$.event.trigger("ajaxStart"),g&&$.event.trigger("ajaxSend",[xhr,s]);if(s.beforeSend&&s.beforeSend.call(s.context,xhr,s)===!1){s.global&&$.active--;return}if(xhr.aborted)return;sub=form.clk,sub&&(n=sub.name,n&&!sub.disabled&&(s.extraData=s.extraData||{},s.extraData[n]=sub.value,sub.type=="image"&&(s.extraData[n+".x"]=form.clk_x,s.extraData[n+".y"]=form.clk_y)));var CLIENT_TIMEOUT_ABORT=1,SERVER_ABORT=2;s.forceSync?doSubmit():setTimeout(doSubmit,10);var data,doc,domCheckCount=50,callbackProcessed,toXml=$.parseXML||function(s,doc){return window.ActiveXObject?(doc=new ActiveXObject("Microsoft.XMLDOM"),doc.async="false",doc.loadXML(s)):doc=(new DOMParser).parseFromString(s,"text/xml"),doc&&doc.documentElement&&doc.documentElement.nodeName!="parsererror"?doc:null},parseJSON=$.parseJSON||function(s){return window.eval("("+s+")")},httpData=function(xhr,type,s){var ct=xhr.getResponseHeader("content-type")||"",xml=type==="xml"||!type&&ct.indexOf("xml")>=0,data=xml?xhr.responseXML:xhr.responseText;return xml&&data.documentElement.nodeName==="parsererror"&&$.error&&$.error("parsererror"),s&&s.dataFilter&&(data=s.dataFilter(data,type)),typeof data=="string"&&(type==="json"||!type&&ct.indexOf("json")>=0?data=parseJSON(data):(type==="script"||!type&&ct.indexOf("javascript")>=0)&&$.globalEval(data)),data}}if(!this.length)return log("ajaxSubmit: skipping submit process - no element selected"),this;var method,action,url,$form=this;typeof options=="function"&&(options={success:options}),method=this.attr("method"),action=this.attr("action"),url=typeof action=="string"?$.trim(action):"",url=url||window.location.href||"",url&&(url=(url.match(/^([^#]+)/)||[])[1]),options=$.extend(!0,{url:url,success:$.ajaxSettings.success,type:method||"GET",iframeSrc:/^https/i.test(window.location.href||"")?"javascript:false":"about:blank"},options);var veto={};this.trigger("form-pre-serialize",[this,options,veto]);if(veto.veto)return log("ajaxSubmit: submit vetoed via form-pre-serialize trigger"),this;if(options.beforeSerialize&&options.beforeSerialize(this,options)===!1)return log("ajaxSubmit: submit aborted via beforeSerialize callback"),this;var traditional=options.traditional;traditional===undefined&&(traditional=$.ajaxSettings.traditional);var qx,n,v,a=this.formToArray(options.semantic);options.data&&(options.extraData=options.data,qx=$.param(options.data,traditional));if(options.beforeSubmit&&options.beforeSubmit(a,this,options)===!1)return log("ajaxSubmit: submit aborted via beforeSubmit callback"),this;this.trigger("form-submit-validate",[a,this,options,veto]);if(veto.veto)return log("ajaxSubmit: submit vetoed via form-submit-validate trigger"),this;var q=$.param(a,traditional);qx&&(q=q?q+"&"+qx:qx),options.type.toUpperCase()=="GET"?(options.url+=(options.url.indexOf("?")>=0?"&":"?")+q,options.data=null):options.data=q;var callbacks=[];options.resetForm&&callbacks.push(function(){$form.resetForm()}),options.clearForm&&callbacks.push(function(){$form.clearForm(options.includeHidden)});if(!options.dataType&&options.target){var oldSuccess=options.success||function(){};callbacks.push(function(data){var fn=options.replaceTarget?"replaceWith":"html";$(options.target)[fn](data).each(oldSuccess,arguments)})}else options.success&&callbacks.push(options.success);options.success=function(data,status,xhr){var context=options.context||options;for(var i=0,max=callbacks.length;i<max;i++)callbacks[i].apply(context,[data,status,xhr||$form,$form])};var fileInputs=$("input:file",this).length>0,mp="multipart/form-data",multipart=$form.attr("enctype")==mp||$form.attr("encoding")==mp;if(options.iframe!==!1&&(fileInputs||options.iframe||multipart))options.closeKeepAlive?$.get(options.closeKeepAlive,function(){fileUpload(a)}):fileUpload(a);else{if($.browser.msie&&method=="get"&&typeof options.type=="undefined"){var ieMeth=$form[0].getAttribute("method");typeof ieMeth=="string"&&(options.type=ieMeth)}$.ajax(options)}return this.trigger("form-submit-notify",[this,options]),this},$.fn.ajaxForm=function(options){if(this.length===0){var o={s:this.selector,c:this.context};return!$.isReady&&o.s?(log("DOM not ready, queuing ajaxForm"),$(function(){$(o.s,o.c).ajaxForm(options)}),this):(log("terminating; zero elements found by selector"+($.isReady?"":" (DOM not ready)")),this)}return this.ajaxFormUnbind().bind("submit.form-plugin",function(e){e.isDefaultPrevented()||(e.preventDefault(),$(this).ajaxSubmit(options))}).bind("click.form-plugin",function(e){var target=e.target,$el=$(target);if(!$el.is(":submit,input:image")){var t=$el.closest(":submit");if(t.length==0)return;target=t[0]}var form=this;form.clk=target;if(target.type=="image")if(e.offsetX!=undefined)form.clk_x=e.offsetX,form.clk_y=e.offsetY;else if(typeof $.fn.offset=="function"){var offset=$el.offset();form.clk_x=e.pageX-offset.left,form.clk_y=e.pageY-offset.top}else form.clk_x=e.pageX-target.offsetLeft,form.clk_y=e.pageY-target.offsetTop;setTimeout(function(){form.clk=form.clk_x=form.clk_y=null},100)})},$.fn.ajaxFormUnbind=function(){return this.unbind("submit.form-plugin click.form-plugin")},$.fn.formToArray=function(semantic){var a=[];if(this.length===0)return a;var form=this[0],els=semantic?form.getElementsByTagName("*"):form.elements;if(!els)return a;var i,j,n,v,el,max,jmax;for(i=0,max=els.length;i<max;i++){el=els[i],n=el.name;if(!n)continue;if(semantic&&form.clk&&el.type=="image"){!el.disabled&&form.clk==el&&(a.push({name:n,value:$(el).val()}),a.push({name:n+".x",value:form.clk_x},{name:n+".y",value:form.clk_y}));continue}v=$.fieldValue(el,!0);if(v&&v.constructor==Array)for(j=0,jmax=v.length;j<jmax;j++)a.push({name:n,value:v[j]});else v!==null&&typeof v!="undefined"&&a.push({name:n,value:v})}if(!semantic&&form.clk){var $input=$(form.clk),input=$input[0];n=input.name,n&&!input.disabled&&input.type=="image"&&(a.push({name:n,value:$input.val()}),a.push({name:n+".x",value:form.clk_x},{name:n+".y",value:form.clk_y}))}return a},$.fn.formSerialize=function(semantic){return $.param(this.formToArray(semantic))},$.fn.fieldSerialize=function(successful){var a=[];return this.each(function(){var n=this.name;if(!n)return;var v=$.fieldValue(this,successful);if(v&&v.constructor==Array)for(var i=0,max=v.length;i<max;i++)a.push({name:n,value:v[i]});else v!==null&&typeof v!="undefined"&&a.push({name:this.name,value:v})}),$.param(a)},$.fn.fieldValue=function(successful){for(var val=[],i=0,max=this.length;i<max;i++){var el=this[i],v=$.fieldValue(el,successful);if(v===null||typeof v=="undefined"||v.constructor==Array&&!v.length)continue;v.constructor==Array?$.merge(val,v):val.push(v)}return val},$.fieldValue=function(el,successful){var n=el.name,t=el.type,tag=el.tagName.toLowerCase();successful===undefined&&(successful=!0);if(successful&&(!n||el.disabled||t=="reset"||t=="button"||(t=="checkbox"||t=="radio")&&!el.checked||(t=="submit"||t=="image")&&el.form&&el.form.clk!=el||tag=="select"&&el.selectedIndex==-1))return null;if(tag=="select"){var index=el.selectedIndex;if(index<0)return null;var a=[],ops=el.options,one=t=="select-one",max=one?index+1:ops.length;for(var i=one?index:0;i<max;i++){var op=ops[i];if(op.selected){var v=op.value;v||(v=op.attributes&&op.attributes.value&&!op.attributes.value.specified?op.text:op.value);if(one)return v;a.push(v)}}return a}return $(el).val()},$.fn.clearForm=function(includeHidden){return this.each(function(){$("input,select,textarea",this).clearFields(includeHidden)})},$.fn.clearFields=$.fn.clearInputs=function(includeHidden){var re=/^(?:color|date|datetime|email|month|number|password|range|search|tel|text|time|url|week)$/i;return this.each(function(){var t=this.type,tag=this.tagName.toLowerCase();re.test(t)||tag=="textarea"||includeHidden&&/hidden/.test(t)?this.value="":t=="checkbox"||t=="radio"?this.checked=!1:tag=="select"&&(this.selectedIndex=-1)})},$.fn.resetForm=function(){return this.each(function(){(typeof this.reset=="function"||typeof this.reset=="object"&&!this.reset.nodeType)&&this.reset()})},$.fn.enable=function(b){return b===undefined&&(b=!0),this.each(function(){this.disabled=!b})},$.fn.selected=function(select){return select===undefined&&(select=!0),this.each(function(){var t=this.type;if(t=="checkbox"||t=="radio")this.checked=select;else if(this.tagName.toLowerCase()=="option"){var $sel=$(this).parent("select");select&&$sel[0]&&$sel[0].type=="select-one"&&$sel.find("option").selected(!1),this.selected=select}})},$.fn.ajaxSubmit.debug=!1}(jQuery),define("libs/jquery.form",function(){}),function(a){a(jQuery)}(function(a){function B(f,h){function w(a){var b=a.precedance==="y",c=n[b?"width":"height"],d=n[b?"height":"width"],e=a.string().indexOf("center")>-1,f=c*(e?.5:1),g=Math.pow,h=Math.round,i,j,k,l=Math.sqrt(g(f,2)+g(d,2)),m=[p/f*l,p/d*l];return m[2]=Math.sqrt(g(m[0],2)-g(p,2)),m[3]=Math.sqrt(g(m[1],2)-g(p,2)),i=l+m[2]+m[3]+(e?0:m[0]),j=i/l,k=[h(j*d),h(j*c)],{height:k[b?0:1],width:k[b?1:0]}}function v(b){var c=k.titlebar&&b.y==="top",d=c?k.titlebar:k.content,e=a.browser.mozilla,f=e?"-moz-":a.browser.webkit?"-webkit-":"",g=b.y+(e?"":"-")+b.x,h=f+(e?"border-radius-"+g:"border-"+g+"-radius");return parseInt(d.css(h),10)||parseInt(l.css(h),10)||0}function u(a,b,c){b=b?b:a[a.precedance];var d=l.hasClass(q),e=k.titlebar&&a.y==="top",f=e?k.titlebar:k.content,g="border-"+b+"-width",h;return l.addClass(q),h=parseInt(f.css(g),10),h=(c?h||parseInt(l.css(g),10):h)||0,l.toggleClass(q,d),h}function t(a,d,g,h){if(k.tip){var l=i.corner.clone(),n=g.adjusted,o=f.options.position.adjust.method.split(" "),p=o[0],q=o[1]||o[0],r={left:c,top:c,x:0,y:0},s,t={},u;i.corner.fixed!==b&&(p==="shift"&&l.precedance==="x"&&n.left&&l.y!=="center"?l.precedance=l.precedance==="x"?"y":"x":p==="flip"&&n.left&&(l.x=l.x==="center"?n.left>0?"left":"right":l.x==="left"?"right":"left"),q==="shift"&&l.precedance==="y"&&n.top&&l.x!=="center"?l.precedance=l.precedance==="y"?"x":"y":q==="flip"&&n.top&&(l.y=l.y==="center"?n.top>0?"top":"bottom":l.y==="top"?"bottom":"top"),l.string()!==m.corner.string()&&(m.top!==n.top||m.left!==n.left)&&i.update(l,c)),s=i.position(l,n),s.right!==e&&(s.left=-s.right),s.bottom!==e&&(s.top=-s.bottom),s.user=Math.max(0,j.offset);if(r.left=p==="shift"&&!!n.left)l.x==="center"?t["margin-left"]=r.x=s["margin-left"]-n.left:(u=s.right!==e?[n.left,-s.left]:[-n.left,s.left],(r.x=Math.max(u[0],u[1]))>u[0]&&(g.left-=n.left,r.left=c),t[s.right!==e?"right":"left"]=r.x);if(r.top=q==="shift"&&!!n.top)l.y==="center"?t["margin-top"]=r.y=s["margin-top"]-n.top:(u=s.bottom!==e?[n.top,-s.top]:[-n.top,s.top],(r.y=Math.max(u[0],u[1]))>u[0]&&(g.top-=n.top,r.top=c),t[s.bottom!==e?"bottom":"top"]=r.y);k.tip.css(t).toggle(!(r.x&&r.y||l.x==="center"&&r.y||l.y==="center"&&r.x)),g.left-=s.left.charAt?s.user:p!=="shift"||r.top||!r.left&&!r.top?s.left:0,g.top-=s.top.charAt?s.user:q!=="shift"||r.left||!r.left&&!r.top?s.top:0,m.left=n.left,m.top=n.top,m.corner=l.clone()}}var i=this,j=f.options.style.tip,k=f.elements,l=k.tooltip,m={top:0,left:0},n={width:j.width,height:j.height},o={},p=j.border||0,r=".qtip-tip",s=!!(a("<canvas />")[0]||{}).getContext;i.mimic=i.corner=d,i.border=p,i.offset=j.offset,i.size=n,f.checks.tip={"^position.my|style.tip.(corner|mimic|border)$":function(){i.init()||i.destroy(),f.reposition()},"^style.tip.(height|width)$":function(){n={width:j.width,height:j.height},i.create(),i.update(),f.reposition()},"^content.title.text|style.(classes|widget)$":function(){k.tip&&i.update()}},a.extend(i,{init:function(){var b=i.detectCorner()&&(s||a.browser.msie);return b&&(i.create(),i.update(),l.unbind(r).bind("tooltipmove"+r,t)),b},detectCorner:function(){var a=j.corner,d=f.options.position,e=d.at,h=d.my.string?d.my.string():d.my;return a===c||h===c&&e===c?c:(a===b?i.corner=new g.Corner(h):a.string||(i.corner=new g.Corner(a),i.corner.fixed=b),m.corner=new g.Corner(i.corner.string()),i.corner.string()!=="centercenter")},detectColours:function(b){var c,d,e,g=k.tip.css("cssText",""),h=b||i.corner,m=h[h.precedance],p="border-"+m+"-color",r="border"+m.charAt(0)+m.substr(1)+"Color",s=/rgba?\(0, 0, 0(, 0)?\)|transparent|#123456/i,t="background-color",u="transparent",v=" !important",w=a(document.body).css("color"),x=f.elements.content.css("color"),y=k.titlebar&&(h.y==="top"||h.y==="center"&&g.position().top+n.height/2+j.offset<k.titlebar.outerHeight(1)),z=y?k.titlebar:k.content;l.addClass(q),o.fill=d=g.css(t),o.border=e=g[0].style[r]||g.css(p)||l.css(p);if(!d||s.test(d))o.fill=z.css(t)||u,s.test(o.fill)&&(o.fill=l.css(t)||d);if(!e||s.test(e)||e===w)o.border=z.css(p)||u,s.test(o.border)&&(o.border=e);a("*",g).add(g).css("cssText",t+":"+u+v+";border:0"+v+";"),l.removeClass(q)},create:function(){var b=n.width,c=n.height,d;k.tip&&k.tip.remove(),k.tip=a("<div />",{"class":"ui-tooltip-tip"}).css({width:b,height:c}).prependTo(l),s?a("<canvas />").appendTo(k.tip)[0].getContext("2d").save():(d='<vml:shape coordorigin="0,0" style="display:inline-block; position:absolute; behavior:url(#default#VML);"></vml:shape>',k.tip.html(d+d),a("*",k.tip).bind("click mousedown",function(a){a.stopPropagation()}))},update:function(e,f){var h=k.tip,l=h.children(),q=n.width,r=n.height,t="px solid ",v="px dashed transparent",x=j.mimic,y=Math.round,z,B,C,D,E;e||(e=m.corner||i.corner),x===c?x=e:(x=new g.Corner(x),x.precedance=e.precedance,x.x==="inherit"?x.x=e.x:x.y==="inherit"?x.y=e.y:x.x===x.y&&(x[e.precedance]=e[e.precedance])),z=x.precedance,i.detectColours(e),o.border!=="transparent"&&o.border!=="#123456"?(p=u(e,d,b),j.border===0&&p>0&&(o.fill=o.border),i.border=p=j.border!==b?j.border:p):i.border=p=0,C=A(x,q,r),i.size=E=w(e),h.css(E),e.precedance==="y"?D=[y(x.x==="left"?p:x.x==="right"?E.width-q-p:(E.width-q)/2),y(x.y==="top"?E.height-r:0)]:D=[y(x.x==="left"?E.width-q:0),y(x.y==="top"?p:x.y==="bottom"?E.height-r-p:(E.height-r)/2)],s?(l.attr(E),B=l[0].getContext("2d"),B.restore(),B.save(),B.clearRect(0,0,3e3,3e3),B.translate(D[0],D[1]),B.beginPath(),B.moveTo(C[0][0],C[0][1]),B.lineTo(C[1][0],C[1][1]),B.lineTo(C[2][0],C[2][1]),B.closePath(),B.fillStyle=o.fill,B.strokeStyle=o.border,B.lineWidth=p*2,B.lineJoin="miter",B.miterLimit=100,p&&B.stroke(),B.fill()):(C="m"+C[0][0]+","+C[0][1]+" l"+C[1][0]+","+C[1][1]+" "+C[2][0]+","+C[2][1]+" xe",D[2]=p&&/^(r|b)/i.test(e.string())?parseFloat(a.browser.version,10)===8?2:1:0,l.css({antialias:""+(x.string().indexOf("center")>-1),left:D[0]-D[2]*Number(z==="x"),top:D[1]-D[2]*Number(z==="y"),width:q+p,height:r+p}).each(function(b){var c=a(this);c[c.prop?"prop":"attr"]({coordsize:q+p+" "+(r+p),path:C,fillcolor:o.fill,filled:!!b,stroked:!b}).css({display:p||b?"block":"none"}),!b&&c.html()===""&&c.html('<vml:stroke weight="'+p*2+'px" color="'+o.border+'" miterlimit="1000" joinstyle="miter"  style="behavior:url(#default#VML); display:inline-block;" />')})),f!==c&&i.position(e)},position:function(d){var e=k.tip,f={},g=Math.max(0,j.offset),h,l,m;return j.corner===c||!e?c:(d=d||i.corner,h=d.precedance,l=w(d),m=[d.x,d.y],h==="x"&&m.reverse(),a.each(m,function(a,c){var e,i;c==="center"?(e=h==="y"?"left":"top",f[e]="50%",f["margin-"+e]=-Math.round(l[h==="y"?"width":"height"]/2)+g):(e=u(d,c,b),i=v(d),f[c]=a?p?u(d,c):0:g+(i>e?i:0))}),f[d[h]]-=l[h==="x"?"width":"height"],e.css({top:"",bottom:"",left:"",right:"",margin:""}).css(f),f)},destroy:function(){k.tip&&k.tip.remove(),l.unbind(r)}}),i.init()}function A(a,b,c){var d=Math.ceil(b/2),e=Math.ceil(c/2),f={bottomright:[[0,0],[b,c],[b,0]],bottomleft:[[0,0],[b,0],[0,c]],topright:[[0,c],[b,0],[b,c]],topleft:[[0,0],[0,c],[b,c]],topcenter:[[0,c],[d,0],[b,c]],bottomcenter:[[0,0],[b,0],[d,c]],rightcenter:[[0,0],[b,e],[0,c]],leftcenter:[[b,0],[b,c],[0,e]]};return f.lefttop=f.bottomright,f.righttop=f.bottomleft,f.leftbottom=f.topright,f.rightbottom=f.topleft,f[a.string()]}function z(d){var e=this,f=d.elements.tooltip,g=d.options.content.ajax,h=".qtip-ajax",i=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,j=b,k=c,l;d.checks.ajax={"^content.ajax":function(a,b,c){b==="ajax"&&(g=c),b==="once"?e.init():g&&g.url?e.load():f.unbind(h)}},a.extend(e,{init:function(){return g&&g.url&&f.unbind(h)[g.once?"one":"bind"]("tooltipshow"+h,e.load),e},load:function(b,f){function r(a,b,c){!k&&a.status!==0&&d.set("content.text",b+": "+c)}function q(b){k||(m&&(b=a("<div/>").append(b.replace(i,"")).find(m)),d.set("content.text",b))}function p(){k||(n&&(d.show(b.originalEvent),f=c),a.isFunction(g.complete)&&g.complete.apply(this,arguments))}var h=g.url.indexOf(" "),j=g.url,m,n=g.once&&!g.loading&&f;if(n)try{b.preventDefault()}catch(o){}else if(b&&b.isDefaultPrevented())return e;l&&l.abort&&l.abort(),h>-1&&(m=j.substr(h),j=j.substr(0,h)),l=a.ajax(a.extend({success:q,error:r,context:d},g,{url:j,complete:p}))},destroy:function(){l&&l.abort&&l.abort(),k=b}}),e.init()}function y(e,h){var i,j,k,l,m,n=a(this),o=a(document.body),p=this===document?o:n,q=n.metadata?n.metadata(h.metadata):d,r=h.metadata.type==="html5"&&q?q[h.metadata.name]:d,s=n.data(h.metadata.name||"qtipopts");try{s=typeof s=="string"?(new Function("return "+s))():s}catch(u){v("Unable to parse HTML5 attribute data: "+s)}l=a.extend(b,{},f.defaults,h,typeof s=="object"?w(s):d,w(r||q)),j=l.position,l.id=e;if("boolean"==typeof l.content.text){k=n.attr(l.content.attr);if(l.content.attr===c||!k)return v("Unable to locate content for tooltip! Aborting render of tooltip on element: ",n),c;l.content.text=k}j.container.length||(j.container=o),j.target===c&&(j.target=p),l.show.target===c&&(l.show.target=p),l.show.solo===b&&(l.show.solo=j.container.closest("body")),l.hide.target===c&&(l.hide.target=p),l.position.viewport===b&&(l.position.viewport=j.container),j.at=new g.Corner(j.at),j.my=new g.Corner(j.my);if(a.data(this,"qtip"))if(l.overwrite)n.qtip("destroy");else if(l.overwrite===c)return c;return l.suppress&&(m=a.attr(this,"title"))&&a(this).removeAttr("title").attr(t,m),i=new x(n,l,e,!!k),a.data(this,"qtip",i),n.bind("remove.qtip-"+e+" removeqtip.qtip-"+e,function(){i.destroy()}),i}function x(r,s,v,x){function Q(){var b=[s.show.target[0],s.hide.target[0],y.rendered&&F.tooltip[0],s.position.container[0],s.position.viewport[0],window,document];y.rendered?a([]).pushStack(a.grep(b,function(a){return typeof a=="object"})).unbind(E):s.show.target.unbind(E+"-create")}function P(){function o(a){D.is(":visible")&&y.reposition(a)}function n(a){if(D.hasClass(l))return c;clearTimeout(y.timers.inactive),y.timers.inactive=setTimeout(function(){y.hide(a)},s.hide.inactive)}function k(b){if(D.hasClass(l)||B||C)return c;var f=a(b.relatedTarget||b.target),g=f.closest(m)[0]===D[0],h=f[0]===e.show[0];clearTimeout(y.timers.show),clearTimeout(y.timers.hide);if(d.target==="mouse"&&g||s.hide.fixed&&/mouse(out|leave|move)/.test(b.type)&&(g||h))try{b.preventDefault(),b.stopImmediatePropagation()}catch(i){}else s.hide.delay>0?y.timers.hide=setTimeout(function(){y.hide(b)},s.hide.delay):y.hide(b)}function j(a){if(D.hasClass(l))return c;clearTimeout(y.timers.show),clearTimeout(y.timers.hide);var d=function(){y.toggle(b,a)};s.show.delay>0?y.timers.show=setTimeout(d,s.show.delay):d()}var d=s.position,e={show:s.show.target,hide:s.hide.target,viewport:a(d.viewport),document:a(document),body:a(document.body),window:a(window)},g={show:a.trim(""+s.show.event).split(" "),hide:a.trim(""+s.hide.event).split(" ")},i=a.browser.msie&&parseInt(a.browser.version,10)===6;D.bind("mouseenter"+E+" mouseleave"+E,function(a){var b=a.type==="mouseenter";b&&y.focus(a),D.toggleClass(p,b)}),s.hide.fixed&&(e.hide=e.hide.add(D),D.bind("mouseover"+E,function(){D.hasClass(l)||clearTimeout(y.timers.hide)})),/mouse(out|leave)/i.test(s.hide.event)?s.hide.leave==="window"&&e.window.bind("mouseout"+E+" blur"+E,function(a){/select|option/.test(a.target)&&!a.relatedTarget&&y.hide(a)}):/mouse(over|enter)/i.test(s.show.event)&&e.hide.bind("mouseleave"+E,function(a){clearTimeout(y.timers.show)}),(""+s.hide.event).indexOf("unfocus")>-1&&d.container.closest("html").bind("mousedown"+E,function(b){var c=a(b.target),d=!D.hasClass(l)&&D.is(":visible"),e=c.parents(m).filter(D[0]).length>0;c[0]!==r[0]&&c[0]!==D[0]&&!e&&!r.has(c[0]).length&&!c.attr("disabled")&&y.hide(b)}),"number"==typeof s.hide.inactive&&(e.show.bind("qtip-"+v+"-inactive",n),a.each(f.inactiveEvents,function(a,b){e.hide.add(F.tooltip).bind(b+E+"-inactive",n)})),a.each(g.hide,function(b,c){var d=a.inArray(c,g.show),f=a(e.hide);d>-1&&f.add(e.show).length===f.length||c==="unfocus"?(e.show.bind(c+E,function(a){D.is(":visible")?k(a):j(a)}),delete g.show[d]):e.hide.bind(c+E,k)}),a.each(g.show,function(a,b){e.show.bind(b+E,j)}),"number"==typeof s.hide.distance&&e.show.add(D).bind("mousemove"+E,function(a){var b=G.origin||{},c=s.hide.distance,d=Math.abs;(d(a.pageX-b.pageX)>=c||d(a.pageY-b.pageY)>=c)&&y.hide(a)}),d.target==="mouse"&&(e.show.bind("mousemove"+E,function(a){h={pageX:a.pageX,pageY:a.pageY,type:"mousemove"}}),d.adjust.mouse&&(s.hide.event&&(D.bind("mouseleave"+E,function(a){(a.relatedTarget||a.target)!==e.show[0]&&y.hide(a)}),F.target.bind("mouseenter"+E+" mouseleave"+E,function(a){G.onTarget=a.type==="mouseenter"})),e.document.bind("mousemove"+E,function(a){G.onTarget&&!D.hasClass(l)&&D.is(":visible")&&y.reposition(a||h)}))),(d.adjust.resize||e.viewport.length)&&(a.event.special.resize?e.viewport:e.window).bind("resize"+E,o),(e.viewport.length||i&&D.css("position")==="fixed")&&e.viewport.bind("scroll"+E,o)}function O(b,d){function g(b){function i(e){e&&(delete h[e.src],clearTimeout(y.timers.img[e.src]),a(e).unbind(E)),a.isEmptyObject(h)&&(y.redraw(),d!==c&&y.reposition(G.event),b())}var g,h={};if((g=f.find("img[src]:not([height]):not([width])")).length===0)return i();g.each(function(b,c){if(h[c.src]===e){var d=0,f=3;(function t(){if(c.height||c.width||d>f)return i(c);d+=1,y.timers.img[c.src]=setTimeout(g,700)})(),a(c).bind("error"+E+" load"+E,function(){i(this)}),h[c.src]=c}})}var f=F.content;return!y.rendered||!b?c:(a.isFunction(b)&&(b=b.call(r,G.event,y)||""),b.jquery&&b.length>0?f.empty().append(b.css({display:"block"})):f.html(b),y.rendered<0?D.queue("fx",g):(C=0,g(a.noop)),y)}function N(b,d){var e=F.title;if(!y.rendered||!b)return c;a.isFunction(b)&&(b=b.call(r,G.event,y));if(b===c||!b&&b!=="")return J(c);b.jquery&&b.length>0?e.empty().append(b.css({display:"block"})):e.html(b),y.redraw(),d!==c&&y.rendered&&D.is(":visible")&&y.reposition(G.event)}function M(a){var b=F.button,d=F.title;if(!y.rendered)return c;a?(d||L(),K()):b.remove()}function L(){var c=A+"-title";F.titlebar&&J(),F.titlebar=a("<div />",{"class":j+"-titlebar "+(s.style.widget?"ui-widget-header":"")}).append(F.title=a("<div />",{id:c,"class":j+"-title","aria-atomic":b})).insertBefore(F.content).delegate(".ui-tooltip-close","mousedown keydown mouseup keyup mouseout",function(b){a(this).toggleClass("ui-state-active ui-state-focus",b.type.substr(-4)==="down")}).delegate(".ui-tooltip-close","mouseover mouseout",function(b){a(this).toggleClass("ui-state-hover",b.type==="mouseover")}),s.content.title.button?K():y.rendered&&y.redraw()}function K(){var b=s.content.title.button,d=typeof b=="string",e=d?b:"Close tooltip";F.button&&F.button.remove(),b.jquery?F.button=b:F.button=a("<a />",{"class":"ui-state-default ui-tooltip-close "+(s.style.widget?"":j+"-icon"),title:e,"aria-label":e}).prepend(a("<span />",{"class":"ui-icon ui-icon-close",html:"&times;"})),F.button.appendTo(F.titlebar).attr("role","button").click(function(a){return D.hasClass(l)||y.hide(a),c}),y.redraw()}function J(a){F.title&&(F.titlebar.remove(),F.titlebar=F.title=F.button=d,a!==c&&y.reposition())}function I(){var a=s.style.widget;D.toggleClass(k,a).toggleClass(n,s.style.def&&!a),F.content.toggleClass(k+"-content",a),F.titlebar&&F.titlebar.toggleClass(k+"-header",a),F.button&&F.button.toggleClass(j+"-icon",!a)}function H(a){var b=0,c,d=s,e=a.split(".");while(d=d[e[b++]])b<e.length&&(c=d);return[c||s,e.pop()]}var y=this,z=document.body,A=j+"-"+v,B=0,C=0,D=a(),E=".qtip-"+v,F,G;y.id=v,y.rendered=c,y.elements=F={target:r},y.timers={img:{}},y.options=s,y.checks={},y.plugins={},y.cache=G={event:{},target:a(),disabled:c,attr:x,onTarget:c},y.checks.builtin={"^id$":function(d,e,g){var h=g===b?f.nextid:g,i=j+"-"+h;h!==c&&h.length>0&&!a("#"+i).length&&(D[0].id=i,F.content[0].id=i+"-content",F.title[0].id=i+"-title")},"^content.text$":function(a,b,c){O(c)},"^content.title.text$":function(a,b,c){if(!c)return J();!F.title&&c&&L(),N(c)},"^content.title.button$":function(a,b,c){M(c)},"^position.(my|at)$":function(a,b,c){"string"==typeof c&&(a[b]=new g.Corner(c))},"^position.container$":function(a,b,c){y.rendered&&D.appendTo(c)},"^show.ready$":function(){y.rendered?y.toggle(b):y.render(1)},"^style.classes$":function(a,b,c){D.attr("class",j+" qtip ui-helper-reset "+c)},"^style.widget|content.title":I,"^events.(render|show|move|hide|focus|blur)$":function(b,c,d){D[(a.isFunction(d)?"":"un")+"bind"]("tooltip"+c,d)},"^(show|hide|position).(event|target|fixed|inactive|leave|distance|viewport|adjust)":function(){var a=s.position;D.attr("tracking",a.target==="mouse"&&a.adjust.mouse),Q(),P()}},a.extend(y,{render:function(d){if(y.rendered)return y;var e=s.content.text,f=s.content.title.text,h=s.position,i=a.Event("tooltiprender");return a.attr(r[0],"aria-describedby",A),D=F.tooltip=a("<div/>",{id:A,"class":j+" qtip ui-helper-reset "+n+" "+s.style.classes+" "+j+"-pos-"+s.position.my.abbrev(),width:s.style.width||"",height:s.style.height||"",tracking:h.target==="mouse"&&h.adjust.mouse,role:"alert","aria-live":"polite","aria-atomic":c,"aria-describedby":A+"-content","aria-hidden":b}).toggleClass(l,G.disabled).data("qtip",y).appendTo(s.position.container).append(F.content=a("<div />",{"class":j+"-content",id:A+"-content","aria-atomic":b})),y.rendered=-1,B=C=1,f&&(L(),a.isFunction(f)||N(f,c)),a.isFunction(e)||O(e,c),y.rendered=b,I(),a.each(s.events,function(b,c){a.isFunction(c)&&D.bind(b==="toggle"?"tooltipshow tooltiphide":"tooltip"+b,c)}),a.each(g,function(){this.initialize==="render"&&this(y)}),P(),D.queue("fx",function(a){i.originalEvent=G.event,D.trigger(i,[y]),B=C=0,y.redraw(),(s.show.ready||d)&&y.toggle(b,G.event,c),a()}),y},get:function(a){var b,c;switch(a.toLowerCase()){case"dimensions":b={height:D.outerHeight(),width:D.outerWidth()};break;case"offset":b=g.offset(D,s.position.container);break;default:c=H(a.toLowerCase()),b=c[0][c[1]],b=b.precedance?b.string():b}return b},set:function(e,f){function m(a,b){var c,d,e;for(c in k)for(d in k[c])if(e=(new RegExp(d,"i")).exec(a))b.push(e),k[c][d].apply(y,b)}var g=/^position\.(my|at|adjust|target|container)|style|content|show\.ready/i,h=/^content\.(title|attr)|style/i,i=c,j=c,k=y.checks,l;return"string"==typeof e?(l=e,e={},e[l]=f):e=a.extend(b,{},e),a.each(e,function(b,c){var d=H(b.toLowerCase()),f;f=d[0][d[1]],d[0][d[1]]="object"==typeof c&&c.nodeType?a(c):c,e[b]=[d[0],d[1],c,f],i=g.test(b)||i,j=h.test(b)||j}),w(s),B=C=1,a.each(e,m),B=C=0,D.is(":visible")&&y.rendered&&(i&&y.reposition(s.position.target==="mouse"?d:G.event),j&&y.redraw()),y},toggle:function(e,f){function q(){e?(a.browser.msie&&D[0].style.removeAttribute("filter"),D.css("overflow",""),"string"==typeof i.autofocus&&a(i.autofocus,D).focus(),p=a.Event("tooltipvisible"),p.originalEvent=f?G.event:d,D.trigger(p,[y]),i.target.trigger("qtip-"+v+"-inactive")):D.css({display:"",visibility:"",opacity:"",left:"",top:""})}if(!y.rendered)return e?y.render(1):y;var g=e?"show":"hide",i=s[g],j=D.is(":visible"),k=!f||s[g].target.length<2||G.target[0]===f.target,l=s.position,n=s.content,o,p;(typeof e).search("boolean|number")&&(e=!j);if(!D.is(":animated")&&j===e&&k)return y;if(f){if(/over|enter/.test(f.type)&&/out|leave/.test(G.event.type)&&f.target===s.show.target[0]&&D.has(f.relatedTarget).length)return y;G.event=a.extend({},f)}return p=a.Event("tooltip"+g),p.originalEvent=f?G.event:d,D.trigger(p,[y,90]),p.isDefaultPrevented()?y:(a.attr(D[0],"aria-hidden",!e),e?(G.origin=a.extend({},h),y.focus(f),a.isFunction(n.text)&&O(n.text,c),a.isFunction(n.title.text)&&N(n.title.text,c),!u&&l.target==="mouse"&&l.adjust.mouse&&(a(document).bind("mousemove.qtip",function(a){h={pageX:a.pageX,pageY:a.pageY,type:"mousemove"}}),u=b),y.reposition(f,arguments[2]),(p.solo=!!i.solo)&&a(m,i.solo).not(D).qtip("hide",p)):(clearTimeout(y.timers.show),delete G.origin,u&&!a(m+'[tracking="true"]:visible',i.solo).not(D).length&&(a(document).unbind("mousemove.qtip"),u=c),y.blur(f)),k&&D.stop(0,1),i.effect===c?(D[g](),q.call(D)):a.isFunction(i.effect)?(i.effect.call(D,y),D.queue("fx",function(a){q(),a()})):D.fadeTo(90,e?1:0,q),e&&i.target.trigger("qtip-"+v+"-inactive"),y)},show:function(a){return y.toggle(b,a)},hide:function(a){return y.toggle(c,a)},focus:function(b){if(!y.rendered)return y;var c=a(m),d=parseInt(D[0].style.zIndex,10),e=f.zindex+c.length,g=a.extend({},b),h,i;return D.hasClass(o)||(i=a.Event("tooltipfocus"),i.originalEvent=g,D.trigger(i,[y,e]),i.isDefaultPrevented()||(d!==e&&(c.each(function(){this.style.zIndex>d&&(this.style.zIndex=this.style.zIndex-1)}),c.filter("."+o).qtip("blur",g)),D.addClass(o)[0].style.zIndex=e)),y},blur:function(b){var c=a.extend({},b),d;return D.removeClass(o),d=a.Event("tooltipblur"),d.originalEvent=c,D.trigger(d,[y]),y},reposition:function(b,d){if(!y.rendered||B)return y;B=1;var e=s.position.target,f=s.position,i=f.my,k=f.at,l=f.adjust,m=l.method.split(" "),n=D.outerWidth(),o=D.outerHeight(),p=0,q=0,r=a.Event("tooltipmove"),t=D.css("position")==="fixed",u=f.viewport,v={left:0,top:0},w=f.container,x=c,A=y.plugins.tip,C={horizontal:m[0],vertical:m[1]=m[1]||m[0],enabled:u.jquery&&e[0]!==window&&e[0]!==z&&l.method!=="none",left:function(a){var b=C.horizontal==="shift",c=-w.offset.left+u.offset.left+u.scrollLeft,d=i.x==="left"?n:i.x==="right"?-n:-n/2,e=k.x==="left"?p:k.x==="right"?-p:-p/2,f=A&&A.size?A.size.width||0:0,g=A&&A.corner&&A.corner.precedance==="x"&&!b?f:0,h=c-a+g,j=a+n-u.width-c+g,m=d-(i.precedance==="x"||i.x===i.y?e:0)-(k.x==="center"?p/2:0),o=i.x==="center";return b?(g=A&&A.corner&&A.corner.precedance==="y"?f:0,m=(i.x==="left"?1:-1)*d-g,v.left+=h>0?h:j>0?-j:0,v.left=Math.max(-w.offset.left+u.offset.left+(g&&A.corner.x==="center"?A.offset:0),a-m,Math.min(Math.max(-w.offset.left+u.offset.left+u.width,a+m),v.left))):(h>0&&(i.x!=="left"||j>0)?v.left-=m:j>0&&(i.x!=="right"||h>0)&&(v.left-=o?-m:m),v.left!==a&&o&&(v.left-=l.x),v.left<c&&-v.left>j&&(v.left=a)),v.left-a},top:function(a){var b=C.vertical==="shift",c=-w.offset.top+u.offset.top+u.scrollTop,d=i.y==="top"?o:i.y==="bottom"?-o:-o/2,e=k.y==="top"?q:k.y==="bottom"?-q:-q/2,f=A&&A.size?A.size.height||0:0,g=A&&A.corner&&A.corner.precedance==="y"&&!b?f:0,h=c-a+g,j=a+o-u.height-c+g,m=d-(i.precedance==="y"||i.x===i.y?e:0)-(k.y==="center"?q/2:0),n=i.y==="center";return b?(g=A&&A.corner&&A.corner.precedance==="x"?f:0,m=(i.y==="top"?1:-1)*d-g,v.top+=h>0?h:j>0?-j:0,v.top=Math.max(-w.offset.top+u.offset.top+(g&&A.corner.x==="center"?A.offset:0),a-m,Math.min(Math.max(-w.offset.top+u.offset.top+u.height,a+m),v.top))):(h>0&&(i.y!=="top"||j>0)?v.top-=m:j>0&&(i.y!=="bottom"||h>0)&&(v.top-=n?-m:m),v.top!==a&&n&&(v.top-=l.y),v.top<0&&-v.top>j&&(v.top=a)),v.top-a}},E;if(a.isArray(e)&&e.length===2)k={x:"left",y:"top"},v={left:e[0],top:e[1]};else if(e==="mouse"&&(b&&b.pageX||G.event.pageX))k={x:"left",y:"top"},b=(!b||b.type!=="resize"&&b.type!=="scroll"?b&&b.pageX&&b.type==="mousemove"?b:h&&h.pageX&&(l.mouse||!b||!b.pageX)?{pageX:h.pageX,pageY:h.pageY}:!l.mouse&&G.origin&&G.origin.pageX&&s.show.distance?G.origin:b:G.event)||b||G.event||h||{},v={top:b.pageY,left:b.pageX};else{e==="event"?b&&b.target&&b.type!=="scroll"&&b.type!=="resize"?e=G.target=a(b.target):e=G.target:e=G.target=a(e.jquery?e:F.target),e=a(e).eq(0);if(e.length===0)return y;e[0]===document||e[0]===window?(p=g.iOS?window.innerWidth:e.width(),q=g.iOS?window.innerHeight:e.height(),e[0]===window&&(v={top:(u||e).scrollTop(),left:(u||e).scrollLeft()})):e.is("area")&&g.imagemap?v=g.imagemap(e,k,C.enabled?m:c):e[0].namespaceURI==="http://www.w3.org/2000/svg"&&g.svg?v=g.svg(e,k):(p=e.outerWidth(),q=e.outerHeight(),v=g.offset(e,w)),v.offset&&(p=v.width,q=v.height,x=v.flipoffset,v=v.offset);if(g.iOS<4.1&&g.iOS>3.1||g.iOS==4.3||!g.iOS&&t)E=a(window),v.left-=E.scrollLeft(),v.top-=E.scrollTop();v.left+=k.x==="right"?p:k.x==="center"?p/2:0,v.top+=k.y==="bottom"?q:k.y==="center"?q/2:0}return v.left+=l.x+(i.x==="right"?-n:i.x==="center"?-n/2:0),v.top+=l.y+(i.y==="bottom"?-o:i.y==="center"?-o/2:0),C.enabled?(u={elem:u,height:u[(u[0]===window?"h":"outerH")+"eight"](),width:u[(u[0]===window?"w":"outerW")+"idth"](),scrollLeft:t?0:u.scrollLeft(),scrollTop:t?0:u.scrollTop(),offset:u.offset()||{left:0,top:0}},w={elem:w,scrollLeft:w.scrollLeft(),scrollTop:w.scrollTop(),offset:w.offset()||{left:0,top:0}},v.adjusted={left:C.horizontal!=="none"?C.left(v.left):0,top:C.vertical!=="none"?C.top(v.top):0},v.adjusted.left+v.adjusted.top&&D.attr("class",D[0].className.replace(/ui-tooltip-pos-\w+/i,j+"-pos-"+i.abbrev())),x&&v.adjusted.left&&(v.left+=x.left),x&&v.adjusted.top&&(v.top+=x.top)):v.adjusted={left:0,top:0},r.originalEvent=a.extend({},b),D.trigger(r,[y,v,u.elem||u]),r.isDefaultPrevented()?y:(delete v.adjusted,d===c||isNaN(v.left)||isNaN(v.top)||e==="mouse"||!a.isFunction(f.effect)?D.css(v):a.isFunction(f.effect)&&(f.effect.call(D,y,a.extend({},v)),D.queue(function(b){a(this).css({opacity:"",height:""}),a.browser.msie&&this.style.removeAttribute("filter"),b()})),B=0,y)},redraw:function(){if(y.rendered<1||C)return y;var a=s.position.container,b,c,d,e;return C=1,s.style.height&&D.css("height",s.style.height),s.style.width?D.css("width",s.style.width):(D.css("width","").addClass(q),c=D.width()+1,d=D.css("max-width")||"",e=D.css("min-width")||"",b=(d+e).indexOf("%")>-1?a.width()/100:0,d=(d.indexOf("%")>-1?b:1)*parseInt(d,10)||c,e=(e.indexOf("%")>-1?b:1)*parseInt(e,10)||0,c=d+e?Math.min(Math.max(c,e),d):c,D.css("width",Math.round(c)).removeClass(q)),C=0,y},disable:function(b){return"boolean"!=typeof b&&(b=!D.hasClass(l)&&!G.disabled),y.rendered?(D.toggleClass(l,b),a.attr(D[0],"aria-disabled",b)):G.disabled=!!b,y},enable:function(){return y.disable(c)},destroy:function(){var b=r[0],c=a.attr(b,t),d=r.data("qtip");y.rendered&&(D.stop(1,0).remove(),a.each(y.plugins,function(){this.destroy&&this.destroy()})),clearTimeout(y.timers.show),clearTimeout(y.timers.hide),Q();if(!d||y===d)a.removeData(b,"qtip"),s.suppress&&c&&(a.attr(b,"title",c),r.removeAttr(t)),r.removeAttr("aria-describedby");return r.unbind(".qtip-"+v),delete i[y.id],r}})}function w(b){var e;if(!b||"object"!=typeof b)return c;if(b.metadata===d||"object"!=typeof b.metadata)b.metadata={type:b.metadata};if("content"in b){if(b.content===d||"object"!=typeof b.content||b.content.jquery)b.content={text:b.content};e=b.content.text||c,!a.isFunction(e)&&(!e&&!e.attr||e.length<1||"object"==typeof e&&!e.jquery)&&(b.content.text=c);if("title"in b.content){if(b.content.title===d||"object"!=typeof b.content.title)b.content.title={text:b.content.title};e=b.content.title.text||c,!a.isFunction(e)&&(!e&&!e.attr||e.length<1||"object"==typeof e&&!e.jquery)&&(b.content.title.text=c)}}return"position"in b&&(b.position===d||"object"!=typeof b.position)&&(b.position={my:b.position,at:b.position}),"show"in b&&(b.show===d||"object"!=typeof b.show)&&(b.show.jquery?b.show={target:b.show}:b.show={event:b.show}),"hide"in b&&(b.hide===d||"object"!=typeof b.hide)&&(b.hide.jquery?b.hide={target:b.hide}:b.hide={event:b.hide}),"style"in b&&(b.style===d||"object"!=typeof b.style)&&(b.style={classes:b.style}),a.each(g,function(){this.sanitize&&this.sanitize(b)}),b}function v(){v.history=v.history||[],v.history.push(arguments);if("object"==typeof console){var a=console[console.warn?"warn":"log"],b=Array.prototype.slice.call(arguments),c;typeof arguments[0]=="string"&&(b[0]="qTip2: "+b[0]),c=a.apply?a.apply(console,b):a(b)}}var b=!0,c=!1,d=null,e,f,g,h,i={},j="ui-tooltip",k="ui-widget",l="ui-state-disabled",m="div.qtip."+j,n=j+"-default",o=j+"-focus",p=j+"-hover",q=j+"-fluid",r="-31000px",s="_replacedByqTip",t="oldtitle",u;f=a.fn.qtip=function(g,h,i){var j=(""+g).toLowerCase(),k=d,l=a.makeArray(arguments).slice(1),m=l[l.length-1],n=this[0]?a.data(this[0],"qtip"):d;if(!arguments.length&&n||j==="api")return n;if("string"==typeof g)return this.each(function(){var d=a.data(this,"qtip");if(!d)return b;m&&m.timeStamp&&(d.cache.event=m);if(j!=="option"&&j!=="options"||!h)d[j]&&d[j].apply(d[j],l);else{if(!a.isPlainObject(h)&&i===e)return k=d.get(h),c;d.set(h,i)}}),k!==d?k:this;if("object"==typeof g||!arguments.length)return n=w(a.extend(b,{},g)),f.bind.call(this,n,m)},f.bind=function(d,j){return this.each(function(k){function r(b){function d(){p.render(typeof b=="object"||l.show.ready),m.show.add(m.hide).unbind(o)}if(p.cache.disabled)return c;p.cache.event=a.extend({},b),p.cache.target=b?a(b.target):[e],l.show.delay>0?(clearTimeout(p.timers.show),p.timers.show=setTimeout(d,l.show.delay),n.show!==n.hide&&m.hide.bind(n.hide,function(){clearTimeout(p.timers.show)})):d()}var l,m,n,o,p,q;q=a.isArray(d.id)?d.id[k]:d.id,q=!q||q===c||q.length<1||i[q]?f.nextid++:i[q]=q,o=".qtip-"+q+"-create",p=y.call(this,q,d);if(p===c)return b;l=p.options,a.each(g,function(){this.initialize==="initialize"&&this(p)}),m={show:l.show.target,hide:l.hide.target},n={show:a.trim(""+l.show.event).replace(/ /g,o+" ")+o,hide:a.trim(""+l.hide.event).replace(/ /g,o+" ")+o},/mouse(over|enter)/i.test(n.show)&&!/mouse(out|leave)/i.test(n.hide)&&(n.hide+=" mouseleave"+o),m.show.bind("mousemove"+o,function(a){h={pageX:a.pageX,pageY:a.pageY,type:"mousemove"},p.cache.onTarget=b}),m.show.bind(n.show,r),(l.show.ready||l.prerender)&&r(j)})},g=f.plugins={Corner:function(a){a=(""+a).replace(/([A-Z])/," $1").replace(/middle/gi,"center").toLowerCase(),this.x=(a.match(/left|right/i)||a.match(/center/)||["inherit"])[0].toLowerCase(),this.y=(a.match(/top|bottom|center/i)||["inherit"])[0].toLowerCase();var b=a.charAt(0);this.precedance=b==="t"||b==="b"?"y":"x",this.string=function(){return this.precedance==="y"?this.y+this.x:this.x+this.y},this.abbrev=function(){var a=this.x.substr(0,1),b=this.y.substr(0,1);return a===b?a:a==="c"||a!=="c"&&b!=="c"?b+a:a+b},this.clone=function(){return{x:this.x,y:this.y,precedance:this.precedance,string:this.string,abbrev:this.abbrev,clone:this.clone}}},offset:function(b,c){function j(a,b){d.left+=b*a.scrollLeft(),d.top+=b*a.scrollTop()}var d=b.offset(),e=b.closest("body")[0],f=c,g,h,i;if(f){do f.css("position")!=="static"&&(h=f.position(),d.left-=h.left+(parseInt(f.css("borderLeftWidth"),10)||0)+(parseInt(f.css("marginLeft"),10)||0),d.top-=h.top+(parseInt(f.css("borderTopWidth"),10)||0)+(parseInt(f.css("marginTop"),10)||0),!g&&(i=f.css("overflow"))!=="hidden"&&i!=="visible"&&(g=f));while((f=a(f[0].offsetParent)).length);g&&g[0]!==e&&j(g,1)}return d},iOS:parseFloat((""+(/CPU.*OS ([0-9_]{1,3})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_","."))||c,fn:{attr:function(b,c){if(this.length){var d=this[0],e="title",f=a.data(d,"qtip");if(b===e&&f&&"object"==typeof f&&f.options.suppress)return arguments.length<2?a.attr(d,t):(f&&f.options.content.attr===e&&f.cache.attr&&f.set("content.text",c),this.attr(t,c))}return a.fn["attr"+s].apply(this,arguments)},clone:function(b){var c=a([]),d="title",e=a.fn["clone"+s].apply(this,arguments);return b||e.filter("["+t+"]").attr("title",function(){return a.attr(this,t)}).removeAttr(t),e}}},a.each(g.fn,function(c,d){if(!d||a.fn[c+s])return b;var e=a.fn[c+s]=a.fn[c];a.fn[c]=function(){return d.apply(this,arguments)||e.apply(this,arguments)}}),a.ui||(a["cleanData"+s]=a.cleanData,a.cleanData=function(b){for(var c=0,d;(d=b[c])!==e;c++)try{a(d).triggerHandler("removeqtip")}catch(f){}a["cleanData"+s](b)}),f.version="nightly",f.nextid=0,f.inactiveEvents="click dblclick mousedown mouseup mousemove mouseleave mouseenter".split(" "),f.zindex=15e3,f.defaults={prerender:c,id:c,overwrite:b,suppress:b,content:{text:b,attr:"title",title:{text:c,button:c}},position:{my:"top left",at:"bottom right",target:c,container:c,viewport:c,adjust:{x:0,y:0,mouse:b,resize:b,method:"flip flip"},effect:function(b,d,e){a(this).animate(d,{duration:200,queue:c})}},show:{target:c,event:"mouseenter",effect:b,delay:90,solo:c,ready:c,autofocus:c},hide:{target:c,event:"mouseleave",effect:b,delay:0,fixed:c,inactive:c,leave:"window",distance:c},style:{classes:"",widget:c,width:c,height:c,def:b},events:{render:d,move:d,show:d,hide:d,toggle:d,visible:d,focus:d,blur:d}},g.ajax=function(a){var b=a.plugins.ajax;return"object"==typeof b?b:a.plugins.ajax=new z(a)},g.ajax.initialize="render",g.ajax.sanitize=function(a){var b=a.content,c;b&&"ajax"in b&&(c=b.ajax,typeof c!="object"&&(c=a.content.ajax={url:c}),"boolean"!=typeof c.once&&c.once&&(c.once=!!c.once))},a.extend(b,f.defaults,{content:{ajax:{loading:b,once:b}}}),g.tip=function(a){var b=a.plugins.tip;return"object"==typeof b?b:a.plugins.tip=new B(a)},g.tip.initialize="render",g.tip.sanitize=function(a){var c=a.style,d;c&&"tip"in c&&(d=a.style.tip,typeof d!="object"&&(a.style.tip={corner:d}),/string|boolean/i.test(typeof d.corner)||(d.corner=b),typeof d.width!="number"&&delete d.width,typeof d.height!="number"&&delete d.height,typeof d.border!="number"&&d.border!==b&&delete d.border,typeof d.offset!="number"&&delete d.offset)},a.extend(b,f.defaults,{style:{tip:{corner:b,mimic:c,width:6,height:6,border:b,offset:0}}})}),define("libs/jquery.qtip.min",function(){}),define("App",["core/FlxState","Addresses","ManageConnectors","AddConnectors","libs/jquery.form","libs/jquery.qtip.min"],function(FlxState,Addresses,ManageConnectors,AddConnectors){function initialize(){_.bindAll(this),loadApps()}function loadApps(){toLoad=FlxState.apps.length;for(var i=0;i<FlxState.apps.length;i++)require(["applications/"+FlxState.apps[i]+"/App"],function(app){apps[app.name]=app,app.initialize(),appLoaded(app.name)})}function createAppsMenu(appName,appIcon){for(var i=0;i<FlxState.apps.length;i++){var app=apps[FlxState.apps[i]];$("#apps-menu").append('<button id="'+app.name+'MenuButton" class="btn" '+"onclick=\"javascript:App.renderApp('"+app.name+"')\">"+'<i class="'+app.icon+'  icon-large"></i></button>')}}function appLoaded(appName){loaded++,loaded===toLoad&&(App.apps=apps,Backbone.history.start({pushState:!0}),renderMainApp())}function renderMainApp(){var parse_url=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,result=parse_url.exec(window.location.href),names=["url","scheme","slash","host","port","path","query","hash"],blanks=" ",i,parts={};for(i=0;i<names.length;i+=1)parts[names[i]]=result[i];var splits=parts.path.split("/");if(splits[0]==="app"&&typeof splits[1]!="undefined"){var appState=parts.path.substring("app/".length+splits[1].length+1),appName=splits[1];FlxState.saveState(appName,appState),typeof apps[appName]=="undefined"&&(console&&console.log&&console.log("invalid app: "+appName),App.invalidPath()),App.activeApp=apps[appName]}else App.activeApp=apps[FlxState.defaultApp],apps[FlxState.defaultApp].render("")}function fullHeight(){$(".fullHeight").length>0&&(tabsY=$("#tabs").position().top,windowHeight=$(window).height(),footerHeight=$("#footer").height(),fHeight=windowHeight-tabsY-footerHeight-20,$(".fullHeight").height(fHeight)),$(window).resize(function(){setTimeout(App.fullHeight,100)})}function renderApp(appName){App.activeApp.saveState(),App.activeApp=App.apps[appName],App.apps[appName].render("last")}function makeModal(html){$("#modal").replaceWith(html),$("#modal").modal()}function startsWith(s,prefix){return s.substr(0,prefix.length)===prefix}function carousel(photoId){$(".carousel-inner div.item").removeClass("active"),$(".carousel-inner #photo-"+photoId).addClass("active"),$("#modal").modal("show")}function invalidPath(){require(["text!applications/invalidPath.html"],function(html){$(".application").removeClass("active"),$(".application").addClass("dormant"),$("#applications").append(html)})}function getUsername(){return $("#flxUsername").html()}var App={},toLoad=0,loaded=0,apps={},compiledTemplates={};return App.settings=function(){$.ajax({url:"/settings/main",success:function(html){makeModal(html),$("#settingsForm").ajaxForm(function(){$("#modal").empty()})}})},App.makeModal=makeModal,App.carousel=carousel,App.loadMustacheTemplate=function(templatePath,templateId,onLoad){if(typeof compiledTemplates[templateId]!="undefined"){onLoad(compiledTemplates[templateId]);return}var that=this;require(["text!"+templatePath],function(template){var html=template,templateStartSearch='<template id="'+templateId+'">',htmlStart=html.indexOf(templateStartSearch);if(htmlStart==-1){onLoad(null);return}htmlStart+=templateStartSearch.length;var htmlEnd=html.indexOf("</template>",htmlStart);html=html.substring(htmlStart,htmlEnd),compiledTemplates[templateId]=Hogan.compile(html),onLoad(compiledTemplates[templateId])})},App.closeModal=function(){$("#modal").modal("hide")},App.eraseEverything=function(){var confirmed=confirm("Are you sure?")},App.connectors=function(){AddConnectors.show()},App.addresses=function(){Addresses.show()},App.manageConnectors=function(){ManageConnectors.show()},App.removeConnector=function(api){var c=confirm("If you wrote comments on events related to this connector, you will loose them forever.\nAre your sure you want to continue?");c&&$.ajax({url:"/connectors/removeConnector?api="+api,dataType:"json",success:function(data){data.result=="ok"&&($("#userConnectors").load("/connectors/userConnectors"),$("#availableConnectors").load("/connectors/availableConnectors"),App.showConnectorsPage(0))}})},App.addConnector=function(url){if(startsWith(url,"ajax:")){var savedConnectorContent=$(".addConnectorsMain").html();$.ajax({url:url.substring(5),success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}else{var loading=$("#loading").clone().show();$(".addConnectorsMain").empty(),$(".addConnectorsMain").append(loading),setTimeout("window.location='"+url+"'",500)}},App.showConnectorsPage=function(page){console.log("showing connectors page "+page),$("#availableConnectors").load("/connectors/availableConnectors?page="+page)},App.discardNotifications=function(){var ids=$("#notificationIds").html();$.ajax({url:"/notifications/discard?ids="+ids,success:function(){$("#notifications").alert("close")}})},App.showCarousel=function(photoId){$("#photosCarousel").length==0?$.ajax({url:"/tabs/photos/carousel",success:function(html){makeModal(html),carousel(photoId)}}):carousel(photoId)},App.formatDate=function(date,includeTime){includeTime==null&&(includeTime=!1),typeof date=="number"&&(date=new Date(date));if(isNaN(date.getFullYear()))return"Present";var value="";switch(date.getMonth()){case 0:value+="January";break;case 1:value+="February";break;case 2:value+="March";break;case 3:value+="April";break;case 4:value+="May";break;case 5:value+="June";break;case 6:value+="July";break;case 7:value+="August";break;case 8:value+="September";break;case 9:value+="October";break;case 10:value+="November";break;case 11:value+="December"}return value+=" "+date.getDate(),value+=", "+date.getFullYear(),includeTime&&(value+=" "+date.getHours(),value+=":",date.getMinutes()<10&&(value+="0"),value+=date.getMinutes(),value+=":",date.getSeconds()<10&&(value+="0"),value+=date.getSeconds()),value},App.formatMinuteOfDay=function(minuteOfDay){var hour=Math.floor(minuteOfDay/60),minutes=Math.floor(minuteOfDay%60);return minutes<10&&(minutes="0"+minutes),hour<12?(hour==0?12:hour)+":"+minutes+" AM":(hour>12?hour-12:12)+":"+minutes+" PM"},App.formatDateAsDatePicker=function(date){return typeof date=="number"&&(date=new Date(date)),isNaN(date.getFullYear())?"Present":date.getFullYear()+"-"+(date.getMonth()<9?"0":"")+(date.getMonth()+1)+"-"+(date.getDate()<9?"0":"")+date.getDate()},App.search=function(){$(".application").load("/search/0?q="+$(".search-query").val())},App.getUsername=getUsername,App.initialize=initialize,App.renderApp=renderApp,App.state=FlxState,App.fullHeight=fullHeight,App.invalidPath=invalidPath,App.geocoder=new google.maps.Geocoder,window.App=App,App}),define("Connectors",[],function(){function submitNikePlusCredentials(){var username=$("input#nikeplus-username").val();$.ajax({url:"/nikeplus/setUsername",type:"POST",data:{username:username},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}function submitToodledoCredentials(){var username=$("input#toodledo-username").val(),password=$("input#toodledo-password").val();$.ajax({url:"/toodledo/submitCredentials",type:"POST",data:{username:username,password:password},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}function submitZeoCredentials(){var username=$("input#zeo-username").val(),password=$("input#zeo-password").val();$.ajax({url:"/zeo/submitCredentials",type:"POST",data:{username:username,password:password},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}function submitWithingsUsernameAndPassword(){var username=$("input#withings-username").val(),password=$("input#withings-password").val();$.ajax({url:"/withings/setupWithings",type:"POST",data:{username:username,password:password},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}function submitSmsBackupFolderNames(){var smsFolderName=$("input#smsBackup-smsFolderName").val(),callLogFolderName=$("input#smsBackup-callLogFolderName").val();$.ajax({url:"/smsBackup/setFolderNames",type:"POST",data:{smsFolderName:smsFolderName,callLogFolderName:callLogFolderName},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}function submitSmsBackupUsernameAndPassword(){var username=$("input#smsBackup-username").val(),password=$("input#smsBackup-password").val();$.ajax({url:"/smsBackup/check",type:"POST",data:{username:username,password:password},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}function chooseWithingsUser(){var chosenUser=$("input#withings-chosenUser:checked").val();$.ajax({url:"/withings/chooseWithingsUser",type:"POST",data:{chosenUser:chosenUser},success:function(html){$(".addConnectorsMain").html(html)}})}function submitOpenPathKeypair(){var accessKey=$("input#openpath-accessKey").val(),secretKey=$("input#openpath-secretKey").val();$.ajax({url:"/openPath/check",type:"POST",data:{accessKey:accessKey,secretKey:secretKey},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})}var Connectors={};return Connectors.chooseWithingsUser=chooseWithingsUser,Connectors.submitSmsBackupUsernameAndPassword=submitSmsBackupUsernameAndPassword,Connectors.submitSmsBackupFolderNames=submitSmsBackupFolderNames,Connectors.submitWithingsUsernameAndPassword=submitWithingsUsernameAndPassword,Connectors.submitZeoCredentials=submitZeoCredentials,Connectors.submitToodledoCredentials=submitToodledoCredentials,Connectors.submitNikePlusCredentials=submitNikePlusCredentials,Connectors.submitOpenPathKeypair=submitOpenPathKeypair,Connectors.submitBodytrackCredentials=function(){var username=$("input#bodytrack-username").val(),password=$("input#bodytrack-password").val(),host=$("input#bodytrack-host").val();$.ajax({url:"/bodytrack/submitCredentials",type:"POST",data:{username:username,password:password,host:host},success:function(html){$(".addConnectorsMain").html(html),$(".focushere").focus()}})},window.Connectors=Connectors,Connectors}),function(){var k=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,o=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,i=typeof location!="undefined"&&location.href,p=i&&location.protocol&&location.protocol.replace(/\:/,""),q=i&&location.hostname,r=i&&(location.port||void 0),j=[];define("text",[],function(){var g,h,l;return typeof window!="undefined"&&window.navigator&&window.document?h=function(a,c){var b=g.createXhr();b.open("GET",a,!0),b.onreadystatechange=function(){b.readyState===4&&c(b.responseText)},b.send(null)}:typeof process!="undefined"&&process.versions&&process.versions.node?(l=require.nodeRequire("fs"),h=function(a,c){var b=l.readFileSync(a,"utf8");b.indexOf("﻿")===0&&(b=b.substring(1)),c(b)}):typeof Packages!="undefined"&&(h=function(a,c){var b=new java.io.File(a),e=java.lang.System.getProperty("line.separator"),b=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(b),"utf-8")),d,f,g="";try{d=new java.lang.StringBuffer,(f=b.readLine())&&f.length()&&f.charAt(0)===65279&&(f=f.substring(1));for(d.append(f);(f=b.readLine())!==null;)d.append(e),d.append(f);g=String(d.toString())}finally{b.close()}c(g)}),g={version:"1.0.7",strip:function(a){if(a){var a=a.replace(n,""),c=a.match(o);c&&(a=c[1])}else a="";return a},jsEscape:function(a){return a.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")},createXhr:function(){var a,c,b;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;for(c=0;c<3;c++){b=k[c];try{a=new ActiveXObject(b)}catch(e){}if(a){k=[b];break}}if(!a)throw Error("createXhr(): XMLHttpRequest not available");return a},get:h,parseName:function(a){var c=!1,b=a.indexOf("."),e=a.substring(0,b),a=a.substring(b+1,a.length),b=a.indexOf("!");return b!==-1&&(c=a.substring(b+1,a.length),c=c==="strip",a=a.substring(0,b)),{moduleName:e,ext:a,strip:c}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(a,c,b,e){var d=g.xdRegExp.exec(a),f;return d?(a=d[2],d=d[3],d=d.split(":"),f=d[1],d=d[0],(!a||a===c)&&(!d||d===b)&&(!f&&!d||f===e)):!0},finishLoad:function(a,c,b,e,d){b=c?g.strip(b):b,d.isBuild&&(j[a]=b),e(b)},load:function(a,c,b,e){if(e.isBuild&&!e.inlineText)b();else{var d=g.parseName(a),f=d.moduleName+"."+d.ext,m=c.toUrl(f),h=e&&e.text&&e.text.useXhr||g.useXhr;!i||h(m,p,q,r)?g.get(m,function(c){g.finishLoad(a,d.strip,c,b,e)}):c([f],function(a){g.finishLoad(d.moduleName+"."+d.ext,d.strip,a,b,e)})}},write:function(a,c,b){if(c in j){var e=g.jsEscape(j[c]);b.asModule(a+"!"+c,"define(function () { return '"+e+"';});\n")}},writeFile:function(a,c,b,e,d){var c=g.parseName(c),f=c.moduleName+"."+c.ext,h=b.toUrl(c.moduleName+"."+c.ext)+".js";g.load(f,b,function(){var b=function(a){return e(h,a)};b.asModule=function(a,b){return e.asModule(a,h,b)},g.write(a,f,b,d)},d)}}})}(),define("text!connectorMgmtTemplates.html",[],function(){return'<template id="manageConnectors">\n    <div class="modal fade" id="modal" style="width:1010px; margin-left:-505px;">\n        <div class="modal-header">\n            <h3>Manage Connectors<a href="#" class="close" data-dismiss="modal">&times;</a></h3>\n        </div>\n        <div class="modal-body">\n            <div class="row">\n                <div class="span10">\n                    <div class="synchAll">\n                        <span>Though your data are supposedly up to date, you might want to <a id="sync-all" href="#" class="btn btn-info">sync all your devices now <i class="icon-refresh"></i></a></span>\n                    </div>\n                </div>\n            </div>\n            <div class="row">\n                <div class="span10">\n                    <table class="table manageConnectors">\n                        <thead>\n                        <tr>\n                            <th class="syncStatus">Sync status</th>\n                            <th class="connectors">Connectors</th>\n                            <th class="desc">Description</th>\n                            <th class="lastSync">Last Sync.</th>\n                            <th class="latestData">Latest Data</th>\n                            <th class="remove">Remove</th>\n                        </tr>\n                        </thead>\n                        <tbody>\n                        {{#connectors}}\n                        <tr id="connector-{{connectorName}}" {{#syncing}}class="nowSynchro"{{/syncing}}>\n                            <td class="syncStatus">\n                                <span id="syncLED-{{connectorName}}" class="syncLED-{{^errors}}yes{{/errors}}{{#errors}}no{{/errors}}" {{#syncing}}style="display:none;"{{/syncing}}></span>\n                                {{#syncing}}\n                                <span class="syncLED-waiting">\n                                    <img src="/css/devicesPictures/load.gif" alt="load">\n                                </span>\n                                {{/syncing}}\n                            </td>\n                            <td class="connectors"><img src="{{image}}" alt="{{connectorName}}"></td>\n                            <td class="desc"><h4>{{name}}</h4><p>{{text}}</p><a href="#">Manage <i class="icon-cog"></i></a></td>\n                            <td class="lastSync">\n                                <p id="lastSync-{{connectorName}}" {{#syncing}}style="display:none;"{{/syncing}}>{{lastSync}}</p>\n                                <a id="syncNow-{{connectorName}}" href="#" {{#syncing}}style="display:none;"{{/syncing}}>Sync now <i class="icon-refresh"></i></a>\n                                {{#syncing}}\n                                <p>Now synchronizing</p>\n                                <span>Sync now <i class="icon-refresh"></i></span>\n                                {{/syncing}}\n                            </td>\n                            <td class="latestData"><p>{{latestData}}</p><a href="#">View graph <i class="icon-bar-chart"></i></a></td>\n                            <td class="remove"><a id="remove-{{connectorName}}" href="#"><i class="icon-trash"></i></a></td>\n                        </tr>\n                        {{/connectors}}\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n        </div>\n        <div class="modal-footer">\n            <button class="btn" onclick="App.closeModal()">Close</button>\n        </div>\n    </div>\n</template>\n<template id="deleteConnectorConfirm">\n    <div class="modal fade" id="modal">\n        <div class="modal-header">\n            <h3>Confirm Removal<a href="#" class="close" data-dismiss="modal">&times;</a></h3>\n        </div>\n        <div class="modal-body" style="overflow:hidden">\n            <div class="alert alert-block"><h4 class="alert-heading">Warning!</h4>\n                You are about to remove {{name}} from your connectors. Are you sure you would like to remove this connector?\n            </div>\n        </div>\n        <div class="modal-footer">\n            <button id="confirmDeleteBtn" class="btn">Confirm</button>\n            <button class="btn" onclick="App.closeModal()">Cancel</button>\n        </div>\n    </div>\n</template>\n<template id="addConnectors">\n\n    <div id="modal" class="modal hide fade" style="width: 650px">\n\n        <div class="modal-header">\n            <a class="close" data-dismiss="modal">&times;</a>\n            <h3>Add Connectors</h3>\n        </div>\n\n        <div class="modal-body">\n            <div class="addConnectorsMain">\n\n                <div id="availableConnectors">\n                    {{#rows}}\n                    <div class="row-fluid">\n                        {{#connectors}}\n                        <div class="span4">\n                            <a  href="javascript:App.addConnector(\'{{connectUrl}}\')">\n                                <img src="{{image}}" alt="" width=178 Height=120>\n                            </a>\n                            <p>{{text}}</p>\n                        </div>\n                        {{/connectors}}\n                    </div>\n                    {{/rows}}\n                </div>\n\n            </div>\n        </div>\n        <div class="modal-footer">\n            <a class="btn" href="javascript:App.closeModal();">Close</a>\n        </div>\n    </div>\n\n</template>'}),define("text!addressesTemplate.html",[],function(){return'<template id="addAddress">\n    <div class="modal fade" id="modal">\n        <div class="modal-header">\n            <h3>{{title}}<a href="#" class="close" data-dismiss="modal">&times;</a></h3>\n        </div>\'\n        <div class="modal-body" style="overflow:hidden">\n            <form class="form-horizontal">\n                <fieldset>\n                    <div class="control-group">\n                        <label class="control-label">Address</label>\n                        <div class="controls">\n                            <input id="addressInput" type="text" class="input-xlarge span3">&nbsp;<a id="addressSearch" class="btn">Search</a>\n                            <br>\n                            <br>\n                            <select id="addressSelect" class="input-xlarge">\n                                <option style="display: none;">Select an address</option>\n                            </select>\n                        </div>\n                    </div>\n                    <div class="control-group">\n                        <label class="control-label">Radius</label>\n                        <div class="controls">\n                            <input id="radiusInput" type="text" class="input-xlarge span3"><span>&nbsp;{{distanceUnit}}</span>\n                        </div>\n                    </div>\n                    <div class="control-group">\n                        <label class="control-label">Since</label>\n                        <div class="controls">\n                            <input id="sinceInput" type="text" class="input-xlarge span3" data-date-format="yyyy-mm-dd" value="{{sinceDate}}">\n                        </div>\n                    </div>\n                    <div class="control-group">\n                        <label class="control-label">Until</label>\n                        <div class="controls">\n                            <input id="untilInput" type="text" class="input-xlarge span3" data-date-format="yyyy-mm-dd" value="{{untilDate}}">\n                            <label class="checkbox" style="display: inline-block;padding-left: 24px;">\n                                <input id="presentCheckBox" type="checkbox">&nbsp;Present\n                            </label>\n                        </div>\n                    </div>\n                    <div class="control-group"><label class="control-label">Type</label>\n                        <div class="controls">\n                            <select id="addressTypeSelect" class="input-xlarge">\n                                <option>Other</option>\n                                <option>Home</option>\n                                <option>Work</option>\n                            </select>\n                        </div>\n                    </div>\n                </fieldset>\n            </form>\n        </div>\n        <div class="modal-footer">\n            <button id="saveAddressBtn" class="btn">Save</button>\n            <button id="closeBtn" class="btn" onclick="App.closeModal();">Cancel</button>\n        </div>\n    </div>\n</template>\n<template id="addressesDialog">\n    <div style="width:80%; margin-left:-40%;" class="modal fade" id="modal">\n        <div class="modal-header">\n            <h3>Addresses<a href="#" class="close" data-dismiss="modal">&times;</a></h3>\n        </div>\n        <div class="modal-body" style="overflow:hidden">\n            <table class="table table-striped">\n                <thead>\n                    <tr>\n                        <th>Address</th>\n                        <th>Radius</th>\n                        <th>Type</th>\n                        <th>Since</th>\n                        <th>Until</th>\n                        <th style="text-align:center">Edit</th>\n                        <th style="text-align:center">Delete</th>\n                    </tr>\n                </thead>\n                <tbody>\n                {{#addresses}}\n                <tr>\n                <td>{{address}}</td>\n                <td>{{radius}}</td>\n                <td>{{type}}</td>\n                <td>{{since}}</td>\n                <td>{{until}}</td>\n                <td style="text-align:center"><button style="background-color:transparent; border:none;" class="icon-pencil icon-large" id="edit-{{index}}"></button></td>\n                <td style="text-align:center"><button style="background-color:transparent;border:none;" class="icon-trash icon-large" id="delete-{{index}}"></button></td>\n                </tr>\n                {{/addresses}}\n                </tbody>\n            </table>\n        </div>\n        <div class="modal-footer">\n            <button id="addAddress" class="btn">Add Address</button>\n            <button class="btn" onclick="App.closeModal()">Close</button>\n        </div>\n    </div>\n</template>\n<template id="deleteAddressConfirm">\n    <div class="modal fade" id="modal">\n        <div class="modal-header">\n            <h3>Confirm Deletion<a href="#" class="close" data-dismiss="modal">&times;</a></h3>\n        </div>\n        <div class="modal-body" style="overflow:hidden">\n            <div class="alert alert-block"><h4 class="alert-heading">Warning!</h4>\n                You are about to delete {{address}} from your addresses. This action cannot be undone. Are you sure you would like to delete this address?\n            </div>\n        </div>\n        <div class="modal-footer">\n            <button id="confirmDeleteBtn" class="btn">Confirm</button>\n            <button class="btn" onclick="App.closeModal()">Cancel</button>\n        </div>\n    </div>\n</template>'}),define("text!applications/calendar/facetTemplates.html",[],function(){return'<template id="twitter-tweet">\n    <h3 class="flx-dataType">Tweet</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{profileImageUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="twitter-mention">\n    <h3 class="flx-dataType">{{userName}} Mentioned You</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{profileImageUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="twitter-dm">\n    <h3 class="flx-dataType">{{sender}} Messaged {{receiver}}</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{profileImageUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="google_calendar-entry">\n    <h3 class="flx-dataType">Calendar</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{profileImageUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="lastfm-loved_track">\n    <h3 class="flx-dataType">Loved Track</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{imgUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="lastfm-recent_track">\n    <h3 class="flx-dataType">Track</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{imgUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="fitbit-activity_summary">\n    <h3 class="flx-dataType">Activity Summary</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{photoUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-data">{{steps}} steps taken</span>\n        <span class="flx-data">{{caloriesOut}} calories burned</span>\n    </div>\n</template>\n<template id="picasa-photo">\n    <h3 class="flx-dataType">Photo</h3>\n    <span class="flx-deviceIcon" style="background:url(\'{{photoUrl}}\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime">{{time}}</span>\n        <span class="flx-data">{{description}}</span>\n    </div>\n</template>\n<template id="fluxtream-address">\n    <h3 class="flx-dataType">{{type}} Address</h3>\n    <span class="flx-deviceIcon" style="background:url(\'\'); background-size:100% 100%;"></span>\n    <div class="flx-deviceData">\n        <span class="flx-tTime"></span>\n        <span class="flx-data">{{address}}</span>\n    </div>\n</template>'}),define("text!applications/calendar/tabs/clock/clockTemplate.html",[],function(){return'<template id="tooltip">\n    <div class="flx-clockToolTipContainer" notthide="true">\n        <div class="flx-toolTipBody strongBorder-{{orientation}}" style="border-color:{{color}}"> <!-- JS : Append strongBorder class with -Top, -Left, -Right, Bottom according to toolTip position / Append the right color class to override default -->\n            <span class="flx-toolTipTail-{{orientation}}" style="border-{{oppositeOrientation}}-color:{{color}}"></span> <!-- JS : Append class with -Top, -Left or -Right to change tail direction + define top/bottom/right/left arguments in the style attribute to give the tail it\'s position -->\n            <div class="listViewItem facet-<%=facet.type%>" id="<%=facet.type%>_<%=facet.id%>">\n                <div class="flx-toolTipData">\n                    {{{tooltipData}}}\n                    <ul class="flx-toolTipLinks">\n                        <li><a href="#">List <i class="icon-list"></i></a></li>\n                        <li><a href="#">Timeline <i class="icon-film"></i></a></li>\n                        <li><a href="#">Bodytrack <i class="icon-bookmark"></i></a></li>\n                    </ul>\n                </div>\n\n            </div>\n\n\n            <div class="flx-toolTipContext">\n                <div class="flx-toolTipLocation">\n                    <h4><span>{{time}}</span> last seen here: <strong id="lastSeenLocation"></strong></h4>\n                    <div>\n                        <div id="mapPlaceHolder" style="display:inline-block; width:200px; height:188px; position:relative;"></div>\n                    </div>\n                </div>\n                <div class="flx-toolTipWeather">\n                    <h4><span>{{temperature}}°{{temperatureUnit}}</span> {{weatherDescription}}</h4>\n                    <div class="weatherIcon">\n                        <img src="{{weatherIcon}}" style="width:100px; height:104px;"/>\n                    </div>\n                    <ul class="flx-weatherDetails">\n                        <li>Windspeed <span>{{windSpeed}} {{windSpeedUnit}}</span></li>\n                        <li>Humidity <span>{{humidity}}%</span></li>\n                        <li>Precipitation <span>{{precipitation}} {{precipitationUnit}}</span></li>\n                    </ul>\n                </div>\n            </div>\n        </div>\n    </div>\n</template>'}),define("text!applications/calendar/tabs/photos/photosTemplate.html",[],function(){return'<template id="carousel">\n    <div class="modal fade" id="modal">\n        <div class="modal-header">\n            <h3>&nbsp;<a href="#" class="close" data-dismiss="modal">&times;</a></h3>\n        </div>\n        <div class="modal-body" style="overflow:hidden">\n            <div id="photosCarousel" class="carousel">\n                <div class="carousel-inner">\n                    {{#photos}}\n                    <div id="photo-{{id}}" style="text-align:center;" class="item{{#active}} active{{/active}}" style="overflow:none">\n                        <img style="display:inline-block" src="{{photoUrl}}">\n                    </div>\n                    {{/photos}}\n                </div>\n                {{#includeNav}}\n                <a class="carousel-control left" href="#photosCarousel" data-slide="prev">&lsaquo;</a>\n                <a class="carousel-control right" href="#photosCarousel" data-slide="next">&rsaquo;</a>\n                {{/includeNav}}\n            </div>\n            <div class="modal-footer">\n                <button class="btn" onclick="App.closeModal();">Close</button>\n            </div>\n        </div>\n    </div>\n</template>\n<template id="thumbnailGroup">\n    <hr>\n    <div>\n        {{date}}\n    </div>\n    <div class=\'thumbnailGroup\'>\n        {{#photos}}\n        <div id="photo-{{id}}" class=\'thumbnailContainer\'>\n            <div class=\'photoThumbnail\' style=\'background-image: url({{photoUrl}})\'></div>\n        </div>\n        {{/photos}}\n    </div>\n</template>'}),define("text!applications/calendar/tabs/timeline/timelineTemplates.html",[],function(){return'<template id="loadViewsDropdown">\n    <ul class="dropdown-menu load-view-subMenu" id="_timeline_load_view_submenu">\n        {{#availableList}}\n        {{^first}}\n        <li class="divider"></li>\n        {{/first}}\n        <li class="flx-clearfix">\n            <div class="flx-floatL view-id">\n                <a viewId="{{id}}" href="#" class="_timeline_load_link">\n                    <h4>{{name}}</h4>\n                    <p>{{description}}</p>\n                </a>\n            </div>\n            <ul class="flx-floater view-filters">\n                <li><a viewId="{{id}}" href="#" class="_timeline_load_link _timeline_time_only">Time only <i class="icon-time"></i></a></li>\n                <li><a viewId="{{id}}" href="#" class="_timeline_load_link _timeline_channel_only">Channel only <i class="icon-list"></i></a></li>\n            </ul>\n        </li>\n        {{/availableList}}\n    </ul>\n</template>\n<template id="saveViewDropdown">\n    <ul id="_timeline_save_view_dropdown-submenu" class="dropdown-menu">\n        <li>\n            <form>\n                <input id="_timeline_save_view_dropdown_name" type="text" title="insert view name" style="display:inline">\n                <a id="_timeline_save_view_dropdown_save_btn" href="#" class="btn btn-mini">save</a>\n            </form>\n            {{#viewsPresent}}\n            <h5>Or save as one of the views bellow</h5>\n            {{/viewsPresent}}\n        </li>\n        {{#availableList}}\n        <li class="divider"></li>\n        <li>\n            <a viewname="{{name}}" class="_timeline_save_view_dropdown_save_link" class="savedView" href="#">\n                <div><h4>{{name}}</h4><p>{{last_used}}</p></div>\n                <div>{{description}}</div>\n            </a>\n        </li>\n        {{/availableList}}\n    </ul>\n</template>'}),define("core/Application",["core/FlxState"],function(FlxState){function Application(name,author,icon){this.name=name,this.author=author,this.icon=icon}return Application.prototype.destroy=function(){},Application.prototype.render=function(state){$("#"+this.name+"MenuButton").button("toggle"),state==="last"&&(state=FlxState.getState(this.name)),that=this;var nextAppId=this.name+"-app",nextAppDiv=$("#"+nextAppId),noApp=$(".application").length==0,appChanged=$(".application").length>0&&$(".application.active").length>0&&$(".application.active").attr("id")!=nextAppId;if(noApp||appChanged){typeof App.activeApp!="undefined"&&App.activeApp.destroy();if(appChanged){var currentAppDiv=$(".application.active");currentAppDiv.removeClass("active"),currentAppDiv.addClass("dormant")}nextAppDiv.length==0?require(["text!applications/"+this.name+"/template.html"],function(html){html='<div class="application active" id="'+nextAppId+'">'+html+"</div>",$("#applications").append(html),App.activeApp=App.apps[that.name],App.activeApp.renderState(state,!0),App.activeApp.setup()}):(nextAppDiv.removeClass("dormant"),nextAppDiv.addClass("active"))}else this.renderState(state,!0)},Application.prototype.saveState=function(){},Application.prototype.setup=function(){},Application.prototype.renderState=function(state){},Application}),define("applications/calendar/Builder",[],function(){function capitalizeFirstLetter(string){return string.charAt(0).toUpperCase()+string.slice(1)}function createTabs(Calendar){$("#calendarTabs").empty();for(var i=0;i<tabs[Calendar.timeUnit].length;i++){var tab='<li style="cursor:pointer">';tab+='<a class="'+tabs[Calendar.timeUnit][i]+'-tab" tabname="'+tabs[Calendar.timeUnit][i]+'" data-toggle="tab">'+'<i class="'+tab_icons[tabs[Calendar.timeUnit][i]]+'"></i> '+capitalizeFirstLetter(tabs[Calendar.timeUnit][i])+"</a></li>",tab=$(tab),$("#calendarTabs").append(tab),$(tab.children()[0]).click(function(event){event.preventDefault();var tab=$(event.delegateTarget).attr("tabname");if(typeof tab=="undefined")return;var state=App.state.getState("calendar");state=state.substring(state.indexOf("/")),Calendar.renderState(tab+state)})}var t=tabExistsForTimeUnit(Calendar.currentTabName,Calendar.timeUnit)?Calendar.currentTabName:tabs[Calendar.timeUnit][0],currentTab="#calendarTabs a."+t+"-tab";$(currentTab).tab("show")}function bindTimeUnitsMenu(Calendar){var timeUnitIds={"#dayViewBtn":1,"#weekViewBtn":2,"#yearViewBtn":4};for(var timeUnitId in timeUnitIds){var btn=$(timeUnitId);btn.attr("unit")==Calendar.timeUnit?btn.addClass("active"):btn.removeClass("active"),btn.unbind("click"),btn.click(function(event){var timeUnit=$(event.target).attr("unit"),url="/nav/set"+capitalizeFirstLetter(timeUnit.toLowerCase())+"TimeUnit.json";$.ajax({url:url,success:function(response){var t=tabExistsForTimeUnit(Calendar.currentTabName,timeUnit)?Calendar.currentTabName:tabs[timeUnit][0];Calendar.currentTabName=t,Calendar.updateButtonStates(),Calendar.renderState(Calendar.currentTabName+"/"+response.state)},error:function(){alert("error")}})})}bindTimeNavButtons(Calendar)}function bindTimeNavButtons(Calendar){switch(Calendar.timeUnit){case"DAY":nextPrevEnable();break;case"WEEK":nextPrevEnable();break;case"YEAR":nextPrevEnable()}}function nextPrevEnable(){$(".menuNextButton").removeClass("disabled"),$(".menuPrevButton").removeClass("disabled")}function timeNavBtn(Calendar,downOrUp,enabled,targetTimeUnit){var button=$(".menu"+capitalizeFirstLetter(downOrUp)+"Button");button.unbind(),enabled?(button.removeClass("disabled"),button.click(function(event){var timeUnit=$(event.target).attr("class"),url="/nav/set"+capitalizeFirstLetter(targetTimeUnit.toLowerCase())+"TimeUnit.json";$.ajax({url:url,success:function(response){Calendar.renderState(Calendar.currentTabName+"/"+response.state)},error:function(){alert("error")}})})):button.addClass("disabled")}function handleNotifications(digestInfo){$(".notification").remove(),$("#notificationIds").empty();if(typeof digestInfo.notifications!="undefined"){$(".alert-message").addClass("success");for(n=0;n<digestInfo.notifications.length;n++){var notification=digestInfo.notifications[n];$("#notifications").append('<p class="notification">'+notification.message+"</p>"),n>0&&$("#notificationIds").append(","),$("#notificationIds").append(notification.id)}$("#notifications").show()}}function updateTab(digest,Calendar){handleNotifications(digest),tabs[Calendar.currentTabName]==null?require(["applications/calendar/tabs/"+Calendar.currentTabName+"/"+capitalizeFirstLetter(Calendar.currentTabName)+"Tab"],function(tab){tabs[Calendar.currentTavName]=tab,renderTab(tab,digest,Calendar)}):renderTab(tabs[Calendar.currentTabName],digest,Calendar)}function renderTab(tab,digest,Calendar){var currentTab="#calendarTabs a."+Calendar.currentTabName+"-tab";$(currentTab).tab("show"),tab.render(digest,Calendar.timeUnit,Calendar.tabState,Calendar.connectorEnabled[Calendar.currentTabName]),Calendar.currentTab=tab}function tabExistsForTimeUnit(tab,unit){var tabExistsForTimeUnit=!1;for(var i=0;i<tabs[unit].length;i++)tabs[unit][i]===tab&&(tabExistsForTimeUnit=!0);return tabExistsForTimeUnit}function isValidTabName(tabName){for(var name in tab_icons)if(name===tabName)return!0;return!1}function isValidTimeUnit(timeUnit){return timeUnit==="date"||timeUnit==="week"||timeUnit==="month"||timeUnit==="year"}var Builder={},tabs={},tabs={DAY:["clock","dashboards","map","photos","list","timeline"],WEEK:["dashboards","map","photos","list","timeline"],YEAR:["photos"]},tab_icons={clock:"icon-time",dashboards:"icon-dashboard",map:"icon-map-marker",diary:"icon-pencil",photos:"icon-camera",views:"icon-eye-open",list:"icon-list",timeline:"icon-film"};return Builder.tabExistsForTimeUnit=tabExistsForTimeUnit,Builder.tabs=tabs,Builder.bindTimeUnitsMenu=bindTimeUnitsMenu,Builder.createTabs=createTabs,Builder.updateTab=updateTab,Builder.isValidTabName=isValidTabName,Builder.isValidTimeUnit=isValidTimeUnit,Builder}),function($){var Datepicker=function(element,options){this.element=$(element),this.format=DPGlobal.parseFormat(options.format||this.element.data("date-format")||"mm/dd/yyyy"),this.picker=$(DPGlobal.template).appendTo("body").on({click:$.proxy(this.click,this),mousedown:$.proxy(this.mousedown,this)}),this.isInput=this.element.is("input"),this.component=this.element.is(".date")?this.element.find(".add-on"):!1,this.isInput?this.element.on({focus:$.proxy(this.show,this),blur:$.proxy(this.hide,this),keyup:$.proxy(this.update,this)}):this.component?this.component.on("click",$.proxy(this.show,this)):this.element.on("click",$.proxy(this.show,this)),this.viewMode=0,this.weekStart=options.weekStart||this.element.data("date-weekstart")||0,this.weekEnd=this.weekStart==0?6:this.weekStart-1,this.fillDow(),this.fillMonths(),this.update(),this.showMode()};Datepicker.prototype={constructor:Datepicker,show:function(e){this.picker.show(),this.height=this.component?this.component.outerHeight():this.element.outerHeight(),this.place(),$(window).on("resize",$.proxy(this.place,this)),e&&(e.stopPropagation(),e.preventDefault()),this.isInput||$(document).on("mousedown",$.proxy(this.hide,this)),this.element.trigger({type:"show",date:this.date})},hide:function(){this.picker.hide(),$(window).off("resize",this.place),this.viewMode=0,this.showMode(),this.isInput||$(document).off("mousedown",this.hide),this.setValue(),this.element.trigger({type:"hide",date:this.date})},setValue:function(){var formated=DPGlobal.formatDate(this.date,this.format);this.isInput?this.element.prop("value",formated):(this.component&&this.element.find("input").prop("value",formated),this.element.data("date",formated))},place:function(){var offset=this.component?this.component.offset():this.element.offset();this.picker.css({top:offset.top+this.height,left:offset.left})},update:function(){this.date=DPGlobal.parseDate(this.isInput?this.element.prop("value"):this.element.data("date"),this.format),this.viewDate=new Date(this.date),this.fill()},fillDow:function(){var dowCnt=this.weekStart,html="<tr>";while(dowCnt<this.weekStart+7)html+='<th class="dow">'+DPGlobal.dates.daysMin[dowCnt++%7]+"</th>";html+="</tr>",this.picker.find(".datepicker-days thead").append(html)},fillMonths:function(){var html="",i=0;while(i<12)html+='<span class="month">'+DPGlobal.dates.monthsShort[i++]+"</span>";this.picker.find(".datepicker-months td").append(html)},fill:function(){var d=new Date(this.viewDate),year=d.getFullYear(),month=d.getMonth(),currentDate=this.date.valueOf();this.picker.find(".datepicker-days th:eq(1)").text(DPGlobal.dates.months[month]+" "+year);var prevMonth=new Date(year,month-1,28,0,0,0,0),day=DPGlobal.getDaysInMonth(prevMonth.getFullYear(),prevMonth.getMonth());prevMonth.setDate(day),prevMonth.setDate(day-(prevMonth.getDay()-this.weekStart+7)%7);var nextMonth=new Date(prevMonth);nextMonth.setDate(nextMonth.getDate()+42),nextMonth=nextMonth.valueOf(),html=[];var clsName;while(prevMonth.valueOf()<nextMonth)prevMonth.getDay()==this.weekStart&&html.push("<tr>"),clsName="",prevMonth.getMonth()<month?clsName+=" old":prevMonth.getMonth()>month&&(clsName+=" new"),prevMonth.valueOf()==currentDate&&(clsName+=" active"),html.push('<td class="day'+clsName+'">'+prevMonth.getDate()+"</td>"),prevMonth.getDay()==this.weekEnd&&html.push("</tr>"),prevMonth.setDate(prevMonth.getDate()+1);this.picker.find(".datepicker-days tbody").empty().append(html.join(""));var currentYear=this.date.getFullYear(),months=this.picker.find(".datepicker-months").find("th:eq(1)").text(year).end().find("span").removeClass("active");currentYear==year&&months.eq(this.date.getMonth()).addClass("active"),html="",year=parseInt(year/10,10)*10;var yearCont=this.picker.find(".datepicker-years").find("th:eq(1)").text(year+"-"+(year+9)).end().find("td");year-=1;for(var i=-1;i<11;i++)html+='<span class="year'+(i==-1||i==10?" old":"")+(currentYear==year?" active":"")+'">'+year+"</span>",year+=1;yearCont.html(html)},click:function(e){e.stopPropagation(),e.preventDefault();var target=$(e.target).closest("span, td, th");if(target.length==1)switch(target[0].nodeName.toLowerCase()){case"th":switch(target[0].className){case"switch":this.showMode(1);break;case"prev":case"next":this.viewDate["set"+DPGlobal.modes[this.viewMode].navFnc].call(this.viewDate,this.viewDate["get"+DPGlobal.modes[this.viewMode].navFnc].call(this.viewDate)+DPGlobal.modes[this.viewMode].navStep*(target[0].className=="prev"?-1:1)),this.fill()}break;case"span":if(target.is(".month")){var month=target.parent().find("span").index(target);this.viewDate.setMonth(month)}else{var year=parseInt(target.text(),10)||0;this.viewDate.setFullYear(year)}this.showMode(-1),this.fill();break;case"td":if(target.is(".day")){var day=parseInt(target.text(),10)||1,month=this.viewDate.getMonth();target.is(".old")?month-=1:target.is(".new")&&(month+=1);var year=this.viewDate.getFullYear();this.date=new Date(year,month,day,0,0,0,0),this.viewDate=new Date(year,month,day,0,0,0,0),this.fill(),this.setValue(),this.element.trigger({type:"changeDate",date:this.date})}}},mousedown:function(e){e.stopPropagation(),e.preventDefault()},showMode:function(dir){dir&&(this.viewMode=Math.max(0,Math.min(2,this.viewMode+dir))),this.picker.find(">div").hide().filter(".datepicker-"+DPGlobal.modes[this.viewMode].clsName).show()}},$.fn.datepicker=function(option){return this.each(function(){var $this=$(this),data=$this.data("datepicker"),options=typeof option=="object"&&option;data||$this.data("datepicker",data=new Datepicker(this,$.extend({},$.fn.datepicker.defaults,options))),typeof option=="string"&&data[option]()})},$.fn.datepicker.defaults={},$.fn.datepicker.Constructor=Datepicker;var DPGlobal={modes:[{clsName:"days",navFnc:"Month",navStep:1},{clsName:"months",navFnc:"FullYear",navStep:1},{clsName:"years",navFnc:"FullYear",navStep:10}],dates:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},isLeapYear:function(year){return year%4===0&&year%100!==0||year%400===0},getDaysInMonth:function(year,month){return[31,DPGlobal.isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month]},parseFormat:function(format){var separator=format.match(/[.\/-].*?/),parts=format.split(/\W+/);if(!separator||!parts||parts.length==0)throw new Error("Invalid date format.");return{separator:separator,parts:parts}},parseDate:function(date,format){var parts=date.split(format.separator),date=new Date(1970,1,1,0,0,0),val;if(parts.length==format.parts.length)for(var i=0,cnt=format.parts.length;i<cnt;i++){val=parseInt(parts[i],10)||1;switch(format.parts[i]){case"dd":case"d":date.setDate(val);break;case"mm":case"m":date.setMonth(val-1);break;case"yy":date.setFullYear(2e3+val);break;case"yyyy":date.setFullYear(val)}}return date},formatDate:function(date,format){var val={d:date.getDate(),m:date.getMonth()+1,yy:date.getFullYear().toString().substring(2),yyyy:date.getFullYear()};val.dd=(val.d<10?"0":"")+val.d,val.mm=(val.m<10?"0":"")+val.m;var date=[];for(var i=0,cnt=format.parts.length;i<cnt;i++)date.push(val[format.parts[i]]);return date.join(format.separator)},headTemplate:'<thead><tr><th class="prev"><i class="icon-arrow-left"/></th><th colspan="5" class="switch"></th><th class="next"><i class="icon-arrow-right"/></th></tr></thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>'};DPGlobal.template='<div class="datepicker dropdown-menu"><div class="datepicker-days"><table class=" table-condensed">'+DPGlobal.headTemplate+"<tbody></tbody>"+"</table>"+"</div>"+'<div class="datepicker-months">'+'<table class="table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+"</table>"+"</div>"+'<div class="datepicker-years">'+'<table class="table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+"</table>"+"</div>"+"</div>"}(jQuery),define("libs/bootstrap-datepicker",function(){}),define("applications/calendar/App",["core/Application","core/FlxState","applications/calendar/Builder","libs/bootstrap-datepicker"],function(Application,FlxState,Builder){function fetchState(url){$(".calendar-navigation-button").toggleClass("disabled"),$(".loading").show(),$("#tabs").css("opacity",".3"),$.ajax({url:url,success:function(response){Calendar.currentTab&&Calendar.currentTab.saveState(),Calendar.tabState=response.state,Calendar.start=response.start,Calendar.end=response.end,FlxState.router.navigate("app/calendar/"+Calendar.currentTabName+"/"+response.state),FlxState.saveState("calendar",Calendar.currentTabName+"/"+response.state),$("#currentTimespanLabel span").html(response.currentTimespanLabel),Calendar.timeUnit==="DAY"&&setDatepicker(response.state.split("/")[1]),fetchCalendar("/api/calendar/all/"+response.state)},error:function(){alert("error")}})}function setDatepicker(currentDate){$(".datepicker.dropdown-menu").remove(),$("#datepicker").replaceWith('<a data-date-format="yyyy-mm-dd" id="datepicker"><i class="icon-calendar icon-large"></i></a>'),$("#datepicker").attr("data-date",currentDate),$("#datepicker").unbind("changeDate"),$("#datepicker").datepicker().on("changeDate",function(event){var curr_date=event.date.getDate(),curr_month=event.date.getMonth()+1,curr_year=event.date.getFullYear(),formatted=curr_year+"-"+curr_month+"-"+curr_date;fetchState("/nav/setDate.json?date="+formatted),$(".datepicker").hide()})}function fetchCalendar(url){$.ajax({url:url,success:function(response){Calendar.timeUnit==="DAY"?handleCityInfo(response):$("#mainCity").empty(),Calendar.digest=response,enhanceDigest(Calendar.digest),processDigest(Calendar.digest),Builder.updateTab(Calendar.digest,Calendar),$("#tabs").css("opacity","1"),$(".calendar-navigation-button").toggleClass("disabled"),$(".loading").hide()},error:function(){alert("error fetching calendar")}})}function getTemplate(digest,i,j){App.loadMustacheTemplate("applications/calendar/facetTemplates.html",digest.selectedConnectors[i].facetTypes[j],function(template){template==null&&console.log("WANRING: no template found for "+digest.selectedConnectors[i].facetTypes[j]+"."),digest.detailsTemplates[digest.selectedConnectors[i].facetTypes[j]]=template})}function enhanceDigest(digest){digest.detailsTemplates={};for(var i=0;i<digest.selectedConnectors.length;i++)for(var j=1;j<digest.selectedConnectors[i].facetTypes.length;j++)getTemplate(digest,i,j);App.loadMustacheTemplate("applications/calendar/facetTemplates.html","fluxtream-address",function(template){template==null&&console.log("WANRING: no template found for fluxtream-address."),digest.detailsTemplates["fluxtream-address"]=template});for(var connectorId in digest.cachedData)for(var i=0;i<digest.cachedData[connectorId].length;i++)digest.cachedData[connectorId][i].getDetails=function(){return buildDetails(digest,this)};for(var addressType in digest.addresses)for(var i=0;i<digest.addresses[addressType].length;i++)digest.addresses[addressType][i].getDetails=function(){return buildAddressDetails(digest,this)}}function processDigest(digest){var selectedConnectors=$("#selectedConnectors");selectedConnectors.empty();for(var i=0;i<digest.selectedConnectors.length;i++){var enabled=!1;for(var j=0;j<digest.selectedConnectors[i].facetTypes.length&&!enabled;j++)enabled=digest.cachedData[digest.selectedConnectors[i].facetTypes[j]]!=null;enabled=enabled?"":"flx-disconnected";var button=$('<li><a href="#" class="flx-active '+enabled+" "+digest.selectedConnectors[i].connectorName+'">'+digest.selectedConnectors[i].prettyName+"</button></li>");selectedConnectors.append(button),button=$(button.children()[0]),buttons[digest.selectedConnectors[i].connectorName]=button,button.click({button:button,objectTypeNames:digest.selectedConnectors[i].facetTypes,connectorName:digest.selectedConnectors[i].connectorName},function(event){event.preventDefault(),$(document).click(),connectorClicked(event.data.button,event.data.objectTypeNames,event.data.connectorName)}),Calendar.connectorEnabled["default"][digest.selectedConnectors[i].connectorName]==null&&(Calendar.connectorEnabled["default"][digest.selectedConnectors[i].connectorName]=!0),Calendar.updateButtonStates()}}function connectorClicked(button,objectTypeNames,connectorName){if(button.is(".flx-disconnected"))return;Calendar.connectorEnabled[Calendar.currentTabName][connectorName]=!Calendar.connectorEnabled[Calendar.currentTabName][connectorName],Calendar.connectorEnabled[Calendar.currentTabName][connectorName]?(button.addClass("flx-active"),button.removeClass("flx-inactive")):(button.removeClass("flx-active"),button.addClass("flx-inactive")),Calendar.currentTab.connectorToggled(connectorName,objectTypeNames,Calendar.connectorEnabled[Calendar.currentTabName][connectorName]);return}function buildAddressDetails(digest,address){if(digest.detailsTemplates["fluxtream-address"]==null)return console.log("WARNING: no template found for fluxtream-address."),"";var params={};for(var member in address)switch(member){case"type":switch(address[member]){case"ADDRESS_HOME":params[member]="Home";break;case"ADDRESS_WORK":params[member]="Work";break;case"ADDRESS_OTHER":params[member]="Other";break;default:params[member]=address[member]}break;default:params[member]=address[member]}return digest.detailsTemplates["fluxtream-address"].render(params)}function buildDetails(digest,data){if(digest.detailsTemplates[data.type]==null)return console.log("WARNING: no template found for "+data.type+"."),"";var params={};for(var member in data)switch(member){case"startMinute":params.time=App.formatMinuteOfDay(data[member]);break;case"userName":if(data.type=="twitter-dm"){params.sender=data.sent?"You":data[member],params.receiver=data.sent?data[member]:"You";break}params[member]=data[member];break;case"imgUrls":params.imgUrl=data[member][0];break;default:params[member]=data[member]}return digest.detailsTemplates[data.type].render(params)}function handleCityInfo(digestInfo){$("#mainCity").empty(),digestInfo.cities&&digestInfo.cities.length>0&&$("#mainCity").html(cityLabel(digestInfo.cities[0])+temperaturesLabel(digestInfo))}function ephemerisLabel(digestInfo){var sunriseH=Math.floor(digestInfo.solarInfo.sunrise/60),sunriseM=digestInfo.solarInfo.sunrise%60,sunsetH=Math.floor(digestInfo.solarInfo.sunset/60),sunsetM=digestInfo.solarInfo.sunset%60;return sunriseM<10&&(sunriseM="0"+sunriseM),sunsetM<10&&(sunsetM="0"+sunsetM),'<span class="ephemeris"><i class="flx-pict-sun">&nbsp;</i><span>'+sunriseH+":"+sunriseM+" am"+'</span>&nbsp;<i class="flx-pict-moon">&nbsp;</i><span>'+sunsetH+":"+sunsetM+" pm</span></span>"}function temperaturesLabel(digestInfo){return digestInfo.maxTempC==-1e4?"":digestInfo.settings.temperatureUnit!="CELSIUS"?ephemerisLabel(digestInfo)+'<i class="flx-pict-temp">&nbsp;</i>'+'<span class="ephemeris" style="font-weight:normal;">&nbsp;'+digestInfo.minTempF+" / "+digestInfo.maxTempF+"&deg;F"+"</span>":ephemerisLabel(digestInfo)+'<i class="flx-pict-temp">&nbsp;</i>'+'<span class="ephemeris" style="font-weight:normal;">&nbsp;'+digestInfo.minTempC+" / "+digestInfo.maxTempC+"&deg;C"+"</span>"}function cityLabel(cityInfo){var s="";return s+=cityInfo.name,cityInfo.state&&(s+=", "+cityInfo.state),s+=", "+cityInfo.country,s}function toTimeUnit(urlTimeUnit){return urlTimeUnit==="date"?"DAY":urlTimeUnit.toUpperCase()}var Calendar=new Application("calendar","Candide Kemmler","icon-calendar");Calendar.currentTabName=Builder.tabs.DAY[0],Calendar.currentTab=null,Calendar.tabState=null,Calendar.digest=null,Calendar.timeUnit="DAY";var start,end;Calendar.connectorEnabled={"default":{}};var buttons={};return Calendar.setup=function(){$(".menuNextButton").click(function(e){fetchState("/nav/incrementTimespan.json?state="+Calendar.tabState)}),$(".menuPrevButton").click(function(e){fetchState("/nav/decrementTimespan.json?state="+Calendar.tabState)}),$(".menuTodayButton").click(function(e){Calendar.timeUnit="DAY";var t=Builder.tabExistsForTimeUnit(Calendar.currentTabName,Calendar.timeUnit)?Calendar.currentTabName:Builder.tabs[Calendar.timeUnit][0];Calendar.currentTabName=t,Calendar.updateButtonStates(),Builder.bindTimeUnitsMenu(Calendar),Builder.createTabs(Calendar),fetchState("/nav/setToToday.json")})},Calendar.initialize=function(){_.bindAll(this),FlxState.router.route(/^app\/calendar(\/?)(.*?)$/,"",function(){var parse_url=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,result=parse_url.exec(window.location.href),names=["url","scheme","slash","host","port","path"],i,parts={};for(i=0;i<names.length;i+=1)parts[names[i]]=result[i];console.log("path: "+parts.path);var pathElements=parts.path.split("/");pathElements.length<3&&App.invalidPath();var splits={},splitNames=["app","appName","tabName","timeUnit"];for(i=0;i<pathElements.length;i+=1)splits[splitNames[i]]=pathElements[i];var validTab=_.include(["clock","map","diary","photos","list","timeline","dashboards"],splits.tabName),validTimeUnit=_.include(["date","week","month","year"],splits.timeUnit);if(validTab&&validTimeUnit){var tab=Builder.tabExistsForTimeUnit(splits.tabName,Calendar.timeUnit)?splits.tabName:Builder.tabs[Calendar.timeUnit][0];switch(splits.timeUnit){case"date":var date=pathElements[4];Calendar.render(tab+"/date/"+date);break;case"week":var year=pathElements[4],week=pathElements[5];Calendar.render(tab+"/week/"+year+"/"+week);break;case"month":var year=pathElements[4],month=pathElements[5];Calendar.render(tab+"/month/"+year+"/"+month);break;case"year":var year=pathElements[4];Calendar.render(tab+"/year/"+year)}}else App.invalidPath()})},Calendar.renderState=function(state,forceReload){$("#filtersContainer").hide(),forceReload=typeof forceReload!="undefined"&&forceReload;if(!forceReload&&FlxState.getState("calendar")===state)return;if(state==null||state===""){Builder.bindTimeUnitsMenu(Calendar),Builder.createTabs(Calendar),fetchState("/nav/setToToday.json");return}var splits=state.split("/");Calendar.currentTabName=splits[0];if(!Builder.isValidTabName(splits[0])){App.invalidPath();return}if(!Builder.isValidTimeUnit(splits[1])){App.invalidPath();return}Calendar.timeUnit=toTimeUnit(splits[1]);var nextTabState=state.substring(splits[0].length+1),w=Builder.tabExistsForTimeUnit(Calendar.currentTabName,Calendar.timeUnit)?Calendar.currentTabName:Builder.tabs[Calendar.timeUnit][0];Calendar.currentTabName=w,Calendar.updateButtonStates(),Builder.createTabs(Calendar);if(!forceReload&&Calendar.tabState==nextTabState){Builder.updateTab(Calendar.digest,Calendar),FlxState.router.navigate("app/calendar/"+state),FlxState.saveState("calendar",state);return}Builder.bindTimeUnitsMenu(Calendar),"DAY"===Calendar.timeUnit?fetchState("/nav/setDate.json?date="+splits[2]):"WEEK"===Calendar.timeUnit?fetchState("/nav/setWeek.json?year="+splits[2]+"&week="+splits[3]):"MONTH"===Calendar.timeUnit?fetchState("/nav/setMonth.json?year="+splits[2]+"&month="+splits[3]):"YEAR"===Calendar.timeUnit&&fetchState("/nav/setYear.json?year="+splits[2])},Calendar.updateButtonStates=function(){Calendar.connectorEnabled[Calendar.currentTabName]==null&&(Calendar.connectorEnabled[Calendar.currentTabName]={});for(var connectorName in Calendar.connectorEnabled["default"])Calendar.connectorEnabled[Calendar.currentTabName][connectorName]==null&&(Calendar.connectorEnabled[Calendar.currentTabName][connectorName]=Calendar.connectorEnabled["default"][connectorName]),Calendar.connectorEnabled[Calendar.currentTabName][connectorName]?(buttons[connectorName].addClass("flx-active"),buttons[connectorName].removeClass("flx-inactive")):(buttons[connectorName].removeClass("flx-active"),buttons[connectorName].addClass("flx-inactive"))},Calendar.dateChanged=function(date,rangeType){console.log("Calendar.dateChanged("+date+", "+rangeType+")"),console.log("updating url...");var state="timeline/date/"+date;FlxState.router.navigate("app/calendar/"+state,{trigger:!1,replace:!0}),FlxState.saveState("calendar",state),Calendar.tabState="date/"+date,Calendar.timeUnit="DAY";var dateSplits=date.split("-"),d=new Date(Number(dateSplits[0]),Number(dateSplits[1])-1,Number(dateSplits[2])),daysOfWeek=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],monthsOfYear=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dateLabel=daysOfWeek[d.getDay()]+", "+monthsOfYear[d.getMonth()]+" "+d.getDate()+", "+(d.getYear()+1900);console.log("dateLabel: "+dateLabel),$("#currentTimespanLabel span").html(dateLabel)},Calendar}),define("applications/calendar/tabs/clock/ClockDrawingUtils",[],function(){return{getDrawingUtils:function(config){function arc(center,radius,startAngle,endAngle){endAngle-startAngle<2&&(endAngle+=1);var angle=startAngle,coords=toCoords(center,radius,angle),path="M "+coords[0]+" "+coords[1];while(angle<=endAngle)coords=toCoords(center,radius,angle),path+=" L "+coords[0]+" "+coords[1],angle+=1;return path}function toCoords(center,radius,angle){var radians=angle/180*Math.PI,x=center[0]+Math.cos(radians)*radius,y=center[1]+Math.sin(radians)*radius;return[x,y]}return{paintCircle:function(paper,radius,color,opacity){var coords=arc(config.CLOCK_CENTER,radius,0,360);config.clockCircles.push(function(){var path=paper.path(coords);return path.attr("stroke-width",config.STROKE_WIDTH),path.attr("stroke",color),path}())}}}}}),define("applications/calendar/tabs/clock/ClockConfig",[],function(){return{getConfig:function(edgeWidth,start,end){var ORBIT_RATIO=edgeWidth/600;return{start:start,end:end,START_AT:90,STROKE_WIDTH:16,HOUR:60,RATIO:4,CLOCK_WIDTH:edgeWidth,CLOCK_HEIGHT:edgeWidth,locationHistory:null,traveling:!1,CLOCK_CENTER:[edgeWidth/2,edgeWidth/2],NO_CATEGORY:{orbit:91*ORBIT_RATIO,color:"#ee80cc"},BODY_CATEGORY:{orbit:91*ORBIT_RATIO,color:"#9233ef"},AT_HOME_CATEGORY:{orbit:135*ORBIT_RATIO,color:"#4c99c5"},IN_TRANSIT_CATEGORY:{orbit:158*ORBIT_RATIO,color:"#22b2b9"},OUTSIDE_CATEGORY:{orbit:184*ORBIT_RATIO,color:"#5cae5c"},MIND_CATEGORY:{orbit:208*ORBIT_RATIO,color:"#92da46"},SOCIAL_CATEGORY:{orbit:231*ORBIT_RATIO,color:"#9233ef"},MEDIA_CATEGORY:{orbit:255*ORBIT_RATIO,color:"#fd4938"},clockCircles:null}}}}),define("applications/calendar/tabs/Tab",["core/FlxState"],function(FlxState){function Tab(aname,anauthor,anicon,needsTemplating){this.name=aname,this.author=anauthor,this.icon=anicon,this.needsTemplating=needsTemplating}function getCurrentState(){return{}}return Tab.prototype.saveState=function(){FlxState.saveTabState(this.getCurrentState())},Tab.prototype.getSavedState=function(){return FlxState.getTabState(this.name)},Tab.prototype.getUrl=function(url,id,domReady,forceLoad,tabData){this.getTabContents(url,id,typeof domReady=="undefined"?null:domReady,!1,forceLoad,tabData)},Tab.prototype.getTemplate=function(templatePath,id,domReady,tabData){this.getTabContents(templatePath,id,typeof domReady=="undefined"?null:domReady,!0,!1,tabData)},Tab.prototype.getTabContents=function(uri,id,domReady,isResource,forceLoad,tabData){var nextTabId=id+"-tab",nextTabDiv=$("#"+nextTabId),that=this,noTab=$(".tab").length==0,tabChanged=$(".tab").length>0&&$(".tab.active").length>0&&$(".tab.active").attr("id")!=nextTabId;if(noTab||tabChanged||forceLoad){if(tabChanged){var currentTabDiv=$(".tab.active");currentTabDiv.removeClass("active"),currentTabDiv.addClass("dormant")}nextTabDiv.length==0||forceLoad?isResource?require([uri],function(template){that.insertTabContents(template,nextTabId,domReady,forceLoad,tabData)}):$.ajax({url:uri,success:function(html){that.insertTabContents(html,nextTabId,domReady,forceLoad,tabData)}}):(nextTabDiv.removeClass("dormant"),nextTabDiv.addClass("active"),domReady!=null&&domReady())}else domReady!=null&&domReady()},Tab.prototype.insertTabContents=function(template,nextTabId,domReady,forceLoad,tabData){var templateJs=Hogan.compile(template);typeof tabData!="undefined"&&tabData!=null?(tabData.release=window.FLX_RELEASE_NUMBER,template=templateJs.render(tabData)):this.needsTemplating&&(template=templateJs.render({release:window.FLX_RELEASE_NUMBER})),template='<div class="tab active" id="'+nextTabId+'">'+template+"</div>",forceLoad&&$("#"+nextTabId).length>0?$("#"+nextTabId).replaceWith(template):$("#tabs").append(template),domReady!=null&&domReady(template)},Tab.prototype.getCurrentState=getCurrentState,Tab.prototype.connectorToggled=function(){},Tab}),define("applications/calendar/tabs/map/MapConfig",[],function(){return{getConfig:function(){return{NO_CATEGORY:{icon:"http://maps.google.com/mapfiles/marker_white.png",shadow:new google.maps.MarkerImage("http://maps.google.com/mapfiles/shadow50.png",null,null,new google.maps.Point(11,34),null)},BODY_CATEGORY:{icon:"http://maps.google.com/mapfiles/marker_purple.png",shadow:new google.maps.MarkerImage("http://maps.google.com/mapfiles/shadow50.png",null,null,new google.maps.Point(11,34),null)},MIND_CATEGORY:{icon:"http://maps.google.com/mapfiles/marker_green.png",shadow:new google.maps.MarkerImage("http://maps.google.com/mapfiles/shadow50.png",null,null,new google.maps.Point(11,34),null)},SOCIAL_CATEGORY:{icon:"http://maps.google.com/mapfiles/marker_purple.png",shadow:new google.maps.MarkerImage("http://maps.google.com/mapfiles/shadow50.png",null,null,new google.maps.Point(11,34),null)},MEDIA_CATEGORY:{icon:"http://maps.google.com/mapfiles/marker.png",shadow:new google.maps.MarkerImage("http://maps.google.com/mapfiles/shadow50.png",null,null,new google.maps.Point(11,34),null)},flatAccuracyCutoff:200,stdAccuracyCutoff:1}}}}),define("applications/calendar/tabs/map/MapUtils",["applications/calendar/tabs/map/MapConfig"],function(Config){function addGPSData(map,gpsData){map.gpsPositions=[],map.gpsTimestamps=[];var minLat=90,maxLat=0,minLng=180,maxLng=-180,filtered=0,avg=0;for(var i=0;i<gpsData.length;i++){if(gpsData[i].accuracy>config.flatAccuracyCutoff){filtered++;continue}avg+=gpsData[i].accuracy}var cutoff=1e9;if(filtered!=gpsData.length){avg/=gpsData.length-filtered;var std=0;for(var i=0;i<gpsData.length;i++){if(gpsData[i].accuracy>config.flatAccuracyCutoff)continue;std+=Math.pow(gpsData[i].accuracy-avg,2)}std/=gpsData.length-filtered,std=Math.sqrt(std),cutoff=avg+std*config.stdAccuracyCutoff}for(var i=0;i<gpsData.length;i++){if(gpsData[i].accuracy>cutoff)continue;var lat=gpsData[i].position[0],lng=gpsData[i].position[1];map.gpsPositions[map.gpsPositions.length]=new google.maps.LatLng(lat,lng),map.gpsTimestamps[map.gpsTimestamps.length]=gpsData[i].start,map.gpsAccuracies[map.gpsAccuracies.length]=gpsData[i].accuracy,lat<minLat&&(minLat=lat),lat>maxLat&&(maxLat=lat),lng<minLng&&(minLng=lng),lng>maxLng&&(maxLng=lng)}map.gpsLine=new google.maps.Polyline({map:map,path:map.gpsPositions}),map.gpsBounds=new google.maps.LatLngBounds(new google.maps.LatLng(minLat,minLng),new google.maps.LatLng(maxLat,maxLng))}function addData(map,connectorData,connectorInfoId,clickable){return isDisplayable(connectorInfoId)?(map.markers[connectorInfoId]=addItemsToMap(map,connectorData,clickable),map.markers[connectorInfoId]!=null):!1}function addAddresses(map,addressesData,clickable){for(var type in addressesData)for(var i=0;i<addressesData[type].length;i++)addAddress(map,addressesData[type][i],clickable)}function addAddress(map,address,clickable){var icon="/static/images/mapicons/";switch(address.type){default:case"ADDRESS_HOME":icon+="home.png";break;case"ADDRESS_WORK":icon+="workoffice.png"}var marker=new google.maps.Marker({map:map,position:new google.maps.LatLng(address.latitude,address.longitude),icon:icon});marker.showCircle=function(){if(marker.circle!=null)return;marker.circle=new google.maps.Circle({center:marker.getPosition(),map:map,radius:address.radius,fillColor:"green",fillOpacity:.5,strokeOpacity:0})},marker.hideCircle=function(){if(marker.circle==null)return;marker.circle.setMap(null),marker.circle=null};if(!clickable)return marker;google.maps.event.addListener(marker,"click",function(){map.connectorSelected=null,map.selectedMarker!=null&&map.selectedMarker.hideCircle(),map.selectedMarker=marker,map.infoWindow.setContent(address.getDetails()),map.infoWindow.open(map,marker),marker.showCircle()})}function isDisplayable(itemType){switch(itemType){case"sms_backup-sms":case"sms_backup-call_Calendar":case"twitter-dm":case"twitter-tweet":case"twitter-mention":case"google_calendar-entry":case"toodledo-task":case"fitbit-sleep":case"withings-bpm":case"picasa-photo":case"flickr":case"lastfm-recent_track":case"lastfm-loved_track":case"photo":return!0;default:return!1}}function addImagesToMap(map,items,clickable){var markerArray=new Array;for(var i=0;i<items.length;i++){var marker=addImageToMap(map,items[i],clickable);marker!=null&&(markerArray[markerArray.length]=marker)}return!(markerArray.length=0),markerArray=null,markerArray}function addImageToMap(map,item,clickable){var category=config.SOCIAL_CATEGORY,start=item.timeTaken;if(start<map.gpsTimestamps[0]||start>map.gpsTimestamps[map.gpsTimestamps.length-1])return null;var marker=new google.maps.Marker({map:map,position:map.getLatLngOnGPSLine(start),icon:category.icon,shadow:category.shadow});return enhanceMarker(map,marker,start,null),clickable?(google.maps.event.addListener(marker,"click",function(){map.connectorSelected=item.type,map.selectedMarker!=null&&map.selectedMarker.hideCircle(),map.selectedMarker=marker,map.infoWindow.setContent('<div style="text-align:center;"><img class="mapImagePreview" src="'+item.photoUrl+'"></img></div>'),map.infoWindow.open(map,marker),marker.doHighlighting(),marker.showCircle()}),marker):marker}function addItemsToMap(map,items,clickable){var markerArray=new Array;for(var i=0;i<items.length;i++){var marker=addItemToMap(map,items[i],clickable);marker!=null&&(markerArray[markerArray.length]=marker)}return markerArray.length==0&&(markerArray=null),markerArray}function addItemToMap(map,item,clickable){var category;switch(item.type){case"sms_backup-sms":case"sms_backup-call_Calendar":case"twitter-dm":case"twitter-tweet":case"twitter-mention":category=config.SOCIAL_CATEGORY;break;case"google_calendar-entry":case"toodledo-task":category=config.MIND_CATEGORY;break;case"fitbit-sleep":case"withings-bpm":category=config.BODY_CATEGORY;break;case"picasa-photo":case"flickr":case"lastfm-recent_track":case"lastfm-loved_track":category=config.MEDIA_CATEGORY;break;default:return null}var start=item.start,end=item.end;if(start>map.gpsTimestamps[map.gpsTimestamps.length-1]||end==null&&start<map.gpsTimestamps[0])return;var marker=new google.maps.Marker({map:map,position:map.getLatLngOnGPSLine(start),icon:category.icon,shadow:category.shadow});return enhanceMarker(map,marker,start,end),clickable?(google.maps.event.addListener(marker,"click",function(){map.connectorSelected=item.type,map.selectedMarker!=null&&map.selectedMarker.hideCircle(),map.selectedMarker=marker,map.infoWindow.setContent(item.getDetails()),map.infoWindow.open(map,marker),marker.doHighlighting(),marker.showCircle()}),marker):marker}function enhanceMarker(map,marker,start,end){if(marker._oldSetMap!=null)return;marker._oldSetMap=marker.setMap,marker.targetMap=null,marker.circle=null;var accuracy=getGPSAccuracy(map,start);marker.showCircle=function(){if(marker.circle!=null)return;marker.circle=new google.maps.Circle({center:marker.getPosition(),map:map,radius:accuracy,fillColor:"red",fillOpacity:.5,strokeOpacity:0})},marker.hideCircle=function(){if(marker.circle==null)return;marker.circle.setMap(null),marker.circle=null},marker.setMap=function(newMap){marker.circle!=null&&marker.circle.setMap(newMap),marker.line!=null&&marker.line===map.currentHighlightedLine?newMap==null?map.currentHighlightedLine.setMap(null):map==newMap&&map.currentHighlightedLine.setMap(map):marker.line=null,marker.targetMap=newMap,marker.hidden||marker._oldSetMap(newMap)},marker.hidden=!1,marker.hideMarker=function(){marker.hidden||(marker.hidden=!0,marker._oldSetMap(null))},marker.showMarker=function(){marker.hidden&&(marker.hidden=!1,marker._oldSetMap(marker.targetMap))},marker.doHighlighting=function(){map.currentHighlightedLine!=null&&(map.currentHighlightedLine.setMap(null),map.currentHighlightedLine=null),end!=null&&(map.currentHighlightedLine=map.createPolyLineSegment(start,end,{strokeColor:"orange",zIndex:100}),marker.line=map.currentHighlightedLine,map.gpsLine.getMap()==null&&map.currentHighlightedLine.setMap(null))}}function highlightTimespan(map,start,end){if(map.gpsTimestamps.length==0)return;map.highlightSection!=null&&(map.highlightSection.setMap(null),map.highlightSection=null);if(start<=map.gpsTimestamps[0]&&end>=map.gpsTimestamps[map.gpsTimestamps.length-1]){map.gpsLine.setOptions({strokeColor:"black"});return}map.gpsLine.setOptions({strokeColor:"grey"}),highlightSection=map.createPolyLineSegment(start,end,{strokeColor:"black",zIndex:99})}function getFirstIndexAfter(map,time){var endIndex;for(endIndex=0;endIndex<map.gpsTimestamps.length&&map.gpsTimestamps[endIndex]<time;endIndex++);return endIndex}function getFirstIndexBefore(map,time){if(time<=map.gpsTimestamps[0])return-1;var endIndex;for(endIndex=1;endIndex<map.gpsTimestamps.length&&map.gpsTimestamps[endIndex]<time;endIndex++);return endIndex-1}function createPolyLineSegment(map,start,end,options){options.map=map;var newPoints=new Array;newPoints[0]=map.getLatLngOnGPSLine(start);if(newPoints[0]==null)return null;var startIndex=map.getFirstIndexAfter(start),endIndex=map.getFirstIndexBefore(end);for(var i=0;i+startIndex<=endIndex;i++)newPoints[i+1]=map.gpsPositions[i+startIndex];return newPoints[newPoints.length]=map.getLatLngOnGPSLine(end),options.path=newPoints,new google.maps.Polyline(options)}function getGPSAccuracy(map,time){if(map.gpsTimestamps.length==0)return-1;if(time<=map.gpsTimestamps[0])return map.gpsAccuracies[0];if(map>=map.gpsTimestamps[map.gpsTimestamps.length-1])return map.gpsAccuracies[map.gpsAccuracies.length-1];var endIndex;for(endIndex=1;endIndex<map.gpsTimestamps.length&&map.gpsTimestamps[endIndex]<time;endIndex++);var startIndex=endIndex-1,percentThrough=(time-map.gpsTimestamps[startIndex])/(map.gpsTimestamps[endIndex]-map.gpsTimestamps[startIndex]);return isNaN(percentThrough)?map.gpsAccuracies[startIndex]:(map.gpsAccuracies[endIndex]-map.gpsAccuracies[startIndex])*percentThrough+map.gpsAccuracies[startIndex]}function getLatLngOnGPSLine(map,time){if(map.gpsTimestamps.length==0)return null;if(time<=map.gpsTimestamps[0])return map.gpsPositions[0];if(time>=map.gpsTimestamps[map.gpsTimestamps.length-1])return map.gpsPositions[map.gpsPositions.length-1];var endIndex;for(endIndex=1;endIndex<map.gpsTimestamps.length&&map.gpsTimestamps[endIndex]<time;endIndex++);var startIndex=endIndex-1,percentThrough=(time-map.gpsTimestamps[startIndex])/(map.gpsTimestamps[endIndex]-map.gpsTimestamps[startIndex]),projection=map.getProjection(),startPoint=projection.fromLatLngToPoint(map.gpsPositions[startIndex]),endPoint=projection.fromLatLngToPoint(map.gpsPositions[endIndex]),x=(endPoint.x-startPoint.x)*percentThrough+startPoint.x,y=(endPoint.y-startPoint.y)*percentThrough+startPoint.y,latlng=projection.fromPointToLatLng(new google.maps.Point(x,y));return new google.maps.LatLng(latlng.lat(),latlng.lng())}function zoomOnTimespan(map,start,end){var minLat,maxLat,minLng,maxLng,startPoint=map.getLatLngOnGPSLine(start),endPoint=map.getLatLngOnGPSLine(end);if(startPoint==null||endPoint==null)return;startPoint.lat()<endPoint.lat()?(minLat=startPoint.lat(),maxLat=endPoint.lat()):(minLat=endPoint.lat(),maxLat=startPoint.lat()),startPoint.lng()<endPoint.lng()?(minLng=startPoint.lng(),maxLng=endPoint.lng()):(minLng=endPoint.lng(),maxLng=endPoint.lng());var startIndex=map.getFirstIndexAfter(start),endIndex=map.getFirstIndexBefore(end);for(var i=startIndex;i<endIndex;i++)map.gpsPositions[i].lat()<minLat?minLat=map.gpsPositions[i].lat():map.gpsPositions[i].lat()>maxLat&&(maxLat=map.gpsPositions[i].lat()),map.gpsPositions[i].lng()<minLng?minLng=map.gpsPositions[i].lng():map.gpsPositions[i].lng()>maxLng&&(maxLng=map.gpsPositions[i].lng());map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(minLat,minLng),new google.maps.LatLng(maxLat,maxLng)))}function zoomOnPoint(map,point){map.setCenter(point),map.setZoom(18)}function zoomOnMarker(map,marker){marker.circle==null?zoomOnPoint(map,marker.getPosition()):map.fitBounds(marker.circle.getBounds())}function hideData(map,connectorId){if(connectorId=="google_latitude"){map.hideGPSData();return}if(!map.hasData(connectorId))return;map.connectorSelected==connectorId&&(map.infoWindow.close(),map.connectorSelected=null);for(var i=0;i<map.markers[connectorId].length;i++)map.markers[connectorId][i].setMap(null)}function showData(map,connectorId){if(connectorId=="google_latitude"){map.showGPSData();return}if(!map.hasData(connectorId))return;for(var i=0;i<map.markers[connectorId].length;i++)map.markers[connectorId][i].setMap(map),map.selectedMarker==map.markers[connectorId][i]&&map.selectedMarker.showCircle()}function hasData(map,connectorId){return map.markers[connectorId]!=null}function isFullyInitialized(map){return map.getProjection()!=null}function hideGPSData(map){map.gpsLine.setMap(null),map.currentHighlightedLine!=null&&map.currentHighlightedLine.setMap(null),map.highlightSection!=null&&map.highlightSection.setMap(null)}function showGPSData(map){map.gpsLine.setMap(map),map.currentHighlightedLine!=null&&map.currentHighlightedLine.setMap(map),map.highlightSection!=null&&map.highlightSection.setMap(map)}function ImageDisplayOverlay(map,latlng,imgUrl){this._map=map,this._latlng=latlng,this._imgUrl=imgUrl,this._img=null,this.setMap(map)}function createMapPositionControls(map){var control=$("<div></div>");control.css("background","white"),control.css("margin","0px 5px"),control.css("border","1px solid rgb(113, 123, 135)"),control.css("padding","5px"),control.css("box-shadow","rgba(0, 0, 0, 0.398438) 0px 2px 4px"),control.css("-webkit-box-shadow","rgba(0, 0, 0, 0.398438) 0px 2px 4px"),control.css("width","84px");var fitButton=$('<button class="btnList btn btnListChecked enabled">Fit to View</button>');fitButton.css("margin-bottom","0.5em");var container=$("<div></div>"),preserveView=$('<input type="checkbox">');preserveView.css("margin-right","0.5em"),preserveView.css("float","left"),control.append(fitButton),container.append(preserveView),container.append("Preserve View"),control.append(container),fitButton.click(function(){map.fitBounds(map.gpsBounds)}),map.preserveViewCheckbox=preserveView,map.controls[google.maps.ControlPosition.RIGHT_TOP].push(control[0]),map._preserveViewBtn=preserveView[0],preserveView.click(function(){map.preserveViewCheckboxChanged!=null&&map.preserveViewCheckboxChanged()}),map.isPreserveViewChecked=function(){return map._preserveViewBtn.checked},map.setPreserveView=function(isSet){map._preserveViewBtn.checked=isSet}}var config=Config.getConfig();return ImageDisplayOverlay.prototype=new google.maps.OverlayView,ImageDisplayOverlay.prototype.onAdd=function(){this._img=document.createElement("div"),this._img.style.position="absolute",this._img.style.width="64px",this._img.style.height="64px",img=document.createElement("img"),img.style.position="relative",img.className="mapImageOverlay",img.src=this._imgUrl,this._img.appendChild(img),this.getPanes().overlayLayer.appendChild(this._img)},ImageDisplayOverlay.prototype.onRemove=function(){this._img.parentNode.removeChild(this._img),this._img=null},ImageDisplayOverlay.prototype.draw=function(){var overlayProjection=this.getProjection(),position=this.getProjection().fromLatLngToDivPixel(this._latlng);this._img.style.left=position.x-32+"px",this._img.style.top=position.y-32+"px"},{isDisplayable:isDisplayable,newMap:function(center,zoom,divId,hideControls){var options={zoom:zoom,center:center,scrollwheel:!0,streetViewControl:!1,mapTypeId:google.maps.MapTypeId.ROADMAP};hideControls&&(options.disableDefaultUI=!0);var map=new google.maps.Map(document.getElementById(divId),options);return map.infoWindow=new google.maps.InfoWindow,map.currentHighlightedLine=null,map.highlightSection=null,map.connectorSelected=null,map.selectedMarker=null,map.gpsPosiitons=[],map.gpsTimestamps=[],map.gpsAccuracies=[],map.gpsBounds=null,map.markers={},map.addGPSData=function(gpsData){addGPSData(map,gpsData)},map.addData=function(connectorData,connectorInfoId,clickable){return addData(map,connectorData,connectorInfoId,clickable)},map.addAddresses=function(addresses,clickable){addAddresses(map,addresses,clickable)},map.getLatLngOnGPSLine=function(time){return getLatLngOnGPSLine(map,time)},map.createPolyLineSegment=function(start,end,options){return createPolyLineSegment(map,start,end,options)},map.getFirstIndexAfter=function(time){return getFirstIndexAfter(map,time)},map.getFirstIndexBefore=function(time){return getFirstIndexBefore(map,time)},map.zoomOnTimespan=function(start,end){zoomOnTimespan(map,start,end)},map.highlightTimespan=function(start,end){highlightTimespan(map,start,end)},map.showData=function(connectorId){showData(map,connectorId)},map.hideData=function(connectorId){hideData(map,connectorId)},map.hasData=function(connectorId){return hasData(map,connectorId)},map.showGPSData=function(){showGPSData(map)},map.hideGPSData=function(){hideGPSData(map)},map.addItem=function(item,clickable){return addItemToMap(map,item,clickable)},map.zoomOnPoint=function(point){zoomOnPoint(map,point)},map.zoomOnMarker=function(marker){zoomOnMarker(map,marker)},map.enhanceMarker=function(marker,start,end){enhanceMarker(map,marker,start,end)},map.isFullyInitialized=function(){return isFullyInitialized(map)},map._oldFitBounds=map.fitBounds,map.fitBounds=function(bounds){if(bounds==null)return;map._oldFitBounds(bounds)},hideControls||createMapPositionControls(map),map}}}),define("applications/calendar/tabs/clock/ClockTab",["applications/calendar/tabs/clock/ClockDrawingUtils","applications/calendar/tabs/clock/ClockConfig","applications/calendar/tabs/Tab","applications/calendar/App","applications/calendar/tabs/map/MapUtils"],function(DrawingUtils,Config,Tab,Log,MapUtils){function render(digest,timeUnit,calendarState,connectorEnabled){hideEventInfo(),$("#filtersContainer").show(),this.getTemplate("text!applications/calendar/tabs/clock/clock.html","clock",function(){setup(digest,timeUnit,connectorEnabled)})}function setup(digest,timeUnit,cEn){selectedConnectors=digest.selectedConnectors,connectorEnabled=cEn,hourlyWeatherData=digest.hourlyWeatherData,solarInfo=digest.solarInfo,tempratureUnit=digest.settings.temperatureUnit,distanceUnit=digest.settings.distanceUnit,dayStart=digest.tbounds.start,dayEnd=digest.tbounds.end,digest.cachedData!=null&&digest.cachedData.google_latitude!=null?(map=MapUtils.newMap(new google.maps.LatLng(0,0),8,"clockMap",!0),map.addGPSData(digest.cachedData.google_latitude),map.fitBounds(map.gpsBounds),map.addAddresses(digest.addresses,!1)):(hideQTipMap(),map=null);var availableWidth=$("#clockTab").width(),edgeWidth=Math.min(availableWidth,600);$("#clockTab div:first-child").width(edgeWidth+"px"),$("#paper").empty(),$("#paper").width(edgeWidth),paper=Raphael("paper",edgeWidth,edgeWidth),config=Config.getConfig(edgeWidth,digest.tbounds.start,digest.tbounds.end);var drawingUtils=DrawingUtils.getDrawingUtils(config);config.clockCircles=paper.set(),drawingUtils.paintCircle(paper,config.BODY_CATEGORY.orbit,"#ffffff",1),drawingUtils.paintCircle(paper,config.AT_HOME_CATEGORY.orbit,"#ffffff",1),drawingUtils.paintCircle(paper,config.OUTSIDE_CATEGORY.orbit,"#ffffff",1),drawingUtils.paintCircle(paper,config.MIND_CATEGORY.orbit,"#ffffff",1),drawingUtils.paintCircle(paper,config.SOCIAL_CATEGORY.orbit,"#ffffff",1),drawingUtils.paintCircle(paper,config.MEDIA_CATEGORY.orbit,"#ffffff",1),paintSolarInfo(digest.solarInfo);for(var objectTypeName in digest.cachedData){if(digest.cachedData[objectTypeName]==null||typeof digest.cachedData[objectTypeName]=="undefined")continue;updateDataDisplay(digest.cachedData[objectTypeName],objectTypeName,digest)}for(i=0;i<digest.updateNeeded.length;i++)getDayInfo(digest.updateNeeded[i],digest)}function outsideTimeBoundaries(o){return typeof o.tbounds!="undefined"?o.tbounds.start!=config.start||o.tbounds.end!=config.end:o.start!=config.start||o.end!=config.end}function getDayInfo(connectorName,digest){$.ajax({url:"/api/calendar/"+connectorName+"/"+Log.tabState,dataType:"json",success:function(jsonData){outsideTimeBoundaries(jsonData)||updateDataDisplay(jsonData,jsonData.name,digest)}})}function fillRegion(center,radius1,radius2,startAngle,endAngle){var startCoords=toCoords(center,radius1,startAngle),outerStart=toCoords(center,radius2,startAngle),endCoords=toCoords(center,radius1,endAngle),outerEnd=toCoords(center,radius2,endAngle),path="M "+startCoords[0]+","+startCoords[1];return path+="A "+radius1+","+radius1+" 0 0,0 "+endCoords[0]+","+endCoords[1]+" ",path+="L "+outerEnd[0]+","+outerEnd[1],path+="A "+radius2+","+radius2+" 0 0,1 "+outerStart[0]+","+outerStart[1]+" Z",path}function paintSolarInfo(solarInfo){if(solarInfo!=null){var startAngle=solarInfo.sunrise/config.RATIO+config.START_AT,endAngle=solarInfo.sunset/config.RATIO+config.START_AT,midAngle=endAngle*.2;if(endAngle<390){var coords=fillRegion(config.CLOCK_CENTER,config.BODY_CATEGORY.orbit-15,config.MEDIA_CATEGORY.orbit+15,startAngle,midAngle);config.clockCircles.push(function(){var path=paper.path(coords);return path.attr("stroke","rgba(199,199,199,.5)"),path.attr("fill","rgba(199,199,199,.5)"),path.toBack(),path}()),coords=fillRegion(config.CLOCK_CENTER,config.BODY_CATEGORY.orbit-15,config.MEDIA_CATEGORY.orbit+15,midAngle,endAngle),config.clockCircles.push(function(){var path=paper.path(coords);return path.attr("stroke","rgba(199,199,199,.5)"),path.attr("fill","rgba(199,199,199,.5)"),path.toBack(),path}())}else{var coords=fillRegion(config.CLOCK_CENTER,config.BODY_CATEGORY.orbit-15,config.MEDIA_CATEGORY.orbit+15,startAngle,endAngle);config.clockCircles.push(function(){var path=paper.path(coords);return path.attr("stroke","rgba(199,199,199,.5)"),path.attr("fill","rgba(199,199,199,.5)"),path.toBack(),path}())}}}function updateDataDisplay(connectorData,connectorInfoId,digest){switch(connectorInfoId){case"fitbit-activity_summary":break;case"google_latitude":connectorData!=null&&typeof connectorData!="undefined"&&locationBreakdown(connectorData,digest);break;case"withings-weight":break;case"picasa-photo":case"flickr":case"lastfm-recent_track":case"lastfm-loved_track":drawTimedData(connectorData,config.MEDIA_CATEGORY);break;case"sms_backup-sms":case"sms_backup-call_Calendar":case"twitter-dm":case"twitter-tweet":case"twitter-mention":drawTimedData(connectorData,config.SOCIAL_CATEGORY);break;case"google_calendar-entry":case"toodledo-task":drawTimedData(connectorData,config.MIND_CATEGORY);break;case"zeo":case"fitbit-sleep":case"withings-bpm":drawTimedData(connectorData,config.BODY_CATEGORY)}}function drawTimedData(payload,category){typeof payload!="undefined"&&payload!=null&&drawEvents(payload,category.orbit,category.color)}function drawEvents(items,orbit,color){if(typeof items=="undefined")return;for(i=0;i<items.length;i++)try{var item=items[i];config.clockCircles.push(function(){var start=item.startMinute,end=item.endMinute,instantWidth=2;orbit===config.BODY_CATEGORY.orbit&&(instantWidth=18),start>end&&(start=0);var instantaneous=typeof item.endMinute=="undefined"||item.endMinute===item.startMinute,span;instantaneous?span=paintSpan(paper,start,start+instantWidth,orbit,color,.9):span=paintSpan(paper,start,start<=end?end:1440,orbit,color,.9),span.node.item=item,$(span.node).attr("notthide",!0),$(span.node).css("cursor","pointer"),$(span.node).click({instantaneous:instantaneous},function(event){event.data.instantaneous?event.timeTarget=event.target.item.start:event.timeTarget=getTimestampForPoint(event.offsetX,event.offsetY),event.minuteOfDay=getMinuteOfDay(event.timeTarget),event.flip=event.offsetY>config.CLOCK_CENTER[1],showEventInfo(event)}),clockCircleElements[item.type]==null&&(clockCircleElements[item.type]=[]),clockCircleElements[item.type][clockCircleElements[item.type].length]=span.node;for(var i=0;i<selectedConnectors.length;i++){var found=!1;for(var j=0;!found&&j<selectedConnectors[i].facetTypes.length;j++)found=item.type==selectedConnectors[i].facetTypes[j];if(found){span.node.style.display=connectorEnabled[selectedConnectors[i].connectorName]?"inline":"none";break}}return span}())}catch(e){typeof console!="undefined"&&console.log&&console.log("there was an error parsing this json: "+e)}}function showEventInfo(event){hideEventInfo(),lastHoveredEvent=event;var span=event.target,facet=span.item;if(facet.type=="google_latitude")return;var target=$(event.target).parent().position(),tip_y=target.top+event.offsetY,tip_x=target.left+event.offsetX,offsetX=config.CLOCK_CENTER[0]-event.offsetX,offsetY=config.CLOCK_CENTER[1]-event.offsetY;map!=null&&(markers[0]=map.addItem(span.item,!1),markers[0]!=null&&(markers[0].doHighlighting(),markers[0].hideMarker(),markers[1]=new google.maps.Marker({map:map,position:map.getLatLngOnGPSLine(event.timeTarget),icon:markers[0].getIcon(),shadow:markers[0].getShadow()}),map.enhanceMarker(markers[1],event.timeTarget),markers[1].showCircle(),map.zoomOnMarker(markers[1])));var contents=facet.getDetails();showToolTip(tip_x,tip_y,offsetX,offsetY,contents,event.minuteOfDay,$(event.target).attr("stroke"),$(event.target).parent().parent(),markers[0]==null?null:markers[0].getPosition())}function showToolTip(x,y,offX,offY,contents,minute,color,parent,gpsPos){var weatherInfo=getWeatherData(minute),weatherIcon;minute<solarInfo.sunrise||minute>solarInfo.sunset?weatherIcon=weatherInfo.weatherIconUrlNight:weatherIcon=weatherInfo.weatherIconUrlDay;var orientation,tailOrientation,angle=toPolar([0,0],offX,offY)[1];angle<45||angle>315?(orientation="Left",tailOrientation="right"):angle>135&&angle<225?(orientation="Right",tailOrientation="left"):offY>0?(orientation="Top",tailOrientation="bottom"):(orientation="Bottom",tailOrientation="top"),App.loadMustacheTemplate("applications/calendar/tabs/clock/clockTemplate.html","tooltip",function(template){ttpdiv=$(template.render({weatherDescription:weatherInfo.weatherDesc,temperature:tempratureUnit==="FAHRENHEIT"?weatherInfo.tempF:weatherInfo.tempC,temperatureUnit:tempratureUnit==="FAHRENHEIT"?"F":"C",windSpeed:distanceUnit=="SI"?weatherInfo.windspeedKmph:weatherInfo.windspeedMiles,windSpeedUnit:distanceUnit=="SI"?"km/h":"mph",humidity:weatherInfo.humidity,precipitation:weatherInfo.precipMM,precipitationUnit:"mm",weatherIcon:weatherIcon,orientation:orientation,oppositeOrientation:tailOrientation,color:color,time:App.formatMinuteOfDay(minute),tooltipData:contents})),ttpdiv.css("position","absolute"),ttpdiv.css("zIndex","100");var tail=ttpdiv.find(".flx-toolTipTail-"+orientation);parent.append(ttpdiv);var displayX=x,displayY=y;orientation=="Left"||orientation=="Right"?(displayY+=offY-ttpdiv.height()/2,tail.css("top",ttpdiv.height()/2-offY-10)):(displayX+=offX-ttpdiv.width()/2,tail.css("left",ttpdiv.width()/2-offX-10)),displayY-=50;switch(orientation){case"Left":displayX+=10;break;case"Right":displayX-=10+ttpdiv.width();break;case"Top":displayY+=10;break;case"Bottom":displayY-=10+ttpdiv.height()}ttpdiv.css("left",displayX),ttpdiv.css("top",displayY),$("#mapPlaceHolder").append(document.getElementById("clockMap"));var lastSeen=$("#lastSeenLocation");App.geocoder.geocode({latLng:gpsPos},function(results,status){if(status==google.maps.GeocoderStatus.OK)for(var i=2;i>=0;i--)if(results[i]){lastSeen.text(results[i].formatted_address);return}})})}function getWeatherData(minuteOfDay){if(hourlyWeatherData==null)return null;var i;for(i=0;i<hourlyWeatherData.length-1&&hourlyWeatherData[i].minuteOfDay<minuteOfDay;i++);var weatherInfo=hourlyWeatherData[i];return weatherInfo}function showLocationBreakdownInfo(event){hideEventInfo();var span=event.target,facetId=span.item.id,target=$(event.target).parent().position(),tip_y=target.top+event.offsetY,tip_x=target.left+event.offsetX,offsetX=config.CLOCK_CENTER[0]-event.offsetX,offsetY=config.CLOCK_CENTER[1]-event.offsetY;map!=null&&(map.highlightTimespan(span.item.start,span.item.end),markers[0]=new google.maps.Marker({map:map,position:map.getLatLngOnGPSLine(event.timeTarget)}),map.enhanceMarker(markers[0],event.timeTarget),markers[0].showCircle(),map.zoomOnMarker(markers[0])),showToolTip(tip_x,tip_y,offsetX,offsetY,span.item.description,event.minuteOfDay,$(event.target).attr("stroke"),$(event.target).parent().parent(),markers[0]==null?null:markers[0].getPosition())}function hideEventInfo(){if(map!=null){hideQTipMap();for(var i=0;i<markers.length;i++)markers[i]!=null&&markers[i].setMap(null);markers=new Array,map.fitBounds(map.gpsBounds),map.highlightTimespan(dayStart,dayEnd)}ttpdiv!=null&&ttpdiv.qtip!=null&&(ttpdiv.remove(),ttpdiv=null)}function arc(center,radius,startAngle,endAngle){endAngle-startAngle<2&&(endAngle+=1);var angle=startAngle,coords=toCoords(center,radius,angle),path="M "+coords[0]+" "+coords[1];while(angle<=endAngle)coords=toCoords(center,radius,angle),path+=" L "+coords[0]+" "+coords[1],angle+=1;return path}function toCoords(center,radius,angle){var radians=angle/180*Math.PI,x=center[0]+Math.cos(radians)*radius,y=center[1]+Math.sin(radians)*radius;return[x,y]}function paintSpan(paper,startTime,endTime,radius,color,opacity){var coords=arc(config.CLOCK_CENTER,radius,startTime/config.RATIO+config.START_AT,endTime/config.RATIO+config.START_AT),path=paper.path(coords);return path.attr("stroke-width",config.STROKE_WIDTH),path.attr("stroke",color),path.attr("opacity",opacity),path}function toPolar(center,x,y){x-=center[0],y-=center[1];var r=Math.sqrt(x*x+y*y),theta;return x==0?y>0?theta=Math.PI/2:theta=3*Math.PI/2:y==0?x>0?theta=0:theta=Math.PI:x>0?theta=Math.atan(y/x):theta=Math.PI+Math.atan(y/x),theta*=180/Math.PI,theta<0&&(theta+=360),[r,theta]}function getTimestampForPoint(x,y){var angleClick=toPolar(config.CLOCK_CENTER,x,y)[1]-config.START_AT;return angleClick<0&&(angleClick+=360),dayStart+angleClick*config.RATIO*6e4}function getMinuteOfDay(timestamp){var minute=timestamp;return minute-=dayStart,minute/=6e4,minute}function showLocationBreakdown(items,color){if(typeof items=="undefined"||items==null)return;showWheelBreakdown(items,color)}function showWheelBreakdown(items,color){if(typeof items=="undefined")return;for(i=0;i<items.length;i++)try{var item=items[i],instantWidth=10;config.clockCircles.push(function(){typeof item.startMinute=="undefined"&&(item.startMinute=0);var start=item.startMinute,end=item.endMinute;start>end&&(start=0);var span=paintSpan(paper,start,start<=end?end:1440,config.AT_HOME_CATEGORY.orbit,color,1,config);span.node.item=item,$(span.node).attr("notthide",!0),$(span.node).css("cursor","pointer"),$(span.node).click(function(event){event.timeTarget=getTimestampForPoint(event.offsetX,event.offsetY),event.minuteOfDay=getMinuteOfDay(event.timeTarget),event.flip=event.offsetY>config.CLOCK_CENTER[1],showLocationBreakdownInfo(event)}),clockCircleElements[item.type]==null&&(clockCircleElements[item.type]=[]),clockCircleElements[item.type][clockCircleElements[item.type].length]=span.node;for(var i=0;i<selectedConnectors.length;i++){var found=!1;for(var j=0;!found&&j<selectedConnectors[i].facetTypes.length;j++)found=item.type==selectedConnectors[i].facetTypes[j];if(found){span.node.style.display=connectorEnabled[selectedConnectors[i].connectorName]?"inline":"none";break}}return span}())}catch(e){typeof console!="undefined"&&console.log&&console.log("there was an error parsing this json: "+e)}}function locationBreakdown(positions,digest){var homeAddress={latitude:0,longitude:0};digest.addresses.ADDRESS_HOME!=null&&digest.addresses.ADDRESS_HOME.length!=0&&(homeAddress=digest.addresses.ADDRESS_HOME[0]);var pos1=new google.maps.LatLng(homeAddress.latitude,homeAddress.longitude),i=0,checkin,pos2,notAtHome,lastCollection,currentCollection,mergedAtHome=new Array,mergedOutside=new Array,farAwayPositionsCount=0;for(;i<positions.length;i++){pos2=new google.maps.LatLng(positions[i].position[0],positions[i].position[1]);var distance=google.maps.geometry.spherical.computeDistanceBetween(pos1,pos2);distance<500?positions[i].at="home":distance>3e5&&farAwayPositionsCount++}farAwayPositionsCount==positions.length?config.traveling=!0:config.traveling=!1,notAtHome=new Array,atHome=new Array;for(i=0;i<positions.length;i++){positions[i].at!="home"?currentCollection=notAtHome:currentCollection=atHome,currentCollection.push(positions[i]);if(currentCollection==lastCollection)continue;lastCollection!=null&&(lastCollection.push(positions[i]),lastCollection.push("stop")),lastCollection=currentCollection}atHome=mergePositionFamilies(atHome,"home"),notAtHome=mergePositionFamilies(notAtHome,"out"),showLocationBreakdown(atHome,"#4c99c5"),showLocationBreakdown(notAtHome,"#5cae5c")}function mergePositionFamilies(positionFamilies,where){var result=[],positions=[];for(var i=0;i<positionFamilies.length;i++){if(positionFamilies[i]==="stop"){result.push(mergePositions(positions,where)),positions=[];continue}positions.push(positionFamilies[i])}return result.push(mergePositions(positions,where)),result}function mergePositions(positions,where){if(positions.length===0)return positions;var first=positions[0],last=positions[positions.length-1];return{start:first.start,end:last.start,description:"You were "+where+" from "+App.formatMinuteOfDay(first.startMinute)+" to "+App.formatMinuteOfDay(last.startMinute),startMinute:first.startMinute,endMinute:last.startMinute,type:"google_latitude"}}function hideQTipMap(){document.getElementById("clockMapContainer").appendChild(document.getElementById("clockMap"))}function qTipUpdate(){$("#mapPlaceHolder").append(document.getElementById("clockMap"))}function connectorToggled(connectorName,objectTypeNames,enabled){for(var i=0;i<objectTypeNames.length;i++){if(clockCircleElements[objectTypeNames[i]]==null)continue;for(var j=0;j<clockCircleElements[objectTypeNames[i]].length;j++)clockCircleElements[objectTypeNames[i]][j].style.display=enabled?"inline":"none"}}var paper=null,config=null,map=null,hourlyWeatherData=null,solarInfo=null,tempratureUnit=null,distanceUnit=null,dayStart,dayEnd,clockCircleElements={},selectedConnectors,connectorEnabled;$(document).click(function(event){for(var target=event.target;target!=null;target=target.parentElement)if($(target).attr("notthide")!=null)return;hideEventInfo()});var ttpdiv=null,lastHoveredEvent,timeout=null,markers=new Array,clockTab=new Tab("clock","Candide Kemmler","icon-time",!0);return document.qTipUpdate=qTipUpdate,document.hideQTipMap=hideQTipMap,clockTab.render=render,clockTab.connectorToggled=connectorToggled,clockTab}),define("applications/calendar/tabs/dashboard/DashboardTab",["applications/calendar/tabs/Tab","applications/calendar/App"],function(Tab,Calendar,CaloriesBurned){function render(digestInfo,timeUnit){digest=digestInfo;var that=this;$.ajax({url:"/tabs/dashboard.json",success:function(tabData){dashboardData=tabData,that.getUrl("/tabs/dashboard","dashboard-"+timeUnit,populateTemplate,!0,tabData)}})}function populateTemplate(html){for(var i=0;i<dashboardData.required.length;i++)require([dashboardData.required[i]],function(dashboardTabModule){dashboardTabModule.render(digest,dashboardData)})}var digest,dashboardData,dashboardTab=new Tab("dashboard","Candide Kemmler","icon-chart",!0);return dashboardTab.render=render,dashboardTab}),define("applications/calendar/tabs/dashboards/ManageDashboards",[],function(){function show(){$.ajax("/api/dashboards",{success:function(data,textStatus,jqXHR){dataLoaded(data)}})}function dataLoaded(data){App.loadMustacheTemplate("applications/calendar/tabs/dashboards/manageDashboardsTemplate.html","manageDashboardsDialog",function(template){var html=template.render(data);App.makeModal(html),bindDialog()})}function bindDialog(){}var ManageDashboards={};return ManageDashboards.show=show,ManageDashboards}),define("applications/calendar/tabs/dashboards/AddWidget",[],function(){function show(adid){activeDashboardId=adid,$.ajax("/api/widgets",{success:function(data,textStatus,jqXHR){var rows=[],row={widgets:[]};for(var i=0;i<data.length;i++)i%3==0&&(row={widgets:[]},rows.push(row)),row.widgets.push(data[i]);dataLoaded({rows:rows})}})}function dataLoaded(data){App.loadMustacheTemplate("applications/calendar/tabs/dashboards/addWidgetTemplate.html","addWidgetDialog",function(template){var html=template.render(data);App.makeModal(html),bindDialog()})}function bindDialog(){}var activeDashboardId,AddWidget={};return AddWidget.show=show,AddWidget}),define("applications/calendar/tabs/dashboards/DashboardsTab",["applications/calendar/tabs/Tab","applications/calendar/App","applications/calendar/tabs/dashboards/ManageDashboards","applications/calendar/tabs/dashboards/AddWidget"],function(Tab,Calendar,ManageDashboards,AddWidget){function render(digestInfo,timeUnit){_.bindAll(this),digest=digestInfo;var that=this;$.ajax({url:"/api/dashboards",success:function(dashboards){for(var i=0;i<dashboards.length;i++)dashboards[i].active&&(dashboardsTab.activeDashboard=dashboards[i].id);that.populateTemplate({dashboards:dashboards})}}),App.fullHeight()}function populateTemplate(dashboards){this.getTemplate("text!applications/calendar/tabs/dashboards/dashboards.html","dashboards",function(){$("#addWidgetButton").click(addWidget),$("#manageDashboardsButton").click(manageDashboards),$(".dashboardName").click(function(evt){var dashboardId=$(evt.target).parent().attr("id").substring("dashboard-".length);dashboardsTab.activeDashboard=dashboardId,$.ajax({url:"/api/dashboards/"+dashboardsTab.activeDashboard+"/active",type:"PUT"})})},dashboards)}function renameDashboard(value,settings){console.log("we want to rename this dashboard...")}function addWidget(){AddWidget.show(dashboardsTab.activeDashboard)}function manageDashboards(){ManageDashboards.show()}function setup(digest,timeUnit){status.handleComments()}var digest,dashboardData,dashboardsTab=new Tab("dashboards","Candide Kemmler","icon-chart",!0);return dashboardsTab.render=render,dashboardsTab.populateTemplate=populateTemplate,dashboardsTab}),define("applications/calendar/tabs/diary/Status",[],function(){function handleComments(){$(".diaryTitle").html($(".diaryTitle").attr("title")),$.ajax({url:"/diary/get/title",success:function(comment){$(".diaryTitle").css("min-height","20px"),$(".diaryTitle").empty(),$(".diaryTitle").val(comment),$(".diaryTitle").unbind(),$(".diaryTitle").keypress(function(e){code=e.keyCode?e.keyCode:e.which,code==13&&setDiaryTitle($(".diaryTitle").val())})}})}function setDiaryTitle(title){$.ajax({url:"/diary/set/title",data:{title:title},type:"POST",statusCode:{200:function(){applause(!1)}}})}function applause(persistent){var target=$(".qtip.jgrowl:visible:last"),praise=["Great Prose","Good job!","This is Great","I love that","Well said","You bet!","Absolutely right","Bellissimo!"],randomnumber=Math.floor(Math.random()*8);$(window).qtip({content:{text:praise[randomnumber]},position:{my:"top right",at:(target.length?"bottom":"top")+" right",target:target.length?target:$(window),adjust:{y:5,x:-5}},show:{event:!1,ready:!0,effect:function(){$(this).stop(0,1).fadeIn(400)},delay:0,persistent:persistent},hide:{event:!1,effect:function(api){$(this).stop(0,1).fadeOut(400).queue(function(){api.destroy(),updateGrowls()})}},style:{classes:"jgrowl ui-tooltip-dark ui-tooltip-rounded",tip:!1},events:{render:function(event,api){timer.call(api.elements.tooltip,event)}}}).removeData("qtip")}function timer(event){var api=$(this).data("qtip"),lifespan=3e3;if(api.get("show.persistent")===!0)return;clearTimeout(api.timer),event.type!=="mouseover"&&(api.timer=setTimeout(api.hide,lifespan))}window.updateGrowls=function(){var each=$(".qtip.jgrowl:not(:animated)");each.each(function(i){var api=$(this).data("qtip");api.options.position.target=i?each.eq(i-1):$(document.body),api.set("position.at",(i?"bottom":"top")+" right")})};var Diary={};return Diary.handleComments=handleComments,Diary}),define("applications/calendar/tabs/diary/DiaryTab",["applications/calendar/tabs/diary/Status","applications/calendar/tabs/Tab","applications/calendar/App"],function(status,Tab,Calendar){function render(digest,timeUnit){this.getTemplate("text!applications/calendar/tabs/diary/"+timeUnit.toLowerCase()+"Diary.html","diary-"+timeUnit,function(){setup(digest,timeUnit)})}function setup(digest,timeUnit){status.handleComments(),App.fullHeight(),$("textarea.tinymce").tinymce({script_url:"/static/tiny_mce/tiny_mce.js",theme:"advanced",plugins:"style",width:"100%",height:"95%",theme_advanced_buttons1:"bold,italic,underline,|,justifyleft,justifycenter,justifyright,justifyfull",theme_advanced_buttons2:"",theme_advanced_buttons3:"",theme_advanced_buttons4:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_resizing:!1,content_css:"/static/tiny_mce/css/content.css"})}var diaryTab=new Tab("diary","Candide Kemmler","icon-pencil",!0);return diaryTab.render=render,diaryTab}),define("applications/calendar/tabs/list/ListTab",["applications/calendar/tabs/Tab"],function(Tab){function render(digest,timeUnit,calendarState,connectorEnabled){$("#filtersContainer").show(),this.getTemplate("text!applications/calendar/tabs/list/list.html","list",function(){setup(digest,connectorEnabled)})}function setup(digest,connectorEnabled){initializing=!0,list=$("#list"),pagination=$("#pagination"),currentPage=0,items=[],itemGroups={},list.empty();for(var connectorName in digest.cachedData){if(!shouldDisplayInListView(connectorName))continue;for(var i=0;i<digest.cachedData[connectorName].length;i++){var item=$('<div style="overflow: auto;">'+digest.cachedData[connectorName][i].getDetails()+"</div>");item.facet=digest.cachedData[connectorName][i],item.visible=!0;var found=!1;for(var j=0;j<digest.selectedConnectors.length;j++){for(var k=0;!found&&k<digest.selectedConnectors[j].facetTypes.length;k++)found=item.facet.type==digest.selectedConnectors[j].facetTypes[k];if(found){item.visible=connectorEnabled[digest.selectedConnectors[j].connectorName];break}}for(var j=0;j<=items.length;j++){if(j==items.length){items[j]=item;break}if(items[j].facet.start>item.facet.start){items.splice(j,0,item);break}}itemGroups[item.facet.type]==null&&(itemGroups[item.facet.type]=[]),itemGroups[item.facet.type][itemGroups[item.facet.type].length]=item}}rebuildPagination(),repopulateList(),updateNumberOfEvents(),initializing=!1}function rebuildPagination(){pagination.empty();var totalPages=getTotalPages(),pageList=$("<ul></ul>"),button=$("<li "+(currentPage==0?"class='disabled'":"")+"><a href='#' pageNumber='prev'>&#171;</a></li>");pageList.append(button),button.click(paginationClickCallback);for(var i=0;i<totalPages;i++)button=$("<li "+(currentPage==i?"class='active'":"")+"><a href='#' pageNumber='"+i+"'>"+(i+1)+"</a></li>"),pageList.append(button),button.click(paginationClickCallback);button=$("<li "+(currentPage>=totalPages-1?"class='disabled'":"")+"><a href='#' pageNumber='next'>&#187;</a></li>"),pageList.append(button),button.click(paginationClickCallback),pagination.append(pageList)}function getTotalPages(){var totalCount=0;for(var i=0;i<items.length;i++)items[i].visible&&totalCount++;return Math.floor(totalCount/maxPerPage)+(totalCount%maxPerPage==0?0:1)}function updateNumberOfEvents(){var totalCount=0;for(var i=0;i<items.length;i++)items[i].visible&&totalCount++;$("#eventCount").empty().append(totalCount+" event"+(totalCount==1?"":"s"))}function repopulateList(){list.empty();var visibleCount=0;for(var i=0;i<items.length;i++){var item=items[i];item.visible&&(visibleCount++,visibleCount>currentPage*maxPerPage&&visibleCount<=(currentPage+1)*maxPerPage&&list.append(item))}list.children().length==0&&list.append("Sorry, no data to show.")}function paginationClickCallback(event){var pageNum=$(event.target).attr("pageNumber");if(pageNum=="prev"){if(currentPage==0)return;currentPage--}else if(pageNum=="next"){if(currentPage>=getTotalPages()-1)return;currentPage++}else{if(currentPage==pageNum)return;currentPage=pageNum}return rebuildPagination(),repopulateList(),!1}function shouldDisplayInListView(connectorId){switch(connectorId){case"google_latitude":case"bodytrack":return!1;default:return!0}}function connectorToggled(connectorName,objectTypeNames,enabled){for(var i=0;i<objectTypeNames.length;i++){if(itemGroups[objectTypeNames[i]]==null)continue;for(var j=0;j<itemGroups[objectTypeNames[i]].length;j++)itemGroups[objectTypeNames[i]][j].visible=enabled}var numPages=getTotalPages();numPages<currentPage&&(currentPage=numPages==0?0:numPages-1),rebuildPagination(),repopulateList(),updateNumberOfEvents()}var listTab=new Tab("list","Candide Kemmler","icon-list",!0),items,itemGroups,list,pagination,maxPerPage=10,currentPage=0,initializing;return listTab.render=render,listTab.connectorToggled=connectorToggled,listTab}),define("applications/calendar/tabs/map/MapTab",["applications/calendar/tabs/Tab","applications/calendar/App","applications/calendar/tabs/map/MapUtils"],function(Tab,Calendar,MapUtils){function render(digest,timeUnit,calendarState,connectorEnabled){$("#filtersContainer").show(),this.getTemplate("text!applications/calendar/tabs/map/map.html","map",function(){setup(digest,calendarState,connectorEnabled)})}function setup(digest,calendarState,connectorEnabled){digestData=digest,App.fullHeight(),$("#the_map").empty(),$("#mapFit").unbind("click");var bounds=null;map!=null&&(bounds=map.getBounds());var addressToUse={latitude:0,longitude:0};digest.addresses.ADDRESS_HOME!=null&&digest.addresses.ADDRESS_HOME.length!=0&&(addressToUse=digest.addresses.ADDRESS_HOME[0]),map=MapUtils.newMap(new google.maps.LatLng(addressToUse.latitude,addressToUse.longitude),17,"the_map",!1),map.setPreserveView(preserveView),map.isPreserveViewChecked()||(bounds=map.getBounds());if(digest!=null&&digest.cachedData!=null&&typeof digest.cachedData.google_latitude!="undefined"&&digest.cachedData.google_latitude!=null&&digest.cachedData.google_latitude.length>0){map.addGPSData(digest.cachedData.google_latitude),map.isPreserveViewChecked()||(bounds=map.gpsBounds),showData();for(var i=0;i<digest.selectedConnectors.length;i++)if(!connectorEnabled[digest.selectedConnectors[i].connectorName])for(var j=0;j<digest.selectedConnectors[i].facetTypes.length;j++)map.hideData(digest.selectedConnectors[i].facetTypes[j]);$("#mapFit").show(),$("#mapFit").click(function(){map.fitBounds(map.gpsBounds)})}else $("#mapFit").hide();bounds!=null&&map.fitBounds(bounds),map.preserveViewCheckboxChanged=function(){preserveView=map.isPreserveViewChecked()}}function showData(functionName){functionName!=null&&delete window[functionName];if(!map.isFullyInitialized()){var functionName="mapTimingFunction"+(new Date).getUTCMilliseconds();window[functionName]=showData,setTimeout("window."+functionName+'("'+functionName+'");',100);return}var digest=digestData;map.addAddresses(digest.addresses,!0);for(var objectTypeName in digest.cachedData){if(digest.cachedData[objectTypeName]==null||typeof digest.cachedData[objectTypeName]=="undefined")continue;map.addData(digest.cachedData[objectTypeName],objectTypeName,!0)}}function connectorToggled(connectorName,objectTypeNames,enabled){for(var i=0;i<objectTypeNames.length;i++)enabled?map.showData(objectTypeNames[i]):map.hideData(objectTypeNames[i])}var map=null,digestData=null,preserveView=!1,mapTab=new Tab("map","Candide Kemmler","icon-map-marker",!0);return mapTab.render=render,mapTab.connectorToggled=connectorToggled,mapTab}),define("applications/calendar/tabs/photos/PhotosTab",["applications/calendar/tabs/Tab","applications/calendar/App"],function(Tab,Calendar){function render(dgest,timeUnit,calendarState,cEn){this.getTemplate("text!applications/calendar/tabs/photos/photos.html","photos",function(){digest=dgest,connectorEnabled=cEn,setup(digest,connectorEnabled)})}function setup(digest,cEn){if(digest.cachedData["picasa-photo"]==null){showNoPhotos();return}onDataRecieved(digest.cachedData["picasa-photo"])}function showNoPhotos(){$("#photoTab").empty(),$("#photoTab").append('<div class="emptyList">(no photos)</div>')}function onDataRecieved(photos){var data=[];$("#photoTab").empty();for(var i=0;i<photos.length;i++)for(var j=0;j<digest.selectedConnectors.length;j++){var found=!1;for(var k=0;!found&&k<digest.selectedConnectors[j].facetTypes.length;k++)found=digest.selectedConnectors[j].facetTypes[k]==photos[i].type;found&&connectorEnabled[digest.selectedConnectors[j].connectorName]&&(data[data.length]=photos[i])}for(var i=0;i<data.length;i++)data[i].active=i==0,data[i].id=i;$("#photoTab").empty();if(data.length==0){showNoPhotos();return}App.loadMustacheTemplate("applications/calendar/tabs/photos/photosTemplate.html","carousel",function(template){var carouselHTML=template.render({photos:data,includeNav:data.length>1});App.loadMustacheTemplate("applications/calendar/tabs/photos/photosTemplate.html","thumbnailGroup",function(template){var currentGroup=[],currentDate=null;for(var i=0;i<data.length;i++){var date=new Date(data[i].start);if(currentDate==null)currentDate=date;else if(currentDate.getMonth()!=date.getMonth()||currentDate.getYear()!=date.getYear()||currentDate.getDate()!=date.getDate())$("#photoTab").append(template.render({date:App.formatDate(currentDate),photos:currentGroup})),currentGroup=[],currentDate=date;currentGroup[currentGroup.length]=data[i]}currentGroup.length!=0&&$("#photoTab").append(template.render({date:App.formatDate(currentDate),photos:currentGroup}));for(var i=0;i<data.length;i++)$("#photo-"+i).click({i:i},function(event){App.makeModal(carouselHTML),App.carousel(event.data.i)})})})}function connectorToggled(connectorName,objectTypeNames,enabled){connectorEnabled[connectorName]=enabled,setup(digest,connectorEnabled)}var connectorEnabled,digest,photosTab=new Tab("photos","Candide Kemmler","icon-camera",!0);return photosTab.render=render,photosTab.connectorToggled=connectorToggled,photosTab}),define("applications/calendar/tabs/timeline/BodyTrack",[],function(){var APP,PREFS,TOOLS,LOGIN,TAG_MANAGER,VIEWS,SOURCES,BodyTrack={};return APP={isInitialized:!1,init:function(callback){LOGIN.getStatus(function(data){LOGIN.user_id>-1&&(VIEWS.getAvailableList(function(){callback()}),TAG_MANAGER.init())})}},PREFS={__map:{},reset:function(){PREFS.__map={}},get:function(keysStr,defaultVal){if(typeof keysStr=="string"&&keysStr.length>0){var keys=keysStr.split("."),o=PREFS.__map;for(var i=0;i<keys.length;i++){var key=keys[i];if(typeof o[key]!="undefined"){o=o[key];if(i==keys.length-1)return o}}}return defaultVal},set:function(keysStr,value){if(typeof keysStr=="string"&&keysStr.length>0&&typeof value!="undefined"){var keys=keysStr.split("."),o=PREFS.__map;for(var i=0;i<keys.length;i++){var key=keys[i];typeof o[key]!="object"&&(o[key]={});if(i==keys.length-1)return o[key]=value,!0;o=o[key]}}return!1}},TOOLS={resizeTimer:null,resizeCallbackList:[],resizeElements:[],onWindowResizeListener:function(callback){TOOLS.resizeCallbackList.push(callback)},onWindowResizeResizeElementHeight:function(el){TOOLS.resizeElements.push(el)},resizeHandler:function(){var i,l;l=TOOLS.resizeCallbackList.length;for(i=0;i<l;i++)TOOLS.resizeCallbackList[i]();l=TOOLS.resizeElements.length;for(i=0;i<l;i++)TOOLS.resizeElementHeight($(TOOLS.resizeElements[i]))},resizeElementHeight:function(element){if(element!=null&&element.length>0){var height=0,body=window.document.body;window.innerHeight?height=window.innerHeight:body.parentElement.clientHeight?height=body.parentElement.clientHeight:body&&body.clientHeight&&(height=body.clientHeight),element.height(height-element.offset().top-85+"px")}},parseInt:function(intStr,defaultVal){var val=parseInt(intStr);return isNaN(val)?defaultVal:val},clone:function(obj){return jQuery.extend(!0,{},obj)},loadJson:function(url,urlParams,callbacks){if(typeof url!="undefined"){urlParams||(urlParams={}),typeof callbacks=="undefined"&&(callbacks={});var successCallback=callbacks.success,errorCallback=callbacks.error,completeCallback=callbacks.complete;$.ajax({cache:!1,type:"GET",url:url,data:urlParams,success:function(data,textStatus,jqXHR){try{typeof successCallback=="function"&&successCallback(typeof data=="string"?JSON.parse(data):data)}catch(ex){console.log("loadJson.success: JSON parse error, or failure in the successCallback: "+ex)}},error:function(jqXHR,textStatus,errorThrown){try{typeof errorCallback=="function"&&errorCallback(textStatus,errorThrown)}catch(ex){console.log("loadJson.error: Failure in the errorCallback: "+ex)}},complete:function(jqXHR,textStatus){try{typeof completeCallback=="function"&&completeCallback(textStatus)}catch(ex){console.log("loadJson.complete: Failure in the completeCallback: "+ex)}}})}}},TAG_MANAGER={tags:[],refreshTagCache:function(successCallback){var caseInsensitiveSort=function(tag1,tag2){var a=tag1.toLowerCase(),b=tag2.toLowerCase();return a<b?-1:a>b?1:0};TOOLS.loadJson("/bodytrack/users/"+LOGIN.user_id+"/tags",{},{success:function(data,textStatus,jqXHR){try{var jsonData=typeof data=="string"?JSON.parse(data):data;jQuery.isArray(jsonData)&&(TAG_MANAGER.tags=jsonData.sort(caseInsensitiveSort)),typeof successCallback=="function"&&successCallback()}catch(ex){console.log("TAG_MANAGER.refreshTagCache.success: Failed to parse tag array:"+ex)}},error:function(jqXHR,textStatus,errorThrown){console.log("TAG_MANAGER.refreshTagCache.error: Failed to fetch tags:"+errorThrown)}})},getCachedTagsForTagEditor:function(tagsToExclude){jQuery.isArray(tagsToExclude)||(tagsToExclude=[]);var excludedTags={};jQuery.each(tagsToExclude,function(index,val){excludedTags[val]=1});var cachedTagsData=new Array;return TAG_MANAGER.tags.length>0&&jQuery.each(TAG_MANAGER.tags,function(index,val){typeof excludedTags[val]=="undefined"&&(cachedTagsData[cachedTagsData.length]={id:"_tag_"+index,label:val,value:val})}),cachedTagsData.sort()},init:function(){TAG_MANAGER.refreshTagCache()}},LOGIN={user_id:-1,getStatus:function(callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/UID",success:function(data,textStatus,jqXHR){var parsed=JSON.parse(data);typeof parsed!="undefined"&&typeof parsed.user_id!="undefined"&&(LOGIN.user_id=parsed.user_id),typeof callback=="function"&&callback(parsed)}})}},VIEWS={data:"",availableList:[],saveCallbackList:[],getAvailableList:function(callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/users/"+LOGIN.user_id+"/views",success:function(data,textStatus,jqXHR){var parsed=JSON.parse(data);VIEWS.availableList=parsed.views,typeof callback=="function"&&callback(parsed.views)},error:function(jqXHR,textStatus,errorThrown){VIEWS.availableList=[]}})},load:function(id,callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/users/"+LOGIN.user_id+"/views/get",data:{id:id},success:function(data,textStatus,jqXHR){VIEWS.data=JSON.parse(data),typeof callback=="function"&&callback(VIEWS.data)}})},save:function(name,callback){VIEWS.data.name=name,$.ajax({cache:!1,type:"POST",url:"/bodytrack/users/"+LOGIN.user_id+"/views/set",data:{name:name,data:JSON.stringify(VIEWS.data)},success:function(data,textStatus,jqXHR){var i,l,parsed=JSON.parse(data);VIEWS.availableList=parsed.views,l=VIEWS.saveCallbackList.length;for(i=0;i<l;i++)VIEWS.saveCallbackList[i]();typeof callback=="function"&&callback(parsed.views,parsed.saved_view_id)}})},onSaveListener:function(callback){VIEWS.saveCallbackList.push(callback)}},SOURCES={availableList:[],configuredList:[],discoveryList:[],getAvailableList:function(callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/users/"+LOGIN.user_id+"/sources/list",success:function(data,textStatus,jqXHR){var parsed=JSON.parse(data);SOURCES.availableList=parsed.sources,typeof callback=="function"&&callback(parsed.sources)},error:function(jqXHR,textStatus,errorThrown){SOURCES.availableList=[],console.log("Error fetching available list")}})},getConfiguredList:function(callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/users/"+LOGIN.user_id+"/sources",success:function(data,textStatus,jqXHR){var parsed=JSON.parse(data);SOURCES.configuredList=parsed.sources,typeof callback=="function"&&callback(parsed.sources)},error:function(jqXHR,textStatus,errorThrown){SOURCES.configuredList=[],console.log("Error fetching configured list")}})},getDiscoveryList:function(callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/users/"+LOGIN.user_id+"/sources/discovery",success:function(data,textStatus,jqXHR){var parsed=JSON.parse(data);SOURCES.discoveryList=parsed.sources,typeof callback=="function"&&callback(parsed.sources)},error:function(jqXHR,textStatus,errorThrown){SOURCES.discoveryList=[],console.log("Error fetching discovery list")}})},getDefaultGraphSpecs:function(device_name,callback){$.ajax({cache:!1,type:"GET",url:"/bodytrack/users/"+LOGIN.user_id+"/sources/default_graph_specs",data:{name:device_name},success:function(data,textStatus,jqXHR){typeof callback=="function"&&callback(JSON.parse(data).info)},error:function(jqXHR,textStatus,errorThrown){console.log("Error fetching default graph specs")}})}},BodyTrack.APP=APP,BodyTrack.PREFS=PREFS,BodyTrack.TOOLS=TOOLS,BodyTrack.LOGIN=LOGIN,BodyTrack.TAG_MANAGER=TAG_MANAGER,BodyTrack.VIEWS=VIEWS,BodyTrack.SOURCES=SOURCES,window.BodyTrack=BodyTrack,BodyTrack}),define("applications/calendar/tabs/timeline/TimelineTab",["applications/calendar/tabs/Tab","core/FlxState","applications/calendar/tabs/timeline/BodyTrack","applications/calendar/App"],function(Tab,FlxState,BodyTrack,Calendar){function __createDatasource(urlPrefix,urlParams){return urlParams||(urlParams={}),function(level,offset,success_callback,failure_callback){var onerr=function(jqXHR,textStatus,errorThrown){try{failure_callback&&failure_callback(errorThrown)}catch(ex){console.log("channelDatasource.onErr(): FAILURE! ex:"+ex)}};$.ajax({url:urlPrefix+level+"."+offset+".json",data:urlParams,success:function(data,textStatus,jqXHR){try{success_callback&&success_callback(typeof data=="string"?data:JSON.stringify(data))}catch(ex){onerr(jqXHR,"JSON parse error",ex)}},failure:onerr})}}function init(callback){$(window).bind("beforeunload",function(){updateViewData();var newvdata=JSON.stringify(VIEWS.data);loadedViewStr!=newvdata&&(hasUnsavedChanges=!0);if(hasUnsavedChanges)return"You have unsaved changes"}),$("form").submit(function(){$(window).unbind("beforeunload")}),TOOLS.onWindowResizeResizeElementHeight("#_timeline_addChannelsArea #_timeline_sources_list"),TOOLS.onWindowResizeResizeElementHeight("#_timeline_channelsWrapper"),TOOLS.onWindowResizeListener(function(){var borderOffset=2,widthOfAreaLeftOfPlotContainer=$("._timeline_channeltd").width()+borderOffset,widthOfAreaRightOfPlotContainer=$("._timeline_yaxistd").width()+borderOffset,widthOfPlotContainerLeftAndRightBorder=2,plotContainerWidth=$("#_timeline_channelsArea").width()-widthOfAreaLeftOfPlotContainer-widthOfAreaRightOfPlotContainer-widthOfPlotContainerLeftAndRightBorder-20,plotContainerEventId=SequenceNumber.getNext();for(var i=0;i<plotContainers.length;i++){var plotContainerHeight=$("#"+plotContainers[i].getPlaceholder()).height();plotContainers[i].setSize(plotContainerWidth,plotContainerHeight,plotContainerEventId)}dateAxis&&dateAxis.setSize(plotContainerWidth,$("#_timeline_dateAxis").height(),SequenceNumber.getNext());var yAxisWidth=$("._timeline_yAxis").width();for(var plotKey in plotsMap){var plot=plotsMap[plotKey];if(plot){var yAxis=plot.getVerticalAxis(),yAxisHeight=$("#"+yAxis.getPlaceholder()).height();yAxis&&yAxis.setSize(yAxisWidth,yAxisHeight)}}}),$("#_timeline_channels").sortable({handle:"._timeline_channelTab",axis:"y",tolerance:"pointer",containment:"#_timeline_channels",merge:function(event,ui){var templateValues={deviceName:"Devices",channelName:"Compare Stub",plotElementId:"_timeline_channel_helper",channelElementId:"_timeline_plot_helper",yAxisElementId:"_timeline_yAxis_helper"},html=Hogan.compile($("#_timeline_channel_template").html()).render(templateValues);$(ui.item[0]).remove(),$(ui.droppable.item[0]).replaceWith(html)},mergein:function(event,ui){$(ui.droppable.item[0]).addClass("_timeline_channel_hover")},mergeout:function(event,ui){$(ui.droppable.item[0]).removeClass("_timeline_channel_hover")},receive:function(event,ui){var i,l,c,src=sourcesMap[dragSourceId];c=$("#_timeline_channels").children(),l=c.length;for(i=0;i<l;i++)c[i].id==""&&addChannel(src,c[i])}}),$("#_timeline_channels").disableSelection(),$("#_timeline_new_view_btn").click(newView),updateLoadViewDropdown(),updateSaveViewDropdown(),$("#_timeline_save_view_dropdown").click(function(event){$("#_timeline_save_view_dropdown_name").doTimeout(100,"focus")}),$("#_timeline_save_view_btn").click(function(event){event.preventDefault();if($(event.delegateTarget).hasClass("disabled"))return;$("#_timeline_viewName").text()!=newViewName?saveView($("#_timeline_viewName").text()):$("#_timeline_save_view_dropdown").doTimeout(50,"click")}),$("#_timeline_gotoBeginning_button").click(function(){gotoTime("beginning")}),$("#_timeline_gotoBack_button").click(function(){gotoTime("back")}),$("#_timeline_gotoForward_button").click(function(){gotoTime("forward")}),$("#_timeline_gotoEnd_button").click(function(){gotoTime("end")}),$("#_timeline_zoomOut_button").click(function(){zoomTime("out")}),$("#_timeline_zoomIn_button").click(function(){zoomTime("in")}),$("#_timeline_photo_dialog").dialog({autoOpen:!1,modal:!0,width:"auto",height:"auto",minWidth:340,resizable:!1}),getSources(function(){console.log("getSources is called"),$("#_timeline_messageArea").hide(),$("#_timeline_mainContentArea").show(),typeof callback=="function"&&(console.log("callback is called: "+callback),callback())})}function updateLoadViewDropdown(){App.loadMustacheTemplate("applications/calendar/tabs/timeline/timelineTemplates.html","loadViewsDropdown",function(template){VIEWS.availableList[0].first=!0;var newloadDropdown=$(template.render(VIEWS));delete VIEWS.availableList[0].first,$("#_timeline_load_view_submenu").replaceWith(newloadDropdown),$("a._timeline_load_link").click(function(event){event.preventDefault();var viewId=$(event.delegateTarget).attr("viewid"),mode=$(event.delegateTarget).hasClass("_timeline_channel_only")?"channel":$(event.delegateTarget).hasClass("_timeline_time_only")?"time":"all";loadViewDialogModeHandler(viewId,mode)})})}function updateSaveViewDropdown(){App.loadMustacheTemplate("applications/calendar/tabs/timeline/timelineTemplates.html","saveViewDropdown",function(template){VIEWS.viewsPresent=VIEWS.availableList.length!=0;var newSaveDropDown=$(template.render(VIEWS));delete VIEWS.viewsPresent,$("#_timeline_save_view_dropdown-submenu").replaceWith(newSaveDropDown),$("a._timeline_save_view_dropdown_save_link").click(function(event){event.preventDefault();var viewname=$(event.delegateTarget).attr("viewname");saveView(viewname)}),$("#_timeline_save_view_dropdown_save_btn").click(function(event){event.preventDefault(),saveView($("#_timeline_save_view_dropdown_name").val())})})}function checkForTimelineChanges(){var newvdata;if(VIEWS.data!=""){updateViewData(),newvdata=JSON.stringify(VIEWS.data);if(loadedViewStr!=newvdata)return hasUnsavedChanges=!0,confirm("You have unsaved changes. Do you wish to continue?")}}function getSourceChannelByName(device_name,channel_name){var i,j,l,m,src,channel;l=SOURCES.availableList.length;for(i=0;i<l;i++){src=SOURCES.availableList[i];if(device_name===src.name){m=src.channels.length;for(j=0;j<m;j++){channel=src.channels[j];if(channel_name===channel.name)return channel}}}return null}function getSources(callback){console.log("about to getAvailableList."),SOURCES.getAvailableList(function(data){console.log("getting available list");var i,j,l,m,src,idx=0;l=SOURCES.availableList.length;for(i=0;i<l;i++){src=SOURCES.availableList[i],m=src.channels.length;for(j=0;j<m;j++)src.channels[j].id="src_"+idx,sourcesMap["src_"+idx]={device_name:src.name,channel_name:src.channels[j].name,min:src.channels[j].min,max:src.channels[j].max,style:src.channels[j].style},src.channels[j].hasOwnProperty("min_time")&&src.channels[j].hasOwnProperty("max_time")&&(sourcesMap["src_"+idx].min_time=src.channels[j].min_time,sourcesMap["src_"+idx].max_time=src.channels[j].max_time),idx+=1}$("#_timeline_addChannelsArea").html(Hogan.compile($("#_timeline_sources_template").html()).render({sources:SOURCES.availableList})),$("#_timeline_addChannelsArea ul ._timeline_sources_channel").draggable({connectToSortable:"#_timeline_channels",revert:"invalid",helper:function(){var src=sourcesMap[this.id];dragSourceId=this.id;var templateValues={deviceName:src.device_name,channelName:src.channel_name,plotElementId:"_timeline_channel_helper",channelElementId:"_timeline_plot_helper",yAxisElementId:"_timeline_yAxis_helper"};return Hogan.compile($("#_timeline_channel_template").html()).render(templateValues)},start:function(event,ui){$(this).height("74px")},stop:function(event,ui){$(this).height("16px")}}),$("#_timeline_addChannelsArea ul ._timeline_sources_channel").disableSelection(),$("#_timeline_addChannelsArea ul li ._timeline_sources_channel").click(function(){var c=sourcesMap[this.id];addChannel(c,null),$("#_timeline_channelsWrapper").animate({scrollTop:$("#_timeline_channelsWrapper").prop("scrollHeight")},500)}),$("#_timeline_addChannelsArea #_timeline_sources_find_btn").click(function(){return $("#_timeline_addChannelsArea input[type=text]").val(""),addPaneRestoreState(),!1}),$("#_timeline_addChannelsArea input[type=text]").keyup(function(event){var search_str=$("#_timeline_addChannelsArea input[type=text]").val(),regexp=new RegExp(search_str,"i");if(search_str.length===0){addPaneRestoreState();return}$("._timeline_sources_name").each(function(){var ul=$(this).parent().find("ul"),arrow=$(this).children("._timeline_sources_name_arrow");ul.css("display")==="none"&&(ul.show(),arrow.html("&#9660;"))}),$("#_timeline_addChannelsArea #_timeline_sources_list ._timeline_sources_channel").each(function(){$.trim($(this).html()).search(regexp)==-1?$(this).hide():$(this).show()})}),$("._timeline_sources_name").click(function(){var ul=$(this).parent().find("ul"),arrow=$(this).children("._timeline_sources_name_arrow");ul.css("display")==="none"?(ul.show(),arrow.html("&#9660;")):(ul.hide(),arrow.html("&#9658;")),addPaneSaveState()}),addPaneSaveState(),typeof callback=="function"&&callback()})}function addPaneRestoreState(){var i=0,l=addPaneChannelsState.length;$("#_timeline_addChannelsArea #_timeline_sources_list ._timeline_sources_channel").each(function(){$(this).show()}),l>0&&$("._timeline_sources_name").each(function(){var ul=$(this).parent().find("ul"),arrow=$(this).children("._timeline_sources_name_arrow"),state=addPaneChannelsState[i];state==0?(ul.hide(),arrow.html("&#9658;")):(ul.show(),arrow.html("&#9660;")),i++})}function addPaneSaveState(){addPaneChannelsState=[],$("._timeline_sources_name").each(function(){var ul=$(this).parent().find("ul");ul.css("display")==="none"?addPaneChannelsState.push(!1):addPaneChannelsState.push(!0)})}function newView(){var now=new Date;now=now.getTime()/1e3,newView(now-86400,now)}function newView(start,end){VIEWS.data={name:newViewName,v2:{x_axis:{min:start,max:end},y_axes:[]}},console.log("newView is being called"),loadedViewStr=JSON.stringify(VIEWS.data),hasUnsavedChanges=!0,renderView(VIEWS.data),$("#_timeline_addChannelsArea").css("display")==="none"&&toggleAddChannelsPane()}function loadView(id,mode,callback){$("#_timeline_save_view_btn").addClass("disabled"),VIEWS.load(id,function(data){loadedViewStr=JSON.stringify(data),hasUnsavedChanges=!1,renderView(data,mode),typeof callback=="function"&&callback()})}function loadViewWithTimeRange(id,min,max,callback){$("#_timeline_save_view_btn").addClass("disabled"),VIEWS.load(id,function(data){loadedViewStr=JSON.stringify(data),hasUnsavedChanges=!0,data.v2.x_axis.min=min,data.v2.x_axis.max=max,renderView(data),typeof callback=="function"&&callback()})}function saveView(name){updateViewData(),VIEWS.save(name,function(data,id){loadedViewStr=JSON.stringify(VIEWS.data),hasUnsavedChanges=!1,updateLoadViewDropdown(),updateSaveViewDropdown(),loadView(id)})}function loadSource(device_name,callback){SOURCES.getDefaultGraphSpecs(device_name,function(data){var i,l;VIEWS.data={name:newViewName,v2:{x_axis:{min:data.min_time,max:data.max_time},y_axes:[]}},l=data.channels.length;for(i=0;i<l;i++)VIEWS.data.v2.y_axes.push({device_name:device_name,channel_name:data.channels[i].name,min:data.channels[i].min,max:data.channels[i].max,style:data.channels[i].style,channel_height:data.channels[i].channel_height});loadedViewStr=JSON.stringify(VIEWS.data),hasUnsavedChanges=!0,renderView(VIEWS.data),$("#_timeline_addChannelsArea").css("display")!=="none"&&toggleAddChannelsPane(),typeof callback=="function"&&callback()})}function loadViewDialogModeHandler(view_id,mode){var min,max;return checkForTimelineChanges()===!1?!1:mode==="time"?(loadView(view_id,mode),!1):mode==="channel"?VIEWS.data===""?(alert("Existing view not found"),!1):(min=VIEWS.data.v2.x_axis.min,max=VIEWS.data.v2.x_axis.max,loadViewWithTimeRange(view_id,min,max,function(){TOOLS.resizeHandler()}),!1):(loadView(view_id),!0)}function toggleAddChannelsPane(){var area=$("#_timeline_addChannelsArea");return area.css("display")==="none"?($("#_timeline_add_channels_btn").addClass("button_toggle"),area.show(),TOOLS.resizeElementHeight($("#_timeline_addChannelsArea #_timeline_sources_list"))):($("#_timeline_add_channels_btn").removeClass("button_toggle"),area.hide()),TOOLS.resizeHandler(),!1}function toggleLoadDialog(){return $("#_timeline_save_view_btn").hasClass("button_toggle")&&toggleSaveDialog(),$("#_timeline_view_dialog").css("display")==="none"?($("#_timeline_load_view_btn").addClass("button_toggle"),$("#_timeline_view_dialog").html(Hogan.compile($("#_timeline_view_load_template").html()).render({available_views:VIEWS.availableList})).show(),$("#_timeline_view_dialog .close_btn").unbind("click").click(function(){toggleLoadDialog()}),$("#_timeline_view_dialog ul li a").unbind("click").click(function(){$("#_timeline_load_view_btn").removeClass("button_toggle"),$("#_timeline_view_dialog").hide(),loadViewDialogModeHandler($(this).attr("id").substr(15))})):($("#_timeline_load_view_btn").removeClass("button_toggle"),$("#_timeline_view_dialog").hide()),!1}function toggleSaveDialog(){var viewName;return $("#_timeline_load_view_btn").hasClass("button_toggle")&&toggleLoadDialog(),$("#_timeline_view_dialog").css("display")==="none"?($("#_timeline_save_view_btn").addClass("button_toggle"),$("#_timeline_view_dialog").html(Hogan.compile($("#_timeline_view_save_template").html()).render({available_views:VIEWS.availableList})).show(),viewName=VIEWS.data.name,viewName!=newViewName&&$("#_timeline_view_dialog input").val(VIEWS.data.name),$("#_timeline_view_dialog input").focus(),$("#_timeline_view_dialog .close_btn").unbind("click").click(function(){toggleSaveDialog()}),$("#_timeline_view_dialog div .button").unbind("click").click(function(){var name=$("#_timeline_view_dialog input").val();return name!=""?(saveView(name),$("#_timeline_save_view_btn").removeClass("button_toggle"),$("#_timeline_view_dialog").hide()):$("._timeline_view_dialog_status").html("Please enter a name for this view"),!1}),$("#_timeline_view_dialog ul li a").unbind("click").click(function(){return $("#_timeline_view_dialog input").val(this.text),!1})):($("#_timeline_save_view_btn").removeClass("button_toggle"),$("#_timeline_view_dialog").hide()),!1}function toggleDetailsPane(){var area=$("#_timeline_detailsArea");return area.css("display")==="none"?($("#_timeline_show_details_btn").addClass("button_toggle"),area.show()):($("#_timeline_show_details_btn").removeClass("button_toggle"),area.hide()),TOOLS.resizeHandler(),!1}function addChannel(channel,target){var max_time;channel=TOOLS.clone(channel),id=channelIdx,channelIdx+=1;var channelElementId="_timeline_channel_"+id,plotElementId="_timeline_plot_"+id,yAxisElementId="_timeline_yAxis_"+id,templateValues={deviceName:channel.device_name,channelName:channel.channel_name,channelHeight:channel.channel_height,channelTabHeight:channel.channel_height+CHANNEL_PADDING,CHANNEL_PADDING:CHANNEL_PADDING,plotId:id,plotElementId:plotElementId,channelElementId:channelElementId,yAxisElementId:yAxisElementId},html=Hogan.compile($("#_timeline_channel_template").html()).render(templateValues);target==null||target==undefined||target==""?$("#_timeline_channels").append(html):$(target).replaceWith(html),$("#"+channelElementId+"-timeline-channel-name").html(channel.channel_name).shorten();var yAxis=new NumberAxis(yAxisElementId,"vertical",{min:channel.min,max:channel.max});VIEWS.data["name"]==newViewName&&channel.hasOwnProperty("max_time")&&$("#_timeline_channels ._timeline_channel").length==0&&(max_time=channel.max_time,dateAxis.setRange(max_time-86400,max_time));var plot=null;if("photos"==channel["channel_name"]){var tags=[],willJoinUsingAnd=!1,photoStyle=channel.style;typeof photoStyle!="undefined"&&typeof photoStyle.filters!="undefined"&&typeof photoStyle.filters.tag!="undefined"&&(jQuery.isArray(photoStyle.filters.tag.tags)&&(tags=photoStyle.filters.tag.tags),willJoinUsingAnd=!!photoStyle.filters.tag.isAndJoin),plot=new PhotoSeriesPlot(photoDatasource(LOGIN.user_id,channel.device_name,tags,willJoinUsingAnd),dateAxis,yAxis,LOGIN.user_id,channel.style),plot.addDataPointListener(photoDataPointListener(channelElementId))}else if("comments"==channel["channel_name"]){var commentStyle=channel.style;typeof commentStyle!="undefined"&&typeof commentStyle.filters!="undefined"&&typeof commentStyle.filters.tag!="undefined"&&(jQuery.isArray(commentStyle.filters.tag.tags)&&(tags=commentStyle.filters.tag.tags),willJoinUsingAnd=!!commentStyle.filters.tag.isAndJoin),alert("Implement commentDatasource and CommentSeriesPlot")}else plot=new DataSeriesPlot(channelDatasource(LOGIN.user_id,channel.device_name,channel.channel_name),dateAxis,yAxis,channel.style),plot.addDataPointListener(dataPointListener);var plotContainer=new PlotContainer(plotElementId,[plot]);channelsMap[channelElementId]=channel,plotsMap[channelElementId]=plot,plotContainersMap[channelElementId]=plotContainer,plotContainers.push(plotContainer),$("._timeline_btnGear").unbind("click").click(function(){var channelConfigElement=$(this).parents("._timeline_channel").children("._timeline_channelConfig");channelConfigElement.toggle(),channelConfigElement.css("display")==="none"?$(this).find("img").attr("src","/static/images/gear_b.png"):$(this).find("img").attr("src","/static/images/gear_green.png")}),$("#"+channelElementId+"_delete_btn").unbind("click").click(function(){var channelElement=$(this).parents("._timeline_channel").parent();plotContainer.removePlot(plot),$(channelElement).remove()}),$("#"+channelElementId+"_dragArea").unbind("mousedown").mousedown(function(){var channelElement=$(this).parents("._timeline_channel").parent();dragAreaOnMouseDown(channelElement.attr("id").slice(18))});if(plot instanceof DataSeriesPlot){var updateDataSeriesPlotChannelConfig=function(){var channelElement=$(this).parents("._timeline_channel").parent(),plot=plotsMap[channelElement.attr("id")],newStyle=plot.getStyle();newStyle.styles=[],newStyle.highlight={},newStyle.highlight.styles=[];var isZeo=$("#"+channelElementId+"-config-zeo-show").is(":checked"),highlightLineWidth=0;if(isZeo)newStyle.styles[newStyle.styles.length]={type:"zeo",show:!0},highlightLineWidth=1;else{var linesStyle={type:"line",show:$("#"+channelElementId+"-config-lines-show").is(":checked"),color:$("#"+channelElementId+"-config-lines-color").next(".color_picker").css("background-color"),lineWidth:TOOLS.parseInt($("#"+channelElementId+"-config-lines-lineWidth").val(),1)},pointsStyleType=$("#"+channelElementId+"-config-points-type").val(),pointsStyleFill=pointsStyleType.match(/-filled$/)!==null,pointsStyle={type:pointsStyleType.replace("-filled",""),show:$("#"+channelElementId+"-config-points-show").is(":checked"),lineWidth:1,radius:TOOLS.parseInt($("#"+channelElementId+"-config-points-radius").val(),2),color:$("#"+channelElementId+"-config-points-color").next(".color_picker").css("background-color"),fill:pointsStyleFill,fillColor:$("#"+channelElementId+"-config-points-fillColor").next(".color_picker").css("background-color")},barsStyle={type:"lollipop",show:$("#"+channelElementId+"-config-bars-show").is(":checked"),lineWidth:TOOLS.parseInt($("#"+channelElementId+"-config-bars-lineWidth").val(),1),radius:0,color:$("#"+channelElementId+"-config-bars-color").next(".color_picker").css("background-color"),fill:!1};newStyle.styles[newStyle.styles.length]=linesStyle,newStyle.styles[newStyle.styles.length]=barsStyle,newStyle.styles[newStyle.styles.length]=pointsStyle,linesStyle.show&&(highlightLineWidth=Math.max(highlightLineWidth,linesStyle.lineWidth)),barsStyle.show&&(highlightLineWidth=Math.max(highlightLineWidth,barsStyle.lineWidth)),highlightLineWidth+=1}var valuesStyle={type:"value",show:$("#"+channelElementId+"-config-values-show").is(":checked"),fillColor:$("#"+channelElementId+"-config-values-fillColor").next(".color_picker").css("background-color"),marginWidth:TOOLS.parseInt($("#"+channelElementId+"-config-values-marginWidth").val(),5),verticalOffset:TOOLS.parseInt($("#"+channelElementId+"-config-values-verticalOffset").val(),7),numberFormat:$("#"+channelElementId+"-config-values-numberFormat").val()};newStyle.highlight.styles[newStyle.highlight.styles.length]=valuesStyle;var onlyShowValuesOnHighlight=$("#"+channelElementId+"-config-values-showOnlyOnHighlight").val()==="true";if(onlyShowValuesOnHighlight){var valuesStyleCopy=TOOLS.clone(valuesStyle);valuesStyleCopy.show=!1,newStyle.styles[newStyle.styles.length]=valuesStyleCopy}else newStyle.styles[newStyle.styles.length]=valuesStyle;newStyle.highlight.lineWidth=highlightLineWidth;var commentsStyleType=$("#"+channelElementId+"-config-comments-type").val(),commentsStyleFill=commentsStyleType.match(/-filled$/)!==null;newStyle.comments={show:$("#"+channelElementId+"-config-comments-show").is(":checked"),styles:[{type:commentsStyleType.replace("-filled",""),show:$("#"+channelElementId+"-config-comments-show").is(":checked"),lineWidth:1,radius:TOOLS.parseInt($("#"+channelElementId+"-config-comments-radius").val(),3),color:$("#"+channelElementId+"-config-comments-color").next(".color_picker").css("background-color"),fill:commentsStyleFill,fillColor:$("#"+channelElementId+"-config-comments-fillColor").next(".color_picker").css("background-color")}],verticalMargin:4},plot.setStyle(newStyle)};$("#"+channelElementId+" ._timeline_data_series_plot_config").show();var isZeo=channel["channel_name"]=="Sleep_Graph";channel.style.hasOwnProperty("styles")||(channel.style.styles=[]),channel.style.hasOwnProperty("highlight")||(channel.style.highlight={}),channel.style.highlight.hasOwnProperty("styles")||(channel.style.highlight.styles=[]),channel.style.hasOwnProperty("comments")||(channel.style.comments={}),channel.style.comments.hasOwnProperty("styles")||(channel.style.comments.styles=[]);var defaultColor="#"+jQuery.fn.colorPicker.getNextColor(),linesStyle={type:"line",show:!1,lineWidth:1,color:defaultColor},pointsStyle={type:"point",show:!1,radius:2,fill:!0,color:defaultColor,fillColor:defaultColor},barsStyle={type:"lollipop",show:!1,color:defaultColor},valuesStyle1={type:"value",show:!1,fillColor:defaultColor},valuesStyle2={type:"value",show:!1,fillColor:defaultColor},commentsStyle={type:"point",show:!0,radius:3,fill:!0,color:defaultColor,fillColor:defaultColor};for(var styleTypeIndex=0;styleTypeIndex<channel.style.styles.length;styleTypeIndex++){var theStyle=channel.style.styles[styleTypeIndex];typeof theStyle["type"]!="undefined"&&(theStyle["type"]=="line"?linesStyle=theStyle:theStyle["type"]=="point"||theStyle["type"]=="square"||theStyle["type"]=="cross"||theStyle["type"]=="plus"?(typeof theStyle["fill"]=="undefined"&&(theStyle.fill=!0),pointsStyle=theStyle):theStyle["type"]=="lollipop"?(typeof theStyle["fill"]=="undefined"&&(theStyle.fill=!0),barsStyle=theStyle):theStyle["type"]=="value"&&(valuesStyle1=theStyle),typeof theStyle["show"]=="undefined"&&(theStyle.show=!0))}pointsStyle["type-ui"]=pointsStyle.type,pointsStyle.fill&&(pointsStyle["type"]=="point"||pointsStyle["type"]=="square")&&(pointsStyle["type-ui"]+="-filled");for(var highlightStyleTypeIndex=0;highlightStyleTypeIndex<channel.style.highlight.styles.length;highlightStyleTypeIndex++){var theHighlightStyle=channel.style.highlight.styles[highlightStyleTypeIndex];theHighlightStyle["type"]=="value"&&(valuesStyle2=theHighlightStyle),typeof theHighlightStyle["show"]=="undefined"&&(theHighlightStyle.show=!0)}var valuesStyle=jQuery.extend(!0,{},valuesStyle1,valuesStyle2);valuesStyle.show=valuesStyle1.show||valuesStyle2.show,valuesStyle.verticalOffset=TOOLS.parseInt(valuesStyle.verticalOffset,7),valuesStyle.verticalOffset>-3?valuesStyle.verticalOffset=7:valuesStyle.verticalOffset<-3&&(valuesStyle.verticalOffset=-13);var showValuesOnlyOnHighlight=""+(!valuesStyle1.show&&valuesStyle2.show);for(var commentsStyleTypeIndex=0;commentsStyleTypeIndex<channel.style.comments.styles.length;commentsStyleTypeIndex++){var theCommentsStyle=channel.style.comments.styles[commentsStyleTypeIndex];if(theCommentsStyle["type"]=="point"||theCommentsStyle["type"]=="square"||theCommentsStyle["type"]=="cross"||theCommentsStyle["type"]=="plus")commentsStyle=theCommentsStyle;typeof commentsStyle["show"]=="undefined"&&(commentsStyle.show=!0)}commentsStyle["type-ui"]=commentsStyle.type,commentsStyle.fill&&(commentsStyle["type"]=="point"||commentsStyle["type"]=="square")&&(commentsStyle["type-ui"]+="-filled"),$("#"+channelElementId+"-save-default-style > a").click(function(){$("#"+channelElementId+"-save-default-style").hide(),$("#"+channelElementId+"-save-default-style-status").html("Saving...").show(),saveDefaultChannelStyle(channel,plot.getStyle(),{success:function(){getSources(),$("#"+channelElementId+"-save-default-style-status").html("Default style saved.").delay(1e3).fadeOut(1e3,function(){$("#"+channelElementId+"-save-default-style").show()})},error:function(textStatus,errorThrown){console.log("saveDefaultChannelStyle(): Failed due to ["+textStatus+"].  Error thrown: "+errorThrown),$("#"+channelElementId+"-save-default-style-status").html("Failed to save default style.").delay(1e3).fadeOut(1e3,function(){$("#"+channelElementId+"-save-default-style").show()})}})}),$("#"+channelElementId+" ._timeline_btnShowAllY").click(function(){var plot=plotsMap[channelElementId];if(!plot||!plot.getStatistics)return!1;var xAxis=plot.getHorizontalAxis(),yAxis=plot.getVerticalAxis(),xMin=xAxis.getMin(),xMax=xAxis.getMax(),afterload=function(stats){if(stats.has_data){var yMin=stats.y_min,yMax=stats.y_max,yDiff=yMax-yMin;if(yDiff<1e-10)yAxis.setRange(yMin-.5,yMin+.5);else{var padding=.1*yDiff;yAxis.setRange(yMin-padding,yMax+padding)}plot.setStyle(plot.getStyle())}},initialStats=plot.getStatistics(xMin,xMax,["has_data","y_min","y_max"],afterload);return(!("data_pending"in initialStats)||!initialStats.data_pending)&&afterload(initialStats),!1}),$("#"+channelElementId+"-config-zeo-show").prop("checked",isZeo),$("#"+channelElementId+"-config-color-override-color").colorPicker(),$("#"+channelElementId+"-config-color-override-color").val("#000000"),$("#"+channelElementId+"-config-color-override-color").change(),$("#"+channelElementId+"-config-color-override-color").change(function(){var overrideColor=$("#"+channelElementId+"-config-color-override-color").next(".color_picker").css("background-color");$("#"+channelElementId+"-config-lines-color").val(overrideColor).change(),$("#"+channelElementId+"-config-points-color").val(overrideColor).change(),$("#"+channelElementId+"-config-points-fillColor").val(overrideColor).change(),$("#"+channelElementId+"-config-bars-color").val(overrideColor).change(),$("#"+channelElementId+"-config-values-fillColor").val(overrideColor).change(),$("#"+channelElementId+"-config-comments-color").val(overrideColor).change(),$("#"+channelElementId+"-config-comments-fillColor").val(overrideColor).change()}),$("#"+channelElementId+"-config-lines").toggle(!isZeo),$("#"+channelElementId+"-config-lines-show").prop("checked",linesStyle.show&&!isZeo),$("#"+channelElementId+"-config-lines-show").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-lines-lineWidth").val(TOOLS.parseInt(linesStyle.lineWidth,1)),$("#"+channelElementId+"-config-lines-lineWidth").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-lines-lineWidth").msDropDown(),$("#"+channelElementId+"-config-lines-color").colorPicker(),$("#"+channelElementId+"-config-lines-color").val(typeof linesStyle.color=="undefined"?defaultColor:linesStyle.color),$("#"+channelElementId+"-config-lines-color").change(),$("#"+channelElementId+"-config-lines-color").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-points").toggle(!isZeo),$("#"+channelElementId+"-config-points-show").prop("checked",pointsStyle.show&&!isZeo),$("#"+channelElementId+"-config-points-show").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-points-type").val(pointsStyle["type-ui"]),$("#"+channelElementId+"-config-points-type").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-points-type").change(function(){var isFilledType=$("#"+channelElementId+"-config-points-type").val().match(/-filled$/)!==null;$("#"+channelElementId+"-config-points-fillColor-container").toggle(isFilledType)}),$("#"+channelElementId+"-config-points-type").msDropDown(),$("#"+channelElementId+"-config-points-fillColor-container").toggle(pointsStyle.fill),$("#"+channelElementId+"-config-points-radius").val(TOOLS.parseInt(pointsStyle.radius,2)),$("#"+channelElementId+"-config-points-radius").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-points-radius").msDropDown(),$("#"+channelElementId+"-config-points-color").colorPicker(),$("#"+channelElementId+"-config-points-color").val(typeof pointsStyle.color=="undefined"?defaultColor:pointsStyle.color),$("#"+channelElementId+"-config-points-color").change(),$("#"+channelElementId+"-config-points-color").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-points-fillColor").colorPicker(),$("#"+channelElementId+"-config-points-fillColor").val(typeof pointsStyle.fillColor=="undefined"?defaultColor:pointsStyle.fillColor),$("#"+channelElementId+"-config-points-fillColor").change(),$("#"+channelElementId+"-config-points-fillColor").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-bars").toggle(!isZeo),$("#"+channelElementId+"-config-bars-show").prop("checked",barsStyle.show&&!isZeo),$("#"+channelElementId+"-config-bars-show").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-bars-lineWidth").val(TOOLS.parseInt(barsStyle.lineWidth,1)),$("#"+channelElementId+"-config-bars-lineWidth").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-bars-lineWidth").msDropDown(),$("#"+channelElementId+"-config-bars-color").colorPicker(),$("#"+channelElementId+"-config-bars-color").val(typeof barsStyle.color=="undefined"?defaultColor:barsStyle.color),$("#"+channelElementId+"-config-bars-color").change(),$("#"+channelElementId+"-config-bars-color").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-show").prop("checked",valuesStyle.show),$("#"+channelElementId+"-config-values-show").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-fillColor").colorPicker(),$("#"+channelElementId+"-config-values-fillColor").val(typeof valuesStyle.fillColor=="undefined"?defaultColor:valuesStyle.fillColor),$("#"+channelElementId+"-config-values-fillColor").change(),$("#"+channelElementId+"-config-values-fillColor").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-numberFormat").val(typeof valuesStyle.numberFormat=="undefined"?"###,##0.0##":valuesStyle.numberFormat),$("#"+channelElementId+"-config-values-numberFormat").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-numberFormat").msDropDown(),$("#"+channelElementId+"-config-values-verticalOffset").val(TOOLS.parseInt(valuesStyle.verticalOffset,7)),$("#"+channelElementId+"-config-values-verticalOffset").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-verticalOffset").msDropDown(),$("#"+channelElementId+"-config-values-showOnlyOnHighlight").val(showValuesOnlyOnHighlight),$("#"+channelElementId+"-config-values-showOnlyOnHighlight").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-showOnlyOnHighlight").change(function(){var shouldShowMarginMenu=$("#"+channelElementId+"-config-values-showOnlyOnHighlight").val()=="false";$("#"+channelElementId+"-config-values-marginWidth-label-container").toggle(shouldShowMarginMenu),$("#"+channelElementId+"-config-values-marginWidth-container").toggle(shouldShowMarginMenu)}),$("#"+channelElementId+"-config-values-showOnlyOnHighlight").msDropDown();var showValuesOnlyOnHighlightBoolean=showValuesOnlyOnHighlight=="true";$("#"+channelElementId+"-config-values-marginWidth-label-container").toggle(!showValuesOnlyOnHighlightBoolean),$("#"+channelElementId+"-config-values-marginWidth-container").toggle(!showValuesOnlyOnHighlightBoolean),$("#"+channelElementId+"-config-values-marginWidth").val(TOOLS.parseInt(valuesStyle.marginWidth,5)),$("#"+channelElementId+"-config-values-marginWidth").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-values-marginWidth").msDropDown(),$("#"+channelElementId+"-config-comments-show").prop("checked",commentsStyle.show),$("#"+channelElementId+"-config-comments-show").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-comments-type").val(commentsStyle["type-ui"]),$("#"+channelElementId+"-config-comments-type").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-comments-type").change(function(){var isFilledType=$("#"+channelElementId+"-config-comments-type").val().match(/-filled$/)!==null;$("#"+channelElementId+"-config-comments-fillColor-container").toggle(isFilledType)}),$("#"+channelElementId+"-config-comments-type").msDropDown(),$("#"+channelElementId+"-config-comments-fillColor-container").toggle(commentsStyle.fill),$("#"+channelElementId+"-config-comments-radius").val(TOOLS.parseInt(commentsStyle.radius,3)),$("#"+channelElementId+"-config-comments-radius").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-comments-radius").msDropDown(),$("#"+channelElementId+"-config-comments-color").colorPicker(),$("#"+channelElementId+"-config-comments-color").val(typeof commentsStyle.color=="undefined"?defaultColor:commentsStyle.color),$("#"+channelElementId+"-config-comments-color").change(),$("#"+channelElementId+"-config-comments-color").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-comments-fillColor").colorPicker(),$("#"+channelElementId+"-config-comments-fillColor").val(typeof commentsStyle.fillColor=="undefined"?defaultColor:commentsStyle.fillColor),$("#"+channelElementId+"-config-comments-fillColor").change(),$("#"+channelElementId+"-config-comments-fillColor").change(updateDataSeriesPlotChannelConfig),$("#"+channelElementId+"-config-comments-fillColor").change()}else if(plot instanceof PhotoSeriesPlot){var getUserSelectedTags=function(){var tags=[];return $.each($("#"+channelElementId+"-photo-tags-filter .tagedit-listelement-old input"),function(index,inputElement){var val=inputElement.value;typeof val=="string"&&val!=""&&(tags[tags.length]=val)}),tags},updatePhotoSeriesPlotChannelConfig=function(){var channelElement=$(this).parents("._timeline_channel").parent(),plot=plotsMap[channelElement.attr("id")],newStyle=plot.getStyle();typeof newStyle["filters"]=="undefined"&&(newStyle.filters={});var isAndJoin=$("#"+channelElementId+"-photo-tags-isAndJoin").val()==="true",userSelectedTags=getUserSelectedTags();newStyle.filters.tag={tags:userSelectedTags,isAndJoin:isAndJoin};if(userSelectedTags.length>0){var filterHtml=Hogan.compile($("#_timeline_channel_tab_filter_template").html()).render({value:userSelectedTags.join(", ")});$("#"+channelElementId+"-timeline-channel-filter").html(filterHtml).shorten()}else $("#"+channelElementId+"-timeline-channel-filter").text("").hide();plot.setStyle(newStyle),plot.setDatasource(photoDatasource(LOGIN.user_id,channel.device_name,newStyle.filters.tag.tags,newStyle.filters.tag.isAndJoin))};channel.style.hasOwnProperty("filters")||(channel.style.filters={}),channel.style.filters.hasOwnProperty("tag")||(channel.style.filters.tag={}),channel.style.filters.tag.hasOwnProperty("tags")||(channel.style.filters.tag.tags=[]),channel.style.filters.tag.hasOwnProperty("isAndJoin")||(channel.style.filters.tag.isAndJoin=!1);var tagFilter=channel.style.filters.tag;$("#"+channelElementId+"-photo-tags-isAndJoin").val(""+tagFilter.isAndJoin),$("#"+channelElementId+"-photo-tags-isAndJoin").change(updatePhotoSeriesPlotChannelConfig);if(tagFilter.tags.length>0)$.each(tagFilter.tags,function(index,value){var tagHtml=Hogan.compile($("#_timeline_photo_dialog_tags_editor_tag_template").html()).render({value:value});$("#"+channelElementId+"-photo-tags-filter").append(tagHtml)});else{var tagHtml=Hogan.compile($("#_timeline_photo_dialog_tags_editor_tag_template").html()).render({value:""});$("#"+channelElementId+"-photo-tags-filter").append(tagHtml)}var tagFilterOptions={autocompleteOptions:{minLength:0,delay:0,autoFocus:!1,source:function(request,response){var tagsToExclude=getUserSelectedTags(),cachedTagsData=TAG_MANAGER.getCachedTagsForTagEditor(tagsToExclude);return response($.ui.autocomplete.filter(cachedTagsData,request.term))}},breakKeyCodes:[13,44,32,59],additionalListClass:"_timeline_photo_tags_filter",animSpeed:100,allowAdd:!1,allowEdit:!1,allowDelete:!1,texts:{removeLinkTitle:"Remove this tag from the list",saveEditLinkTitle:"Save changes",breakEditLinkTitle:"Undo changes"}};$("#"+channelElementId+"-photo-tags-filter input.tag").tagedit(tagFilterOptions),$("#"+channelElementId+"-photo-tags-filter").bind("tagsChanged",updatePhotoSeriesPlotChannelConfig),$("#"+channelElementId+" ._timeline_photo_series_plot_config").show(),$("#"+channelElementId+"-photo-tags-isAndJoin").change()}return TOOLS.resizeHandler(),html}function updateViewData(){var i,l,channelIds,xAxis,yAxis,plot,channel,yAxes=[];channelIds=$("#_timeline_channels").sortable("toArray"),l=channelIds.length,l>0&&(plot=plotsMap[channelIds[0]],xAxis=plot.getHorizontalAxis(),VIEWS.data.v2.x_axis.min=xAxis.getMin(),VIEWS.data.v2.x_axis.max=xAxis.getMax());for(i=0;i<l;i++){plot=plotsMap[channelIds[i]],yAxis=plot.getVerticalAxis(),channel=channelsMap[channelIds[i]];if(plot instanceof DataSeriesPlot||plot instanceof PhotoSeriesPlot)channel.style=plot.getStyle(),channel.channel_height=$("#"+yAxis.getPlaceholder()).height();channel.min=yAxis.getMin(),channel.max=yAxis.getMax(),yAxes.push(channel)}VIEWS.data.v2.y_axes=yAxes,$("#_timeline_addChannelsArea").css("display")==="none"?VIEWS.data.v2.show_add_pane=!1:VIEWS.data.v2.show_add_pane=!0}function renderView(view,mode){console.log("renderView is being called");var yAxes,i,l,channel;mode=mode||"both";if(typeof view=="undefined"||view==null||!validateView(view)){alert("Invalid view: "+(view==null?null:view.name));return}if(mode==="time"){if(typeof dateAxis=="undefined"){alert("Existing view not found");return}$("#_timeline_save_view_btn").removeClass("disabled"),$("#_timeline_add_channels_btn").unbind("click").click(toggleAddChannelsPane).removeClass("button_disabled"),$("#_timeline_show_details_btn").unbind("click").click(toggleDetailsPane).removeClass("button_disabled"),dateAxis.setRange(view.v2.x_axis.min,view.v2.x_axis.max);return}channelsMap={},plotsMap={},plotContainersMap={},plotContainers=[],jQuery.fn.colorPicker.resetGetNextColor(),$("#_timeline_dateAxis").empty(),$("#_timeline_channels").empty(),$("#_timeline_dateAxisAndChannelsArea").show(),$("#_timeline_channelsArea").show(),$("#_timeline_viewName").html(view.name).shorten(),$("#_timeline_save_view_btn").removeClass("disabled"),$("#_timeline_add_channels_btn").unbind("click").click(toggleAddChannelsPane).removeClass("button_disabled"),$("#_timeline_show_details_btn").unbind("click").click(toggleDetailsPane).removeClass("button_disabled"),typeof view.v2.show_add_pane=="undefined"||view.v2.show_add_pane===!1?$("#_timeline_addChannelsArea").css("display")!=="none"&&toggleAddChannelsPane():$("#_timeline_addChannelsArea").css("display")==="none"&&toggleAddChannelsPane(),dateAxis=new DateAxis("_timeline_dateAxis","horizontal",{min:view.v2.x_axis.min,max:view.v2.x_axis.max});var prevDateString=null;dateAxis.addAxisChangeListener(function(){var center=(dateAxis.getMin()+dateAxis.getMax())/2,date=new Date(center*1e3),dateChangeBuffer=72e5,dateEarly=new Date(center*1e3-dateChangeBuffer),dateLater=new Date(center*1e3+dateChangeBuffer),dateString=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate(),dateStringEarly=dateEarly.getFullYear()+"-"+(dateEarly.getMonth()+1)+"-"+dateEarly.getDate(),dateStringLater=dateLater.getFullYear()+"-"+(dateLater.getMonth()+1)+"-"+dateLater.getDate();dateString!=prevDateString&&dateStringEarly!=prevDateString&&dateStringLater!=prevDateString&&(Calendar.dateChanged(dateString,"day"),prevDateString=dateString)}),yAxes=view.v2.y_axes,l=yAxes.length;for(i=0;i<l;i++)channel=getSourceChannelByName(yAxes[i].device_name,yAxes[i].channel_name),!!channel&&channel.hasOwnProperty("min_time")&&channel.hasOwnProperty("max_time")&&(yAxes[i].min_time=channel.min_time,yAxes[i].max_time=channel.max_time),addChannel(yAxes[i],null)}function validateView(view){var xAxes,yAxes,viewName,channels,deviceChannels,channelName,obj,styles,i,l;if(typeof view=="undefined"||view==null||typeof view.error!="undefined")return!1;if(typeof view["v2"]!="undefined"){if(typeof view.v2.x_axis!="object"||typeof view.v2.y_axes!="object")return!1;yAxes=view.v2.y_axes,l=yAxes.length;for(i=0;i<l;i++)yAxes[i].hasOwnProperty("style")&&(yAxes[i].style.hasOwnProperty("styles")||(console.log("Patching v2 view"),view.v2.y_axes[i].style.styles=yAxes[i].style["style-types"]));return!0}console.log("Upgrading view to v2"),xAxes=view.x_axes,yAxes=view.y_axes,viewName=view.name,channels=view.channels;if(typeof xAxes!="object"||typeof xAxes[0]!="object"||typeof yAxes!="object"||typeof yAxes[0]!="object"||typeof viewName!="string"||viewName.length===0||typeof channels!="object")return!1;view.v2={x_axis:{min:xAxes[0].min_time,max:xAxes[0].max_time},y_axes:[]};for(var deviceName in channels)if(channels.hasOwnProperty(deviceName)){deviceChannels=channels[deviceName];for(channelName in deviceChannels)deviceChannels.hasOwnProperty(channelName)&&(obj=channels[deviceName][channelName],index=obj.y_axis,channelName=="Sleep_Graph"?styles=[{type:"zeo"}]:styles=[{type:"line",color:obj.color,lineWidth:1}],view.v2.y_axes[index]={device_name:deviceName,channel_name:channelName,min:yAxes[index].min_val,max:yAxes[index].max_val,style:{styles:styles}})}return!0}function channelDatasource(userId,deviceName,channelName){var urlPrefix="/bodytrack/tiles/"+userId+"/"+deviceName+"."+channelName+"/";return __createDatasource(urlPrefix)}function photoDatasource(userId,deviceName,tags,allTags,nsfw){var urlPrefix="/bodytrack/photos/"+userId+"/",urlParams={};return deviceName!=null&&deviceName.toLowerCase()!="all"&&(urlParams.dev_nickname=deviceName),tags!=null&&tags.length>0&&(allTags?urlParams.all_tags=tags.join(","):urlParams.any_tags=tags.join(","),urlParams.tags_filter=tags.join(",")),!nsfw||(urlParams.nsfw="1"),__createDatasource(urlPrefix,urlParams)}function createPhotoDialogCache(channelFilterTags,isAndJoin){var cache={photos:[],photosById:{},isLoadingPreceding:!1,isLoadingFollowing:!1,NUM_PHOTOS_TO_FETCH:20,DISTANCE_FROM_END_TO_TRIGGER_FETCH:10,__loadNeighboringPhotoMetadata:function(currentPhotoId,currentPhotoTimestamp,tagsFilterArray,isAndJoin,shouldLoadPreviousNeighbor,callbacks){currentPhotoId=TOOLS.parseInt(currentPhotoId,-1);if(currentPhotoId>=0){typeof callbacks=="undefined"&&(callbacks={});var successCallback=callbacks.success,errorCallback=callbacks.error,completeCallback=callbacks.complete;shouldLoadPreviousNeighbor=!!shouldLoadPreviousNeighbor,isAndJoin=!!isAndJoin;var url="/bodytrack/users/"+LOGIN.user_id+"/log_items/get",urlParams={id:currentPhotoId,time:currentPhotoTimestamp,type:"photos",descending:shouldLoadPreviousNeighbor,exclusive:!1,count:cache.NUM_PHOTOS_TO_FETCH};isAndJoin?urlParams.all_tags=tagsFilterArray.join(","):urlParams.any_tags=tagsFilterArray.join(","),TOOLS.loadJson(url,urlParams,{success:function(photos){if($.isArray(photos)){if(typeof successCallback=="function"){var photosMetadata=[];$.each(photos,function(index,photo){photosMetadata[index]={photoId:photo.id,comment:photo.comment,tags:photo.tags,timestamp:photo.end_d,timestampString:photo.end}}),photos.length<cache.NUM_PHOTOS_TO_FETCH&&(console.log("PhotoDialogCache.__loadNeighboringPhotoMetadata(): Requested ["+cache.NUM_PHOTOS_TO_FETCH+"] photos, but only got ["+photos.length+"].  Marking the last photo as the end to prevent spurious fetches."),photosMetadata[photosMetadata.length-1].isEndingPhoto=!0),successCallback(photosMetadata)}}else typeof errorCallback=="function"&&errorCallback("loadNeighboringPhotoMetadata(): Returned data is not an array")},error:errorCallback,complete:completeCallback})}},__loadPreceding:function(photoId,timestamp,successCallback){cache.isLoadingPreceding?console.log("PhotoDialogCache.__loadPreceding(): doing nothing since we're already loading"):(cache.isLoadingPreceding=!0,cache.__loadNeighboringPhotoMetadata(photoId,timestamp,channelFilterTags,isAndJoin,!0,{success:successCallback,complete:function(){cache.isLoadingPreceding=!1}}))},__loadFollowing:function(photoId,timestamp,successCallback){cache.isLoadingFollowing?console.log("PhotoDialogCache.__loadFollowing(): doing nothing since we're already loading"):(cache.isLoadingFollowing=!0,cache.__loadNeighboringPhotoMetadata(photoId,timestamp,channelFilterTags,isAndJoin,!1,{success:successCallback,complete:function(){cache.isLoadingFollowing=!1}}))},initialize:function(photoId,timestamp,callback){cache.__loadPreceding(photoId,timestamp,function(precedingPhotosMetadata){cache.__loadFollowing(photoId,timestamp,function(followingPhotosMetadata){cache.photos=precedingPhotosMetadata.reverse().concat(followingPhotosMetadata.slice(1)),$.each(cache.photos,function(index,photo){cache.photosById[photo.photoId]=index}),typeof callback=="function"&&callback()})})},__getPhotoMetadata:function(photoId,offset){if(photoId in cache.photosById){var indexOfRequestedPhoto=cache.photosById[photoId]+offset;if(indexOfRequestedPhoto>=0&&indexOfRequestedPhoto<cache.photos.length)return cache.photos[indexOfRequestedPhoto]}return null},getPreviousPhotoMetadata:function(photoId){var photo=cache.__getPhotoMetadata(photoId,-1);if(photo!=null){var distance=cache.photosById[photoId];if(distance<cache.DISTANCE_FROM_END_TO_TRIGGER_FETCH){var endingPhoto=cache.photos[0];"isEndingPhoto"in endingPhoto?console.log("PhotoDialogCache.getPreviousPhotoMetadata(): No need to fetch more photos since we've already loaded up to the end ["+endingPhoto.photoId+"]"):(console.log("PhotoDialogCache.getPreviousPhotoMetadata(): Fetching more photos preceding id ["+endingPhoto.photoId+"]"),cache.__loadPreceding(endingPhoto.photoId,endingPhoto.timestamp,function(photosMetadata){console.log("PhotoDialogCache.getPreviousPhotoMetadata(): Fetched ["+photosMetadata.length+"] more previous photos.");if(endingPhoto["photoId"]==cache.photos[0]["photoId"]){var newPhotos=photosMetadata.slice(1).reverse().concat(cache.photos),newPhotosById={};$.each(newPhotos,function(index,photo){newPhotosById[photo.photoId]=index}),cache.photos=newPhotos,cache.photosById=newPhotosById}else console.log("PhotoDialogCache.getPreviousPhotoMetadata(): cache has changed, won't update")}))}}return photo},getNextPhotoMetadata:function(photoId){var photo=cache.__getPhotoMetadata(photoId,1);if(photo!=null){var distance=cache.photos.length-1-cache.photosById[photoId];if(distance<cache.DISTANCE_FROM_END_TO_TRIGGER_FETCH){var endingPhoto=cache.photos[cache.photos.length-1];"isEndingPhoto"in endingPhoto?console.log("PhotoDialogCache.getNextPhotoMetadata(): No need to fetch more photos since we've already loaded up to the end ["+endingPhoto.photoId+"]"):(console.log("PhotoDialogCache.getNextPhotoMetadata(): Fetching more photos following id ["+endingPhoto.photoId+"]"),cache.__loadFollowing(endingPhoto.photoId,endingPhoto.timestamp,function(photosMetadata){console.log("PhotoDialogCache.getNextPhotoMetadata(): Fetched ["+photosMetadata.length+"] more following photos.");if(endingPhoto["photoId"]==cache.photos[cache.photos.length-1]["photoId"]){var newPhotos=cache.photos.concat(photosMetadata.slice(1)),newPhotosById={};$.each(newPhotos,function(index,photo){newPhotosById[photo.photoId]=index}),cache.photos=newPhotos,cache.photosById=newPhotosById}else console.log("PhotoDialogCache.getNextPhotoMetadata(): cache has changed, won't update")}))}}return photo},getPhotoMetadata:function(photoId){return cache.__getPhotoMetadata(photoId,0)},update:function(photoId,newData){if(photoId in cache.photosById){var index=cache.photosById[photoId];cache.photos[index]={photoId:newData.id,comment:newData.comment,tags:newData.tags,timestamp:newData.end_d,timestampString:newData.end}}}};return cache}function dataPointListener(pointObj,sourceInfo){pointObj?$("#_timeline_dataPointValueLabel").html(Hogan.compile($("#_timeline_data_point_value_label_template").html()).render(pointObj)):$("#_timeline_dataPointValueLabel").html("")}function loadLogrecMetadata(logrecId,callbacks){logrecId=TOOLS.parseInt(logrecId,-1);if(logrecId>=0){var url="/bodytrack/users/"+LOGIN.user_id+"/logrecs/"+logrecId+"/get";TOOLS.loadJson(url,{},callbacks)}}function photoDataPointListener(channelElementId){return function(pointObj,sourceInfo){if(pointObj&&sourceInfo&&sourceInfo.info){var getUserSelectedTags=function(){var tags=[];return $.each($("#_timeline_photo_dialog_tags_editor .tagedit-listelement-old input"),function(index,inputElement){var val=inputElement.value;typeof val=="string"&&val!=""&&(tags[tags.length]=val)}),tags},getTagFilterForChannel=function(){var tags=[];return $.each($("#"+channelElementId+"-photo-tags-filter .tagedit-listelement-old input"),function(index,inputElement){var val=inputElement.value;typeof val=="string"&&val!=""&&(tags[tags.length]=val)}),tags},isAndJoin=$("#"+channelElementId+"-photo-tags-isAndJoin").val()==="true",channelFilterTags=getTagFilterForChannel(),photoCache=createPhotoDialogCache(channelFilterTags,isAndJoin),createPhotoDialog=function(photoId,timestamp,completionCallback){var mediumResImageUrl=Hogan.compile($("#_timeline_photo_dialog_medium_res_image_url_template").html()).render({photoId:photoId,userId:LOGIN.user_id}),highResImageUrl=Hogan.compile($("#_timeline_photo_dialog_high_res_image_url_template").html()).render({photoId:photoId,userId:LOGIN.user_id});$("#_timeline_photo_dialog").html(Hogan.compile($("#_timeline_photo_dialog_template").html()).render({photoUrl:mediumResImageUrl}));var updateGoToNeighborOnSaveWidgets=function(){var isEnabled=$("#_timeline_photo_dialog_save_should_goto_neighbor").is(":checked"),direction=TOOLS.parseInt($("#_timeline_photo_dialog_save_should_goto_neighbor_choice").val(),0);PREFS.set("photo_dialog.goto_neighbor_on_save.enabled",isEnabled),PREFS.set("photo_dialog.goto_neighbor_on_save.direction",direction),isEnabled?($("#_timeline_photo_dialog_save_should_goto_neighbor_choice").removeAttr("disabled"),$("#_timeline_photo_dialog_save_preferences label").css("color","#000000"),direction<0?$("#_timeline_photo_dialog_save_button").html("Save &amp; Previous"):$("#_timeline_photo_dialog_save_button").html("Save &amp; Next")):($("#_timeline_photo_dialog_save_should_goto_neighbor_choice").attr("disabled","disabled"),$("#_timeline_photo_dialog_save_preferences label").css("color","#aaaaaa"),$("#_timeline_photo_dialog_save_button").text("Save"))},goToNeighborOnSaveEnabled=!!PREFS.get("photo_dialog.goto_neighbor_on_save.enabled",!1),goToNeighborOnSaveDirection=TOOLS.parseInt(PREFS.get("photo_dialog.goto_neighbor_on_save.direction",0),0);$("#_timeline_photo_dialog_save_should_goto_neighbor").prop("checked",goToNeighborOnSaveEnabled),$("#_timeline_photo_dialog_save_should_goto_neighbor").change(updateGoToNeighborOnSaveWidgets),$("#_timeline_photo_dialog_save_should_goto_neighbor_choice").val(goToNeighborOnSaveDirection==0?1:goToNeighborOnSaveDirection),$("#_timeline_photo_dialog_save_should_goto_neighbor_choice").change(updateGoToNeighborOnSaveWidgets),$("#_timeline_photo_dialog_form_status").text("Loading...").show(),$("#_timeline_photo_dialog_previous_button").hide(),$("#_timeline_photo_dialog_next_button").hide();var previousPhotoMetadata=photoCache.getPreviousPhotoMetadata(photoId),nextPhotoMetadata=photoCache.getNextPhotoMetadata(photoId),data=photoCache.getPhotoMetadata(photoId),isPreviousPhoto=previousPhotoMetadata!=null&&typeof previousPhotoMetadata!="undefined"&&typeof previousPhotoMetadata.photoId!="undefined";isPreviousPhoto&&$("#_timeline_photo_dialog_previous_button").show().click(function(){createPhotoDialog(previousPhotoMetadata.photoId,previousPhotoMetadata.timestamp)});var isNextPhoto=nextPhotoMetadata!=null&&typeof nextPhotoMetadata!="undefined"&&typeof nextPhotoMetadata.photoId!="undefined";isNextPhoto&&$("#_timeline_photo_dialog_next_button").show().click(function(){createPhotoDialog(nextPhotoMetadata.photoId,nextPhotoMetadata.timestamp)}),typeof data=="string"&&(data=JSON.parse(data));if(typeof data.comment=="undefined"||data["comment"]==null)data.comment="";if(typeof data.tags=="undefined"||data["tags"]==null)data.tags=[];$("#_timeline_photo_dialog_image").click(function(){var theImage=$(this),imageAspectRatio=$(this).width()/$(this).height(),formContainer=$("#_timeline_photo_dialog_form_container");$("#_timeline_photo_dialog_form_container").is(":visible")?formContainer.fadeOut(100,function(){var imageHeight=$("body").height()-60,imageWidth=imageAspectRatio*imageHeight;imageWidth>$("body").width()&&(imageWidth=$("body").width()-100,imageHeight=imageWidth/imageAspectRatio),theImage.attr("src",highResImageUrl).height(imageHeight).width(imageWidth),$("#_timeline_photo_dialog_photo_table").height(imageHeight).width(imageWidth),centerPhotoDialog()}):formContainer.fadeIn(100,function(){var imageHeight=300,imageWidth=imageAspectRatio*imageHeight;theImage.height(imageHeight).width(imageWidth),$("#_timeline_photo_dialog_photo_table").height(imageHeight).width(imageWidth),centerPhotoDialog(),theImage.attr("src",mediumResImageUrl)})});var createCommentAndTagForm=function(comment,tags){var isDirty=function(){if($("#_timeline_photo_dialog_comment").val()!=comment)return!0;var newTags=getUserSelectedTags();if(newTags.length!=tags.length)return!0;for(var i=0;i<newTags.length;i++)if(newTags[i]!=tags[i])return!0;return!1},setEnabledStateOfRevertAndSaveButtons=function(){isDirty()?$("#_timeline_photo_dialog_revert_button").removeAttr("disabled"):$("#_timeline_photo_dialog_revert_button").attr("disabled","disabled")},photoMetadataForm=Hogan.compile($("#_timeline_photo_dialog_form_template").html()).render({});$("#_timeline_photo_dialog_form").html(photoMetadataForm),typeof data["timestampString"]=="undefined"?$("#_timeline_photo_dialog_timestamp").html("&nbsp;"):$("#_timeline_photo_dialog_timestamp").text((new Date(data.timestampString)).toString()),typeof comment=="undefined"||comment==null?$("#_timeline_photo_dialog_comment").val(""):$("#_timeline_photo_dialog_comment").val(comment),$("#_timeline_photo_dialog_comment").focus(function(){$("#_timeline_photo_dialog").dialog("option","closeOnEscape",!1)}),$("#_timeline_photo_dialog_comment").blur(function(){$("#_timeline_photo_dialog").dialog("option","closeOnEscape",!0)}),$("#_timeline_photo_dialog_comment").keyup(setEnabledStateOfRevertAndSaveButtons);if($.isArray(tags)&&tags.length>0)$.each(tags,function(index,value){var tagHtml=Hogan.compile($("#_timeline_photo_dialog_tags_editor_tag_template").html()).render({value:value});$("#_timeline_photo_dialog_tags_editor").append(tagHtml)});else{var tagHtml=Hogan.compile($("#_timeline_photo_dialog_tags_editor_tag_template").html()).render({value:""});$("#_timeline_photo_dialog_tags_editor").append(tagHtml)}var tagEditorOptions={autocompleteOptions:{minLength:0,delay:0,autoFocus:!1,source:function(request,response){var tagsToExclude=getUserSelectedTags(),cachedTagsData=TAG_MANAGER.getCachedTagsForTagEditor(tagsToExclude);return response($.ui.autocomplete.filter(cachedTagsData,request.term))}},breakKeyCodes:[13,44,32,59],additionalListClass:"_timeline_photo_tags_input",animSpeed:100,allowAdd:!0,allowEdit:!0,allowDelete:!1,texts:{removeLinkTitle:"Remove this tag from the list",saveEditLinkTitle:"Save changes",breakEditLinkTitle:"Undo changes"}};$("#_timeline_photo_dialog_tags_editor input.tag").tagedit(tagEditorOptions),$("#_timeline_photo_dialog_tags_editor").bind("tagsChanged",setEnabledStateOfRevertAndSaveButtons),$("#_timeline_photo_dialog_tags_editor").bind("receivedFocus",function(){$("#_timeline_photo_dialog").dialog("option","closeOnEscape",!1)}),$("#_timeline_photo_dialog_tags_editor").bind("tabToNextElement",function(event){return $("#_timeline_photo_dialog").dialog("option","closeOnEscape",!0),$("#_timeline_photo_dialog_tags_editor_tabhelper_post_proxy_forward").focus(),!1}),$("#_timeline_photo_dialog_tags_editor").bind("tabToPreviousElement",function(event){return $("#_timeline_photo_dialog").dialog("option","closeOnEscape",!0),$("#_timeline_photo_dialog_comment").select().focus(),!1}),$("#_timeline_photo_dialog_revert_button").attr("disabled","disabled"),$("#_timeline_photo_dialog_revert_button").click(function(){$("#_timeline_photo_dialog_form").hide(),$("#_timeline_photo_dialog_form_status").text("Loading...").show(),createCommentAndTagForm(comment,tags),$("#_timeline_photo_dialog_form_status").hide(),$("#_timeline_photo_dialog_form").show(),$("#_timeline_photo_dialog_comment").select().focus()}),$("#_timeline_photo_dialog_save_button").click(function(){$("#_timeline_photo_dialog_revert_button").attr("disabled","disabled"),$("#_timeline_photo_dialog_form").hide(),$("#_timeline_photo_dialog_form_status").text("Saving...").show(),$.ajax({cache:!1,type:"POST",url:"/bodytrack/users/"+LOGIN.user_id+"/logrecs/"+photoId+"/set",data:{tags:getUserSelectedTags().join(","),comment:$("#_timeline_photo_dialog_comment").val()},dataType:"json",success:function(savedData,textStatus,jqXHR){typeof savedData=="object"?(console.log("Successfully saved comment and tags for photo ["+photoId+"]"),console.log(savedData),photoCache.update(photoId,savedData),TAG_MANAGER.refreshTagCache(function(){$("#_timeline_photo_dialog_form_status").text("Saved.").delay(250).fadeOut(500,function(){goToNeighborOnSaveEnabled=!!PREFS.get("photo_dialog.goto_neighbor_on_save.enabled",!1),goToNeighborOnSaveDirection=TOOLS.parseInt(PREFS.get("photo_dialog.goto_neighbor_on_save.direction",0),0),goToNeighborOnSaveEnabled&&isPreviousPhoto&&goToNeighborOnSaveDirection<0?$("#_timeline_photo_dialog_previous_button").click():goToNeighborOnSaveEnabled&&isNextPhoto&&goToNeighborOnSaveDirection>0?$("#_timeline_photo_dialog_next_button").click():(createCommentAndTagForm(savedData.comment,savedData.tags),$("#_timeline_photo_dialog_form").show(),$("#_timeline_photo_dialog_comment").select().focus())})})):(console.log("Unexpected response when saving comment and tags for photo ["+photoId+"]:  savedData=["+savedData+"] textStatus=["+textStatus+"]"),$("#_timeline_photo_dialog_form_status").text("Saved failed.").show())},error:function(jqXHR,textStatus,errorThrown){console.log("Failed to save comment and tags for photo ["+photoId+"]:  textStatus=["+textStatus+"] errorThrown=["+errorThrown+"]"),$("#_timeline_photo_dialog_form_status").text("Saved failed.").show()}})}),updateGoToNeighborOnSaveWidgets(),$("#_timeline_photo_dialog_form #tagedit-input").attr("tabindex",102),$("#_timeline_photo_dialog_tabhelper_pre_proxy_backward").focus(function(){return $("#_timeline_photo_dialog_save_should_goto_neighbor_choice").is(":enabled")?$("#_timeline_photo_dialog_save_should_goto_neighbor_choice").focus():$("#_timeline_photo_dialog_save_should_goto_neighbor").focus(),!1}),$("#_timeline_photo_dialog_previous_button").focus(function(){$(this).css("background-position","0 -38px")}).blur(function(){$(this).css("background-position","0 0")}),$("#_timeline_photo_dialog_next_button").focus(function(){$(this).css("background-position","0 -38px")}).blur(function(){$(this).css("background-position","0 0")}),$("#_timeline_photo_dialog_comment_tabhelper_pre_proxy_forward").focus(function(){return $("#_timeline_photo_dialog_comment").focus().select(),!1}),$("#_timeline_photo_dialog_comment_tabhelper_pre_proxy_backward").focus(function(){return isNextPhoto?$("#_timeline_photo_dialog_next_button").focus():isPreviousPhoto?$("#_timeline_photo_dialog_previous_button").focus():$("#_timeline_photo_dialog_tabhelper_pre_proxy_backward").focus(),!1}),$("#_timeline_photo_dialog_comment").focus(function(){return!1}),$("#_timeline_photo_dialog_tags_editor_tabhelper_pre_proxy_forward").focus(function(){$("#_timeline_photo_dialog_tags_editor ul").click()}),$("#_timeline_photo_dialog_tags_editor_tabhelper_post_proxy_forward").focus(function(){return $("#_timeline_photo_dialog_save_button").is(":disabled")?$("#_timeline_photo_dialog_save_should_goto_neighbor").focus():$("#_timeline_photo_dialog_save_button").focus(),!1}),$("#_timeline_photo_dialog_tags_editor_tabhelper_post_proxy_backward").focus(function(){$("#_timeline_photo_dialog_tags_editor ul").click()}),$("#_timeline_photo_dialog_revert_button").focus(function(){$(this).css("color","#18B054")}).blur(function(){$(this).css("color","#000000")}),$("#_timeline_photo_dialog_save_button").focus(function(event){$(this).css("color","#18B054")}).blur(function(event){$(this).css("color","#000000")}),$("#_timeline_photo_dialog_post_proxy_forward").focus(function(){return isPreviousPhoto?$("#_timeline_photo_dialog_previous_button").focus():isNextPhoto?$("#_timeline_photo_dialog_next_button").focus():$("#_timeline_photo_dialog_comment").focus().select(),!1}),$("#_timeline_photo_dialog_comment").select().focus()};createCommentAndTagForm(data.comment,data.tags),$("#_timeline_photo_dialog_form_status").hide(),$("#_timeline_photo_dialog_form").show(),typeof completionCallback=="function"&&completionCallback()};photoCache.initialize(sourceInfo.info.imageId,pointObj.date,function(){createPhotoDialog(sourceInfo.info.imageId,pointObj.date,function(){centerPhotoDialog()})}),$("#_timeline_photo_dialog").html(Hogan.compile($("#_timeline_photo_dialog_loading_template").html()).render({})),$("#_timeline_photo_dialog").dialog("open")}}}function centerPhotoDialog(){$("#_timeline_photo_dialog").dialog("option","position","center")}function saveDefaultChannelStyle(channel,defaultStyleObj,callbacks){if(typeof channel=="object"&&typeof defaultStyleObj=="object"&&typeof channel.device_name=="string"&&typeof channel.channel_name=="string"){typeof callbacks=="undefined"&&(callbacks={});var successCallback=callbacks.success,errorCallback=callbacks.error,completeCallback=callbacks.complete,url="/bodytrack/users/"+LOGIN.user_id+"/channels/"+encodeURIComponent(channel.device_name)+"."+encodeURIComponent(channel.channel_name)+"/set";$.ajax({cache:!1,type:"POST",url:url,data:{user_default_style:JSON.stringify(defaultStyleObj)},success:function(data,textStatus,jqXHR){try{typeof successCallback=="function"&&successCallback(data)}catch(ex){console.log("saveDefaultChannelStyle.success: JSON parse error, or failure in the successCallback: "+ex)}},error:function(jqXHR,textStatus,errorThrown){try{typeof errorCallback=="function"&&errorCallback(textStatus,errorThrown)}catch(ex){console.log("saveDefaultChannelStyle.error: Failure in the errorCallback: "+ex)}},complete:function(jqXHR,textStatus){try{typeof completeCallback=="function"&&completeCallback(textStatus)}catch(ex){console.log("saveDefaultChannelStyle.complete: Failure in the completeCallback: "+ex)}}})}}function dragAreaOnMouseDown(plotId){var channelElementId="_timeline_channel_"+plotId,plotElementId="_timeline_plot_"+plotId,yAxisElementId="_timeline_yAxis_"+plotId,mostRecentY=null,resizeTimer=null,dylist=[],resizePlot=function(dy){var container=plotContainersMap[channelElementId],cPlaceholder=$("#"+container.getPlaceholder()),containerW=cPlaceholder.width(),containerH=cPlaceholder.height(),plot=plotsMap[channelElementId],yAxis=plot.getVerticalAxis(),yAixsW=$("#"+yAxis.getPlaceholder()).width(),dragAreaH=$("._timeline_dragArea").height()-CHANNEL_PADDING;if(dy>0||Math.abs(dy)<containerH)containerH+dy+dragAreaH<67&&(dy=67-containerH-dragAreaH),$("#"+plotElementId).height(containerH+dy),container.setSize(containerW,containerH+dy,SequenceNumber.getNext()),$("#"+yAxisElementId).height(containerH+dy),yAxis.setSize(yAixsW,containerH+dy,SequenceNumber.getNext()),$("#_timeline_channelTab_"+plotId).height(containerH+dy+CHANNEL_PADDING),!!VIEWS.data&&!!VIEWS.data.v2&&!!VIEWS.data.v2.y_axes&&VIEWS.data.v2.y_axes.length>plotId&&(VIEWS.data.v2.y_axes[plotId].channel_height=containerH+dy);return mostRecentY+=dy,!1},mouseup=null,mousemove=null,updatePlotSize=function(){dylist.length>0&&(resizePlot(dylist[dylist.length-1]),dylist=[])},stopListening=function(){return $(window).unbind({mousemove:mousemove,mouseup:mouseup}),clearInterval(resizeTimer),!1};return mousemove=function(event){return mostRecentY==null?mostRecentY=event.pageY:dylist.push(event.pageY-mostRecentY),!1},mouseup=function(event){return mostRecentY==null?stopListening():(stopListening(),resizePlot(event.pageY-mostRecentY),!1)},$(window).bind({mousemove:mousemove,mouseup:mouseup}),resizeTimer=setInterval(updatePlotSize,100),!1}function gotoTime(action){var xAxis=dateAxis;if(!xAxis)return console.log("Missing date axis: cannot goto another time"),!1;var xMin=xAxis.getMin(),xMax=xAxis.getMax(),xWidth=xMax-xMin;if(action=="beginning"){var minTime=Number.MAX_VALUE;for(var channelKey in channelsMap){var channel=channelsMap[channelKey];!!channel&&channel.hasOwnProperty("min_time")&&(minTime=Math.min(minTime,channel.min_time))}minTime<.99*Number.MAX_VALUE&&xAxis.setRange(minTime,minTime+xWidth)}else if(action=="back")xAxis.setRange(xMin-xWidth,xMin);else if(action=="forward")xAxis.setRange(xMax,xMax+xWidth);else{if(action!="end")return!1;var maxTime=-Number.MAX_VALUE;for(channelKey in channelsMap)channel=channelsMap[channelKey],!!channel&&channel.hasOwnProperty("max_time")&&(maxTime=Math.max(maxTime,channel.max_time));maxTime>-0.99*Number.MAX_VALUE&&xAxis.setRange(maxTime-xWidth,maxTime)}return repaintAllPlots(),!1}function zoomTime(action){var xAxis=dateAxis;if(!xAxis)return console.log("Missing date axis: cannot goto another time"),!1;var xMin=xAxis.getMin(),xMax=xAxis.getMax(),xWidth=xMax-xMin,newXWidth=xWidth;if(action=="out")newXWidth=xWidth*1.4;else{if(action!="in")return!1;newXWidth=xWidth/1.4}var dEndpoint=(newXWidth-xWidth)/2;return xAxis.setRange(xMin-dEndpoint,xMax+dEndpoint),repaintAllPlots(),!1}function setRange(start,end){dateAxis?dateAxis.setRange(start,end):console.log("we don't have a dateAxis yet"),repaintAllPlots()}function repaintAllPlots(){for(var plotKey in plotsMap){var plot=plotsMap[plotKey];plot&&plot.setStyle(plot.getStyle())}}function render(digest,timeUnit){$("#filtersContainer").show(),this.getTemplate("text!applications/calendar/tabs/timeline/template.html","timeline",function(){setup(digest,timeUnit)}),timelineTab.setRange(Calendar.start/1e3,Calendar.end/1e3)}function setup(digest,timeUnit){$(window).resize(function(){clearTimeout(BodyTrack.TOOLS.resizeTimer),BodyTrack.TOOLS.resizeTimer=setTimeout(BodyTrack.TOOLS.resizeHandler,100)}),timelineTab.initialized||APP.init(function(){timelineTab.init(function(){timelineTab.newView(Calendar.start/1e3,Calendar.end/1e3),timelineTab.initialized=!0})})}var APP=BodyTrack.APP,PREFS=BodyTrack.PREFS,TOOLS=BodyTrack.TOOLS,LOGIN=BodyTrack.LOGIN,TAG_MANAGER=BodyTrack.TAG_MANAGER,VIEWS=BodyTrack.VIEWS,SOURCES=BodyTrack.SOURCES,newViewName="Untitled View",channelIdx=0,dragSourceId=null,dateAxis=null,sourcesMap={},channelsMap={},plotsMap={},plotContainersMap={},plotContainers=[],hasUnsavedChanges=!1,loadedViewStr="",addPaneChannelsState=[],CHANNEL_PADDING=3,timelineTab=new Tab("timeline","Candide Kemmler","icon-film",!1);return timelineTab.initialized=!1,timelineTab.render=render,timelineTab.init=init,timelineTab.newView=newView,timelineTab.setRange=setRange,timelineTab}),require(["App","Connectors"],function(App,Connectors){document.body.onselectstart=function(){return!1},document.body.style.MozUserSelect="none",document.body.style.KhtmlUserSelect="none",document.body.unselectable="on",App.initialize()}),require(["text!connectorMgmtTemplates.html","text!addressesTemplate.html","text!applications/calendar/facetTemplates.html","text!applications/calendar/tabs/clock/clockTemplate.html","text!applications/calendar/tabs/photos/photosTemplate.html","text!applications/calendar/tabs/timeline/timelineTemplates.html"]),require(["applications/calendar/App"]),require(["applications/calendar/tabs/clock/ClockTab","applications/calendar/tabs/dashboard/DashboardTab","applications/calendar/tabs/dashboards/DashboardsTab","applications/calendar/tabs/diary/DiaryTab","applications/calendar/tabs/list/ListTab","applications/calendar/tabs/map/MapTab","applications/calendar/tabs/photos/PhotosTab","applications/calendar/tabs/timeline/TimelineTab"]),define("main",function(){})